<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>TeReto</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;500;600;700&display=swap" rel="stylesheet">
  <style>
    body { font-family: 'Poppins', sans-serif; }
    .toast { visibility:hidden; opacity:0; transform:translateY(100%); transition:all .5s cubic-bezier(.68,-.55,.27,1.55); pointer-events:none;}
    .toast.show { visibility:visible; opacity:1; transform:translateY(0); }
    .spinner { border:4px solid rgba(0,0,0,.1); width:36px; height:36px; border-radius:50%; border-left-color:#6366f1; animation:spin 1s ease infinite;}
    @keyframes spin { 0%{transform:rotate(0);} 100%{transform:rotate(360deg);} }
    .btn-primary { background-image:linear-gradient(to right,#6366f1,#8b5cf6); color:#fff; border-radius:.625rem; padding:.5rem .875rem; font-weight:700; }
    .btn-primary:hover { box-shadow:0 4px 15px rgba(99,102,241,.6); }
    .grid-mosaic { display:grid; grid-template-columns:repeat(3,1fr); gap:.5rem; }
    .mosaic-item { position:relative; aspect-ratio:1/1; }
    .mosaic-img { width:100%; height:100%; object-fit:cover; border-radius:.5rem; }
    .mosaic-del { position:absolute; top:.25rem; right:.25rem; background:rgba(0,0,0,.6); color:#fff; border-radius:.5rem; padding:.15rem .4rem; font-size:.8rem; }
    .badge { font-size:.7rem; padding:.1rem .35rem; border-radius:.35rem; }
    .locked { filter: blur(22px); }
    .tab-btn.active { border-bottom:2px solid #6366f1; color:#6366f1; font-weight:600; }
    #login-screen { position:relative; z-index:10; }
    #loading-spinner.hidden { display:none !important; }
  </style>
</head>
<body class="bg-slate-100 h-screen">

  <!-- SPINNER -->
  <div id="loading-spinner" class="hidden fixed inset-0 bg-slate-100/80 flex items-center justify-center z-[100]">
    <div class="spinner"></div>
  </div>

  <!-- TOAST -->
  <div id="toast" class="toast fixed bottom-24 left-1/2 -translate-x-1/2 flex items-center w-full max-w-xs p-4 text-slate-600 bg-white rounded-xl shadow-2xl z-[90]">
    <div id="toast-icon" class="inline-flex items-center justify-center flex-shrink-0 w-8 h-8 rounded-lg"></div>
    <div id="toast-message" class="ml-3 text-sm font-normal"></div>
  </div>

  <!-- LOGIN -->
  <div id="login-screen" class="min-h-screen flex items-center justify-center p-4">
    <div class="w-full max-w-sm bg-white rounded-2xl shadow-2xl p-6">
      <div class="flex items-center justify-center mb-4">
        <svg class="w-10 h-10" viewBox="0 0 32 32" fill="none"><defs><linearGradient id="lg1" x1="0" y1="0" x2="32" y2="32"><stop stop-color="#818CF8"/><stop offset="1" stop-color="#C084FC"/></linearGradient></defs><circle cx="16" cy="16" r="12" stroke="url(#lg1)" stroke-width="3"/><circle cx="16" cy="16" r="4" stroke="url(#lg1)" stroke-width="3"/></svg>
        <svg class="h-8 ml-2" viewBox="0 0 90 25" fill="none"><defs><linearGradient id="lg2" x1="0%" y1="0%" x2="100%" y2="0%"><stop offset="0%" stop-color="#6366f1"/><stop offset="100%" stop-color="#8b5cf6"/></linearGradient></defs><text x="0" y="20" font-size="24" font-weight="700" fill="url(#lg2)">TeReto</text></svg>
      </div>
      <p class="text-center text-slate-600 mb-6">Ingres√° para continuar</p>

      <!-- sin onclick inline -->
      <button id="google-btn" type="button" class="relative z-10 pointer-events-auto w-full flex items-center justify-center gap-3 border rounded-xl py-3 hover:bg-slate-50 select-none">
        <img alt="Google" src="https://www.gstatic.com/firebasejs/ui/2.0.0/images/auth/google.svg" class="w-5 h-5" draggable="false">
        <span class="font-semibold text-slate-700">Continuar con Google</span>
      </button>

      <p class="text-[11px] text-center text-slate-400 mt-4">Serv√≠ esto en <code>http://localhost</code> o un dominio autorizado (Firebase ‚Ä∫ Authentication ‚Ä∫ Authorized domains).</p>
    </div>
  </div>

  <!-- APP -->
  <div id="app-screen" class="h-full flex flex-col hidden">
    <main class="flex-grow overflow-y-auto pb-20 bg-slate-100">
      <!-- Tus vistas completas (feed/create/friends/profile) pueden quedarse tal cual aqu√≠ -->
      <div id="feed-view"></div>
      <div id="create-view" class="hidden"></div>
      <div id="friends-view" class="hidden"></div>
      <div id="profile-view" class="hidden"></div>
    </main>

    <nav class="fixed bottom-0 left-0 right-0 bg-white/95 backdrop-blur-sm border-t border-slate-200 flex justify-around p-1 z-40">
      <button data-view="feed-view" class="nav-button flex-1 p-2 rounded-lg text-indigo-500 flex flex-col items-center space-y-1">üè†<span class="text-xs font-semibold">Inicio</span></button>
      <button data-view="friends-view" class="nav-button flex-1 p-2 rounded-lg text-slate-500 flex flex-col items-center space-y-1">üë•<span class="text-xs font-semibold">Amigos</span></button>
      <button data-view="create-view" class="nav-button flex-1 p-2 rounded-lg text-slate-500 flex flex-col items-center space-y-1">‚ûï<span class="text-xs font-semibold">Crear</span></button>
      <button data-view="profile-view" class="nav-button flex-1 p-2 rounded-lg text-slate-500 flex flex-col items-center space-y-1">üë§<span class="text-xs font-semibold">Perfil</span></button>
    </nav>
  </div>

  <!-- APP LOGIC -->
  <script type="module">
    // Guard para evitar doble boot
    if (window.__TERETO_BOOTED__) {
      console.warn("TeReto ya inicializado.");
    } else {
      window.__TERETO_BOOTED__ = true;

      // === Dynamic imports (v√°lido en cualquier bloque) ===
      (async () => {
        const appMod = await import("https://www.gstatic.com/firebasejs/11.0.1/firebase-app.js");
        const authMod = await import("https://www.gstatic.com/firebasejs/11.0.1/firebase-auth.js");
        const fsMod  = await import("https://www.gstatic.com/firebasejs/11.0.1/firebase-firestore.js");

        const { initializeApp } = appMod;
        const {
          getAuth, GoogleAuthProvider, signInWithPopup, signInWithRedirect,
          getRedirectResult, onAuthStateChanged, signOut
        } = authMod;
        const {
          getFirestore, setDoc, doc, serverTimestamp
        } = fsMod;

        // Utils
        const $ = (id)=>document.getElementById(id);
        const toast = (msg,type='success')=>{
          const t=$("toast"); if(!t) return console.log(msg);
          $("toast-message").textContent=msg;
          $("toast-icon").innerHTML= type==='success'?'‚úÖ':'‚ùå';
          t.classList.add('show'); setTimeout(()=>t.classList.remove('show'),2600);
        };
        window.toast = toast;

        // Firebase
        const firebaseConfig = {
          apiKey: "AIzaSyCSdjAdY7ymmOwIN7zApP-XpXxTar_0pHk",
          authDomain: "tereto-prod.firebaseapp.com",
          projectId: "tereto-prod",
          storageBucket: "tereto-prod.firebasestorage.app",
          messagingSenderId: "914605096619",
          appId: "1:914605096619:web:88a9b78eac50c35cb181ee"
        };
        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db   = getFirestore(app);

        // Auth
        const provider = new GoogleAuthProvider();
        provider.setCustomParameters({ prompt: "select_account" });

        function startGoogle(){
          // No awaits antes del popup
          signInWithPopup(auth, provider).catch((e)=>{
            if (e?.code === "auth/popup-blocked" || e?.code === "auth/cancelled-popup-request") {
              signInWithRedirect(auth, provider);
              return;
            }
            console.error("[auth]", e);
            toast((e?.code || 'auth_error').toString().replace('auth/',''), 'error');
          });
        }
        $("google-btn")?.addEventListener("click", startGoogle, {passive:true});

        // Resolver redirect (no bloquea)
        getRedirectResult(auth).catch((e)=>console.warn("[redirect]", e?.code || e?.message));

        $("signout-btn")?.addEventListener("click", ()=>signOut(auth).catch(()=>toast('No se pudo cerrar sesi√≥n','error')));

        // Sesi√≥n
        onAuthStateChanged(auth, async (user)=>{
          if(!user){
            $("app-screen")?.classList.add("hidden");
            $("login-screen")?.classList.remove("hidden");
            return;
          }
          $("login-screen")?.classList.add("hidden");
          $("app-screen")?.classList.remove("hidden");

          // upsert m√≠nimo
          try {
            await setDoc(doc(db,"users",user.uid),{
              displayName:user.displayName||null,
              displayNameLower:(user.displayName||'').toLowerCase()||null,
              email:user.email||null,
              emailLower:(user.email||'').toLowerCase()||null,
              photoURL:user.photoURL||null,
              updatedAt:serverTimestamp()
            },{merge:true});
          } catch(e){ console.error('upsert users',e); }
        });

        // TODO: reinsertar aqu√≠ tu l√≥gica completa de feed/retos/amigos cuando quieras.
      })();
    }
  </script>
</body>
</html>
