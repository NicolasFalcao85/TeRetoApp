<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>TeReto</title>

  <!-- Tailwind (ok en dev). En prod conviene build con CLI/PostCSS -->
  <script src="https://cdn.tailwindcss.com"></script>

  <link rel="preconnect" href="https://fonts.googleapis.com"/>
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin/>
  <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;500;600;700&display=swap" rel="stylesheet"/>

  <style>
    body { font-family: 'Poppins', sans-serif; }
    .toast { visibility:hidden; opacity:0; transform:translateY(100%); transition:all .4s cubic-bezier(.2,.8,.2,1); pointer-events:none;}
    .toast.show { visibility:visible; opacity:1; transform:translateY(0); }
    .spinner { border:4px solid rgba(0,0,0,.1); width:36px; height:36px; border-radius:50%; border-left-color:#6366f1; animation:spin 1s linear infinite;}
    @keyframes spin { to{transform:rotate(360deg);} }
    .btn-primary { background-image:linear-gradient(to right,#6366f1,#8b5cf6); color:#fff; border-radius:.625rem; padding:.5rem .875rem; font-weight:700;}
    .btn-primary:hover { box-shadow:0 8px 25px rgba(99,102,241,.35);}
    .grid-mosaic { display:grid; grid-template-columns:repeat(3,1fr); gap:.5rem;}
    .mosaic-item { position:relative; aspect-ratio:1/1;}
    .mosaic-img { width:100%; height:100%; object-fit:cover; border-radius:.5rem;}
    .mosaic-del { position:absolute; top:.25rem; right:.25rem; background:rgba(0,0,0,.6); color:#fff; border-radius:.5rem; padding:.15rem .4rem; font-size:.8rem;}
    .badge { font-size:.7rem; padding:.1rem .35rem; border-radius:.35rem;}
    .locked { filter: blur(22px); }
    .tab-btn.active { border-bottom:2px solid #6366f1; color:#6366f1; font-weight:600;}
    #loading-spinner.hidden { display:none !important; }
    .hint { font-size:11px; color:#64748b }
  </style>
</head>
<body class="bg-slate-100 h-screen">

  <!-- SPINNER -->
  <div id="loading-spinner" class="hidden fixed inset-0 bg-slate-100/80 flex items-center justify-center z-[100]">
    <div class="spinner"></div>
  </div>

  <!-- TOAST -->
  <div id="toast" class="toast fixed bottom-24 left-1/2 -translate-x-1/2 flex items-center w-full max-w-xs p-4 text-slate-700 bg-white rounded-xl shadow-2xl z-[90]">
    <div id="toast-icon" class="inline-flex items-center justify-center flex-shrink-0 w-8 h-8 rounded-lg"></div>
    <div id="toast-message" class="ml-3 text-sm font-normal"></div>
  </div>

  <!-- LOGIN -->
  <div id="login-screen" class="min-h-screen flex items-center justify-center p-4">
    <div class="w-full max-w-sm bg-white rounded-2xl shadow-2xl p-6">
      <div class="flex items-center justify-center mb-4">
        <svg class="w-10 h-10" viewBox="0 0 32 32" fill="none"><defs><linearGradient id="lg1" x1="0" y1="0" x2="32" y2="32"><stop stop-color="#818CF8"/><stop offset="1" stop-color="#C084FC"/></linearGradient></defs><circle cx="16" cy="16" r="12" stroke="url(#lg1)" stroke-width="3"/><circle cx="16" cy="16" r="4" stroke="url(#lg1)" stroke-width="3"/></svg>
        <svg class="h-8 ml-2" viewBox="0 0 90 25" fill="none"><defs><linearGradient id="lg2" x1="0%" y1="0%" x2="100%" y2="0%"><stop offset="0%" stop-color="#6366f1"/><stop offset="100%" stop-color="#8b5cf6"/></linearGradient></defs><text x="0" y="20" font-size="24" font-weight="700" fill="url(#lg2)">TeReto</text></svg>
      </div>
      <p class="text-center text-slate-600 mb-4">Ingres√° para continuar</p>

      <div class="space-y-3 mb-4 text-sm">
        <label class="flex items-start gap-2">
          <input id="chk-adult" type="checkbox" class="mt-1 shrink-0">
          <span>Soy <strong>mayor de 18 a√±os</strong>.</span>
        </label>
        <label class="flex items-start gap-2">
          <input id="chk-terms" type="checkbox" class="mt-1 shrink-0">
          <span>He le√≠do y acepto los
            <a href="/legal/terminos-condiciones.html" target="_blank" class="underline text-indigo-600">T√©rminos y Condiciones</a>.
          </span>
        </label>
      </div>

      <button id="google-btn" type="button" class="relative w-full flex items-center justify-center gap-3 border rounded-xl py-3 hover:bg-slate-50 select-none disabled:opacity-50 disabled:cursor-not-allowed">
        <img alt="Google" src="https://www.gstatic.com/firebasejs/ui/2.0.0/images/auth/google.svg" class="w-5 h-5" draggable="false">
        <span class="font-semibold text-slate-700">Continuar con Google</span>
      </button>
      <p class="hint text-center mt-3">Serv√≠ esto en <code>http://localhost</code> o un dominio autorizado (Auth ‚Ä∫ Authorized domains).</p>
    </div>
  </div>

  <!-- APP -->
  <div id="app-screen" class="h-full flex flex-col hidden">
    <main class="flex-grow overflow-y-auto pb-20 bg-slate-100">

      <!-- FEED -->
      <div id="feed-view">
        <header class="sticky top-0 bg-white/80 backdrop-blur-sm p-4 border-b flex justify-between items-center z-40">
          <div class="flex items-center space-x-2">
            <svg class="w-8 h-8" viewBox="0 0 32 32" fill="none"><defs><linearGradient id="lg3" x1="0" y1="0" x2="32" y2="32"><stop stop-color="#818CF8"/><stop offset="1" stop-color="#C084FC"/></linearGradient></defs><circle cx="16" cy="16" r="12" stroke="url(#lg3)" stroke-width="3"/><circle cx="16" cy="16" r="4" stroke="url(#lg3)" stroke-width="3"/></svg>
            <svg class="h-7" viewBox="0 0 90 25" fill="none"><defs><linearGradient id="lg4" x1="0%" y1="0%" x2="100%" y2="0%"><stop offset="0%" stop-color="#6366f1"/><stop offset="100%" stop-color="#8b5cf6"/></linearGradient></defs><text x="0" y="20" font-size="24" font-weight="700" fill="url(#lg4)">TeReto</text></svg>
          </div>
          <button id="signout-btn" class="text-slate-500 hover:text-indigo-500 text-sm font-semibold">Cerrar sesi√≥n</button>
        </header>

        <div class="px-3 pt-3 pb-1">
          <div id="feed-tip" class="hidden text-[12px] text-slate-600">
            <span class="px-2 py-[2px] rounded-full border text-[10px]">Consejo</span> Toc√° la imagen bloqueada para aceptar el desaf√≠o. üòâ
          </div>
        </div>
        <div id="feed-container" class="p-2 space-y-4"></div>
      </div>

      <!-- CREATE -->
      <div id="create-view" class="hidden p-4">
        <div class="max-w-md mx-auto bg-white rounded-xl shadow-lg p-6">
          <h2 class="text-2xl font-bold mb-6 text-center text-slate-800">Crea un Nuevo Reto</h2>

          <div id="create-step-1" class="text-center">
            <h3 class="font-semibold text-lg mb-2 text-slate-700">Paso 1: Agreg√° el contenido</h3>
            <div id="image-preview-container" class="hidden my-4">
              <img id="image-preview" src="#" alt="Previsualizaci√≥n" class="rounded-lg max-h-60 object-cover mx-auto"/>
            </div>
            <div class="grid grid-cols-2 gap-4 my-4">
              <label for="file-upload" class="flex flex-col items-center justify-center p-4 border-2 border-dashed rounded-lg cursor-pointer hover:bg-slate-50 text-slate-500 hover:text-indigo-500">
                <svg class="w-10 h-10 mb-2" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 16v1a3 3 0 003 3h10a3 3 0 003-3v-1m-4-8l-4-4m0 0L8 8m4-4v12"></path></svg>
                <span class="text-sm font-semibold">Subir archivo</span>
                <input id="file-upload" type="file" class="sr-only" accept="image/*">
              </label>
              <button id="open-camera-btn" type="button" class="flex flex-col items-center justify-center p-4 border-2 border-dashed rounded-lg hover:bg-slate-50 text-slate-500 hover:text-indigo-500">
                <svg class="w-10 h-10 mb-2" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 9a2 2 0 012-2h.93a2 2 0 001.664-.89l.812-1.22A2 2 0 0110.07 4h3.86a2 2 0 011.664.89l.812 1.22A2 2 0 0018.07 7H19a2 2 0 012 2v9a2 2 0 01-2 2H5a2 2 0 01-2-2V9z"></path><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 13a3 3 0 11-6 0 3 3 0 016 0z"></path></svg>
                <span class="text-sm font-semibold">Usar c√°mara</span>
              </button>
            </div>
            <p id="file-name" class="mt-2 text-sm text-slate-500"></p>
            <button id="goto-step-2" class="mt-4 w-full btn-primary disabled:opacity-50 disabled:cursor-not-allowed" disabled>Siguiente</button>
          </div>

          <div id="create-step-2" class="hidden">
            <h3 class="font-semibold text-lg mb-3 text-slate-700">Paso 2: Configur√° el reto</h3>
            <div class="space-y-3">
              <label class="block text-sm font-medium text-slate-700">Descripci√≥n (opcional)</label>
              <textarea id="challenge-caption" rows="3" class="w-full px-3 py-2 border border-slate-300 rounded-md shadow-sm" placeholder="Escrib√≠ un pie de foto..."></textarea>

              <label class="block text-sm font-medium text-slate-700 mt-2">Vigencia</label>
              <select id="challenge-expiry" class="w-full border rounded-md px-3 py-2">
                <option value="none">Sin vencimiento</option>
                <option value="24">24 horas</option>
                <option value="48">48 horas</option>
              </select>
              <p class="text-xs text-slate-500">El feed oculta retos vencidos autom√°ticamente.</p>
            </div>

            <h3 class="font-semibold text-lg mt-5 mb-3 text-slate-700">Eleg√≠ el tipo</h3>
            <div class="space-y-4">
              <button id="select-trivia-btn" class="w-full text-left p-4 border rounded-lg hover:bg-slate-50 flex items-center">
                <span class="text-3xl mr-4">üß†</span>
                <div><p class="font-bold text-slate-800">Trivia</p><p class="text-sm text-slate-500">Pregunta de opci√≥n m√∫ltiple.</p></div>
              </button>
              <button id="select-photo-challenge-btn" class="w-full text-left p-4 border rounded-lg hover:bg-slate-50 flex items-center">
                <span class="text-3xl mr-4">üì∏</span>
                <div><p class="font-bold text-slate-800">Foto / Video</p><p class="text-sm text-slate-500">Ped√≠ que cumplan una consigna.</p></div>
              </button>
            </div>
          </div>

          <div id="create-step-3-trivia" class="hidden">
            <h3 class="font-semibold text-lg mb-4 text-slate-700">Paso 3: Configur√° la Trivia</h3>
            <form id="trivia-form" class="space-y-4">
              <div><label class="block text-sm font-medium text-slate-700">Pregunta</label><input id="trivia-question" class="mt-1 block w-full border rounded-md px-3 py-2" required></div>
              <div><label class="block text-sm font-medium text-green-700">Respuesta Correcta</label><input id="correct-answer" class="mt-1 block w-full border rounded-md px-3 py-2 border-green-400" required></div>
              <div>
                <label class="block text-sm font-medium text-red-700">Respuestas Incorrectas</label>
                <input id="wrong-answer-1" class="mt-1 block w-full border rounded-md px-3 py-2" required placeholder="Opci√≥n 1">
                <input id="wrong-answer-2" class="mt-2 block w-full border rounded-md px-3 py-2" required placeholder="Opci√≥n 2">
                <input id="wrong-answer-3" class="mt-2 block w-full border rounded-md px-3 py-2" required placeholder="Opci√≥n 3">
              </div>
              <button type="submit" class="w-full btn-primary">Publicar Reto</button>
            </form>
          </div>

          <div id="create-step-3-photo" class="hidden">
            <h3 class="font-semibold text-lg mb-4 text-slate-700">Paso 3: Describe el Desaf√≠o</h3>
            <form id="photo-challenge-form" class="space-y-4">
              <div>
                <label class="block text-sm font-medium text-slate-700">Consigna</label>
                <textarea id="photo-challenge-task" rows="4" class="mt-1 block w-full px-3 py-2 border border-slate-300 rounded-md shadow-sm" required></textarea>
              </div>
              <button type="submit" class="w-full btn-primary">Publicar Reto</button>
            </form>
          </div>
        </div>
      </div>

      <!-- FRIENDS -->
      <div id="friends-view" class="hidden">
        <header class="sticky top-0 bg-white/80 backdrop-blur-sm p-4 border-b z-40">
          <h1 class="text-3xl font-bold text-slate-800">Amigos</h1>
        </header>

        <div class="p-4">
          <div class="flex gap-4 border-b">
            <button class="tab-btn active py-2" data-tab="buscar">Buscar</button>
            <button class="tab-btn py-2 text-slate-500" data-tab="mis-amigos">Mis Amigos</button>
            <button class="tab-btn py-2 text-slate-500" data-tab="solicitudes">Solicitudes</button>
            <button class="tab-btn py-2 text-slate-500" data-tab="seguidores">Seguidores</button>
          </div>

          <div id="tab-buscar" class="mt-4">
            <div class="relative mb-4">
              <input type="search" id="user-search-input" placeholder="Buscar por nombre o email..." class="w-full pl-10 pr-4 py-2 border rounded-full focus:outline-none focus:ring-2 focus:ring-indigo-500">
              <div class="absolute top-0 left-0 inline-flex items-center p-2 h-full">
                <svg class="text-slate-400 w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z"/></svg>
              </div>
            </div>
            <div id="friends-results" class="space-y-2"></div>
          </div>

          <div id="tab-mis-amigos" class="hidden mt-4"><div id="friends-list" class="space-y-2"></div></div>
          <div id="tab-solicitudes" class="hidden mt-4"><div id="requests-list" class="space-y-2"></div></div>
          <div id="tab-seguidores" class="hidden mt-4"><div id="followers-list" class="space-y-2"></div></div>
        </div>
      </div>

      <!-- PROFILE -->
      <div id="profile-view" class="hidden">
        <div class="p-4 bg-white shadow-lg">
          <div class="flex flex-col items-center">
            <img id="profile-pic" class="w-24 h-24 rounded-full border-4 border-white -mt-16 shadow-lg">
            <h2 id="profile-name" class="text-2xl font-bold mt-4 text-slate-800"></h2>
            <p id="profile-email" class="text-slate-500"></p>
            <div class="w-full mt-6">
              <div class="flex items-center justify-between mb-2">
                <h3 class="text-lg font-semibold text-slate-700">Mis retos</h3>
                <span id="my-retos-count" class="text-xs text-slate-500"></span>
              </div>
              <div id="my-mosaic" class="grid-mosaic"></div>
            </div>
          </div>
        </div>
      </div>

    </main>

    <!-- NAV con punto rojo -->
    <nav class="fixed bottom-0 left-0 right-0 bg-white/95 backdrop-blur-sm border-t border-slate-200 flex justify-around p-1 z-40">
      <button data-view="feed-view" class="nav-button flex-1 p-2 rounded-lg text-indigo-500 flex flex-col items-center space-y-1">üè†<span class="text-xs font-semibold">Inicio</span></button>
      <button data-view="friends-view" class="nav-button relative flex-1 p-2 rounded-lg text-slate-500 flex flex-col items-center space-y-1">
        üë•<span class="text-xs font-semibold">Amigos</span>
        <span id="req-dot" class="hidden absolute top-1 right-3 w-2 h-2 bg-red-600 rounded-full"></span>
      </button>
      <button data-view="create-view" class="nav-button flex-1 p-2 rounded-lg text-slate-500 flex flex-col items-center space-y-1">‚ûï<span class="text-xs font-semibold">Crear</span></button>
      <button data-view="profile-view" class="nav-button flex-1 p-2 rounded-lg text-slate-500 flex flex-col items-center space-y-1">üë§<span class="text-xs font-semibold">Perfil</span></button>
    </nav>
  </div>

  <!-- COMMENTS MODAL -->
  <div id="comments-modal" class="hidden fixed inset-0 bg-black/50 z-50 flex items-center justify-center p-4">
    <div class="bg-white rounded-2xl shadow-2xl w-full max-w-lg flex flex-col max-h-[85vh]">
      <header class="flex items-center justify-between p-4 border-b">
        <h2 class="text-xl font-bold text-slate-800">Comentarios</h2>
        <button id="close-comments-modal" class="text-slate-500 hover:text-slate-800" aria-label="Cerrar comentarios">‚úñ</button>
      </header>
      <div id="comments-modal-body" class="flex-grow overflow-y-auto p-4 space-y-4 bg-slate-50"></div>
      <footer class="p-4 border-t bg-white">
        <form id="comment-form" class="flex items-center space-x-2">
          <img id="comment-user-img" class="w-8 h-8 rounded-full" alt="">
          <input id="comment-input" type="text" placeholder="A√±ade un comentario..." class="flex-grow bg-slate-100 border-slate-200 rounded-full py-2 px-4 focus:outline-none focus:ring-2 focus:ring-indigo-500">
          <button type="submit" class="btn-primary px-3 py-2" aria-label="Enviar comentario">‚û§</button>
        </form>
      </footer>
    </div>
  </div>

  <!-- TRIVIA MODAL -->
  <div id="trivia-modal" class="hidden fixed inset-0 bg-black/70 z-[100] p-4 flex items-center justify-center">
    <div class="bg-white rounded-2xl shadow-2xl max-w-lg w-full p-6">
      <div class="flex justify-between items-center mb-3">
        <h3 class="text-xl font-bold text-slate-800">Trivia</h3>
        <button id="trivia-close" class="text-slate-500 hover:text-slate-800">‚úñ</button>
      </div>
      <p id="trivia-q" class="font-semibold text-slate-800 mb-4"></p>
      <div id="trivia-opts" class="grid grid-cols-1 sm:grid-cols-2 gap-3"></div>
      <p id="trivia-feedback" class="h-6 mt-2 text-center text-sm"></p>
    </div>
  </div>

  <!-- CAMERA MODAL -->
  <div id="camera-modal" class="hidden fixed inset-0 bg-black/80 z-[100]">
    <video id="cam-video" class="w-full h-full object-contain" autoplay playsinline muted></video>
    <canvas id="cam-canvas" class="hidden"></canvas>
    <div class="absolute top-3 left-3"><button id="cam-close" class="bg-white/20 text-white px-3 py-1 rounded-lg">Cerrar</button></div>
    <div class="absolute bottom-6 left-0 right-0 flex items-center justify-center">
      <button id="cam-capture" class="w-20 h-20 rounded-full bg-white border-4 border-slate-400 hover:border-white focus:outline-none"></button>
    </div>
  </div>

  <!-- TEMPLATE POST -->
  <template id="post-template">
    <div class="bg-white rounded-xl shadow-lg overflow-hidden post-card">
      <div class="p-4 flex items-center space-x-3">
        <img class="w-10 h-10 rounded-full author-img" src="">
        <div>
          <p class="font-semibold text-slate-800 author-name"></p>
          <p class="text-[11px] text-slate-500 post-time"></p>
        </div>
      </div>
      <div class="relative">
        <img class="w-full h-80 object-cover content-img" src="">
        <div class="lock-overlay absolute inset-0 hidden bg-black/40 text-white flex flex-col items-center justify-center">
          <div class="text-5xl mb-2">üîí</div>
          <p class="text-sm">Toc√° para aceptar el desaf√≠o</p>
        </div>
      </div>
      <div class="p-4">
        <p class="text-sm text-slate-700 caption mt-1"></p>
        <div class="flex items-center justify-between mt-2 text-slate-500">
          <div class="flex space-x-4">
            <button class="like-button flex items-center space-x-1 cursor-pointer"><span>‚ù§</span><span class="likes-count">0</span></button>
            <button class="comment-button flex items-center space-x-1 cursor-pointer"><span>üí¨</span><span class="comments-count">0</span></button>
          </div>
          <span class="text-[11px] post-time-secondary"></span>
        </div>
      </div>
    </div>
  </template>

  <!-- TEMPLATE COMMENT -->
  <template id="comment-item-template">
    <div class="flex items-start space-x-3">
      <img class="w-8 h-8 rounded-full cmt-img">
      <div class="flex-1 bg-slate-100 rounded-xl p-3">
        <p class="text-sm"><strong class="cmt-name text-slate-800"></strong> <span class="cmt-text text-slate-600"></span></p>
        <p class="text-xs text-slate-400 mt-1 cmt-time"></p>
      </div>
    </div>
  </template>

  <!-- SINGLE SCRIPT -->
  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/11.0.1/firebase-app.js";
    import {
      getAuth, GoogleAuthProvider, signInWithPopup, signInWithRedirect, getRedirectResult,
      onAuthStateChanged, signOut, setPersistence, browserLocalPersistence
    } from "https://www.gstatic.com/firebasejs/11.0.1/firebase-auth.js";
    import {
      getFirestore, collection, addDoc, setDoc, doc, updateDoc,
      serverTimestamp, query, orderBy, onSnapshot, getDocs, limit, where,
      startAt, endAt, deleteDoc, writeBatch, increment, getDoc
    } from "https://www.gstatic.com/firebasejs/11.0.1/firebase-firestore.js";
    import {
      getStorage, ref, uploadString, getDownloadURL
    } from "https://www.gstatic.com/firebasejs/11.0.1/firebase-storage.js";

    // --- Firebase ---
    const firebaseConfig = {
      apiKey: "AIzaSyCSdjAdY7ymmOwIN7zApP-XpXxTar_0pHk",
      authDomain: "tereto-prod.firebaseapp.com",
      projectId: "tereto-prod",
      storageBucket: "tereto-prod.appspot.com",
      messagingSenderId: "914605096619",
      appId: "1:914605096619:web:88a9b78eac50c35cb181ee"
    };
    const app = initializeApp(firebaseConfig);
    const auth = getAuth(app);
    try { await setPersistence(auth, browserLocalPersistence); } catch(_) {}
    const provider = new GoogleAuthProvider();
    provider.setCustomParameters({ prompt: "select_account" });
    const db = getFirestore(app);
    const storage = getStorage(app);

    // ---- Helpers ----
    function $(id){ return document.getElementById(id); }
    function toastMsg(msg,type){ 
      var tm=$("toast-message"), ti=$("toast-icon"), t=$("toast");
      if(!tm||!ti||!t) return;
      tm.textContent=msg; ti.innerHTML = type==='error'?'‚ùå':'‚úÖ';
      t.classList.add('show'); setTimeout(function(){ t.classList.remove('show'); }, 2400);
    }
    function isExpired(ch){
      if(!ch || !ch.expiresAt) return false;
      var d = (ch.expiresAt && typeof ch.expiresAt.toDate==='function') ? ch.expiresAt.toDate() : new Date(ch.expiresAt);
      return d < new Date();
    }
    function ts(v){
      if(!v) return 0;
      if(typeof v.toDate==='function'){ try{ return v.toDate().getTime(); }catch(_){ return 0; } }
      if(v instanceof Date) return v.getTime();
      return 0;
    }

    // ---- Estado global ----
    var TERMS_VERSION = "1.0";
    var TERMS_URL = "/legal/terminos-condiciones.html";

    var currentUser = null, solvedSet = new Set();
    var friendsSet = new Set(), followingSet = new Set(), followersSet = new Set(), incomingReqSet = new Set(), sentReqSet = new Set();

    var unsubFriends=null, unsubFollowing=null, unsubFollowers=null, unsubIncomingReq=null, unsubSentReq=null;
    var feedUnsub=null, myChallengesUnsub=null, commentsUnsub=null;

    // Control de feed para evitar ‚Äúrace‚Äù
    var feedGen = 0;
    var lastFeedItems = [];

    // Debounce render amigos
    var friendsRenderScheduled = false;

    function clearSubs(){
      var arr=[unsubFriends,unsubFollowing,unsubFollowers,unsubIncomingReq,unsubSentReq,feedUnsub,myChallengesUnsub,commentsUnsub];
      for(var i=0;i<arr.length;i++){ if(typeof arr[i]==='function'){ try{arr[i]();}catch(_){ } } }
      unsubFriends=unsubFollowing=unsubFollowers=unsubIncomingReq=unsubSentReq=feedUnsub=myChallengesUnsub=commentsUnsub=null;
    }

    function solvedKey(uid){ return "tereto_solved_"+uid; }
    function loadSolved(uid){
      try{
        var raw = localStorage.getItem(solvedKey(uid)) || "[]";
        var arr = JSON.parse(raw);
        return new Set(arr);
      }catch(_){ return new Set(); }
    }
    function saveSolved(uid, setVal){
      try{ localStorage.setItem(solvedKey(uid), JSON.stringify(Array.from(setVal))); }catch(_){}
    }

    // ---- Login UI checks ----
    var chkAdult = $("chk-adult");
    var chkTerms = $("chk-terms");
    var googleBtn = $("google-btn");
    function updateLoginBtn(){
      if(!googleBtn) return;
      var ok = (chkAdult && chkAdult.checked) && (chkTerms && chkTerms.checked);
      googleBtn.disabled = !ok;
    }
    if(chkAdult) chkAdult.addEventListener('change', updateLoginBtn);
    if(chkTerms) chkTerms.addEventListener('change', updateLoginBtn);
    updateLoginBtn();

    // ---- Auth ----
    window._startGoogle = async function(){
      if(!(chkAdult && chkAdult.checked) || !(chkTerms && chkTerms.checked)){
        toastMsg('Tild√° +18 y TyC','error'); 
        return;
      }
      var sp=$("loading-spinner"); if(sp) sp.classList.remove("hidden");
      try{
        try { await signInWithPopup(auth, provider); }
        catch(e){
          if (e && (e.code==="auth/popup-blocked" || e.code==="auth/cancelled-popup-request")) {
            await signInWithRedirect(auth, provider);
          } else { throw e; }
        }
      }catch(err){
        console.error(err);
        var code = (err && err.code) ? String(err.code).replace('auth/','') : 'auth_error';
        toastMsg(code,'error');
      }finally{
        if(sp) sp.classList.add("hidden");
      }
    };
    if(googleBtn) {
      googleBtn.addEventListener("click", function(){ window._startGoogle(); }, {passive:true});
      googleBtn.addEventListener("touchend", function(e){ e.preventDefault(); window._startGoogle(); }, {passive:false});
    }

    // Resolver redirect silencioso
    try{ var sp2=$("loading-spinner"); if(sp2) sp2.classList.remove("hidden"); await getRedirectResult(auth); }
    catch(e){ console.warn("redirect", e && (e.code||e.message)); }
    finally { if(sp2) sp2.classList.add("hidden"); }

    var signoutBtn = $("signout-btn");
    if(signoutBtn) signoutBtn.addEventListener("click", function(){ signOut(auth).catch(function(){ toastMsg('No se pudo cerrar sesi√≥n','error'); }); });

    async function upsertUserWithTerms(user){
      var dn=user.displayName||null, em=user.email||null;
      try{
        await setDoc(doc(db,"users",user.uid),{
          displayName:dn, displayNameLower: dn? dn.toLowerCase(): null,
          email:em, emailLower: em? em.toLowerCase(): null,
          photoURL:user.photoURL||null, updatedAt:serverTimestamp(),
          isAdult:true, acceptedTermsAt:serverTimestamp(), acceptedTermsVersion:TERMS_VERSION, acceptedTermsUrl:TERMS_URL
        },{merge:true});
      }catch(e){ console.error('upsert users',e); }
    }

    // ---- Subscriptions (friends/followers/requests) ----
    function renderFriendsTab(){
      if(friendsRenderScheduled) return;
      friendsRenderScheduled = true;
      queueMicrotask(function(){
        friendsRenderScheduled = false;
        var activeBtn = document.querySelector('.tab-btn.active');
        if(!activeBtn) return;
        setActiveTab(activeBtn.getAttribute('data-tab'));
      });
    }

    function subFriends(){
      if(unsubFriends){ try{unsubFriends();}catch(_){ } unsubFriends=null; }
      unsubFriends = onSnapshot(collection(db,'users',currentUser.uid,'friends'), function(snap){
        friendsSet = new Set(snap.docs.map(function(d){ return d.id; }));
        restartFeed(); renderFriendsTab();
      });
    }
    function subFollowing(){
      if(unsubFollowing){ try{unsubFollowing();}catch(_){ } unsubFollowing=null; }
      unsubFollowing = onSnapshot(collection(db,'users',currentUser.uid,'following'), function(snap){
        followingSet = new Set(snap.docs.map(function(d){ return d.id; }));
        renderFriendsTab();
      });
    }
    function subFollowers(){
      if(unsubFollowers){ try{unsubFollowers();}catch(_){ } unsubFollowers=null; }
      unsubFollowers = onSnapshot(collection(db,'users',currentUser.uid,'followers'), function(snap){
        followersSet = new Set(snap.docs.map(function(d){ return d.id; }));
        renderFriendsTab();
      });
    }

    function updateRequestsBadge(){
      var dot = $("req-dot");
      if(dot) dot.classList.toggle('hidden', incomingReqSet.size === 0);
    }
    function subIncomingRequests(){
      if(unsubIncomingReq){ try{unsubIncomingReq();}catch(_){ } unsubIncomingReq=null; }
      unsubIncomingReq = onSnapshot(collection(db,'users',currentUser.uid,'friendRequests'), function(snap){
        incomingReqSet = new Set(snap.docs.map(function(d){ return d.id; }));
        renderFriendRequests();
        updateRequestsBadge();
      });
    }
    function subSentRequests(){
      if(unsubSentReq){ try{unsubSentReq();}catch(_){ } unsubSentReq=null; }
      unsubSentReq = onSnapshot(collection(db,'users',currentUser.uid,'sentRequests'), function(snap){
        sentReqSet = new Set(snap.docs.map(function(d){ return d.id; }));
        renderFriendsSearch();
      });
    }

    // ---- FEED (con control de generaci√≥n para evitar race/duplicados)
    function restartFeed(){
      var myGen = ++feedGen;

      if(feedUnsub){ try{ feedUnsub(); }catch(_){ } feedUnsub=null; }
      if(!currentUser) return;

      var ids = Array.from(friendsSet);
      var feedContainer=$("feed-container");

      function createListener(qRef){
        feedUnsub = onSnapshot(qRef, function(snap){
          if(myGen !== feedGen) return;
          var items = snap.docs.map(function(d){ return {id:d.id, ...d.data()}; })
            .filter(function(c){ return !isExpired(c); })
            .filter(function(c){ return c.authorId !== currentUser.uid; })
            .sort(function(a,b){ return ts(b.createdAt) - ts(a.createdAt); });

          if(items.length === 0 && lastFeedItems.length > 0) return; // evita parpadeo
          lastFeedItems = items;
          renderFeed(items);
        });
      }

      if(ids.length === 0){
        var qPublic = query(collection(db,'challenges'), where('vis','==','public'), orderBy('createdAt','desc'), limit(120));
        createListener(qPublic);
        return;
      }

      if(ids.length <= 10){
        var qRef = query(collection(db,'challenges'), where('authorId','in',ids), orderBy('createdAt','desc'), limit(200));
        createListener(qRef);
        return;
      }

      var qLast = query(collection(db,'challenges'), orderBy('createdAt','desc'), limit(200));
      feedUnsub = onSnapshot(qLast, function(snap){
        if(myGen !== feedGen) return;
        var setIds = new Set(ids);
        var items = snap.docs.map(function(d){ return {id:d.id, ...d.data()}; })
          .filter(function(c){ return setIds.has(c.authorId); })
          .filter(function(c){ return !isExpired(c); })
          .filter(function(c){ return c.authorId !== currentUser.uid; })
          .sort(function(a,b){ return ts(b.createdAt) - ts(a.createdAt); });
        if(items.length === 0 && lastFeedItems.length > 0) return;
        lastFeedItems = items;
        renderFeed(items);
      });
    }

    var postTemplate = document.getElementById("post-template");
    function renderFeed(items){
      var feedContainer=$("feed-container");
      if(!feedContainer) return;
      feedContainer.innerHTML='';
      var tip = $("feed-tip");
      if(tip) tip.classList.toggle("hidden", !!localStorage.getItem("tereto_tip_seen"));

      if(items.length===0){
        feedContainer.innerHTML='<div class="mx-3 my-6 p-4 bg-white rounded-xl shadow text-slate-600"><p class="font-semibold text-slate-800 mb-1">No hay retos nuevos</p><p class="text-sm">Prob√° seguir a tus amigos.</p></div>';
        return;
      }
      for(var i=0;i<items.length;i++){
        var ch=items[i];
        var frag=document.importNode(postTemplate.content,true);
        var card=frag.querySelector('.post-card'); card.dataset.challengeId=ch.id;
        frag.querySelector('.author-img').src=ch.authorImg||'';
        frag.querySelector('.author-name').textContent=ch.authorName||'Usuario';
        var dt = ch.createdAt && typeof ch.createdAt.toDate==='function' ? ch.createdAt.toDate() : new Date();
        frag.querySelector('.post-time').textContent=new Date(dt).toLocaleString('es-AR',{dateStyle:'short',timeStyle:'short'});
        frag.querySelector('.content-img').src=ch.contentUrl||'https://placehold.co/800x600/333/FFF?text=TeReto';
        frag.querySelector('.caption').textContent=ch.caption||'';
        frag.querySelector('.likes-count').textContent=(ch.likesCount!=null?ch.likesCount:0);
        frag.querySelector('.comments-count').textContent=(ch.commentsCount!=null?ch.commentsCount:0);
        paintLockState(card, shouldUnlock(ch));
        feedContainer.appendChild(frag);
      }
    }
    function shouldUnlock(ch){ if(!currentUser) return false; if(ch.authorId===currentUser.uid) return true; return solvedSet.has(ch.id); }
    function paintLockState(card, unlocked){
      var img=card.querySelector('.content-img');
      var overlay=card.querySelector('.lock-overlay');
      if(!img || !overlay) return;
      if(unlocked){ img.classList.remove('locked'); overlay.classList.add('hidden'); }
      else { img.classList.add('locked'); overlay.classList.remove('hidden'); }
    }

    // --- Perfil (mosaico)
    var myChallenges=[], myChallengesUnsub2=null;
    function startMyChallenges(){
      if (myChallengesUnsub2) { try{myChallengesUnsub2();}catch(_){ } myChallengesUnsub2 = null; }
      if (!currentUser) return;
      var qRef = query(collection(db,'challenges'), where('authorId','==', currentUser.uid), limit(500));
      myChallengesUnsub2 = onSnapshot(qRef, function(snap){
        try{
          myChallenges = snap.docs.map(function(d){
            var data=d.data();
            return { id:d.id, ...data, _createdAtMs: ts(data.createdAt) };
          }).sort(function(a,b){ return b._createdAtMs - a._createdAtMs; });
          refreshProfile();
        }catch(err){
          console.error('myChallenges sub', err);
          toastMsg('No se pudo cargar tus retos','error');
        }
      }, function(err){
        console.error('myChallenges sub', err);
        toastMsg('No se pudo cargar tus retos','error');
      });
    }
    function refreshProfile(){
      if(!currentUser) return;
      var pPic=$("profile-pic"), pName=$("profile-name"), pEmail=$("profile-email");
      if(pPic) pPic.src=currentUser.photoURL||'';
      if(pName) pName.textContent=currentUser.displayName||'Usuario';
      if(pEmail) pEmail.textContent=currentUser.email||'';

      var grid=$("my-mosaic"); if(!grid) return;
      grid.innerHTML='';
      var cnt=$("my-retos-count"); if(cnt) cnt.textContent=String(myChallenges.length)+" retos";

      for(var i=0;i<myChallenges.length;i++){
        var ch=myChallenges[i];
        var wrap=document.createElement('div'); wrap.className='mosaic-item'; wrap.dataset.id=ch.id;
        var img=document.createElement('img'); img.className='mosaic-img'; img.src=ch.contentUrl||'https://placehold.co/600x600/333/FFF?text=Reto'; wrap.appendChild(img);
        var bar=document.createElement('div'); bar.style.position='absolute'; bar.style.left='.25rem'; bar.style.bottom='.25rem'; bar.style.display='flex'; bar.style.gap='.25rem';
        var b1=document.createElement('span'); b1.className='badge'; b1.style.background='rgba(0,0,0,.6)'; b1.style.color='#fff'; b1.textContent='‚ù§ '+(ch.likesCount||0);
        var b2=document.createElement('span'); b2.className='badge'; b2.style.background='rgba(0,0,0,.6)'; b2.style.color='#fff'; b2.textContent='üí¨ '+(ch.commentsCount||0);
        bar.appendChild(b1); bar.appendChild(b2);
        if(isExpired(ch)){ var ex=document.createElement('span'); ex.className='badge'; ex.style.background='rgba(255,0,0,.7)'; ex.style.color='#fff'; ex.textContent='Vencido'; bar.appendChild(ex); }
        wrap.appendChild(bar);
        var del=document.createElement('button'); del.className='mosaic-del'; del.title='Eliminar'; del.textContent='üóëÔ∏è';
        del.onclick = (function(chId){
          return async function(e){
            e.stopPropagation();
            if(!confirm('¬øEliminar este reto?')) return;
            try{ await deleteDoc(doc(db,'challenges',chId)); toastMsg('Reto eliminado'); }
            catch(err){ console.error(err); toastMsg('No se pudo eliminar','error'); }
          };
        })(ch.id);
        var appended = grid.appendChild(wrap);
        appended.appendChild(del);
      }
    }

    // --- Comentarios
    var commentsModal=$("comments-modal"), commentsModalBody=$("comments-modal-body");
    var commentForm=$("comment-form"), commentInput=$("comment-input"), commentUserImg=$("comment-user-img"), commentItemTemplate=$("comment-item-template");
    function openComments(chId){
      if(!currentUser) return;
      if(commentUserImg) commentUserImg.src=currentUser.photoURL||'';
      if(commentForm) commentForm.dataset.challengeId=chId;
      if(commentsModal) commentsModal.classList.remove('hidden');
      if(commentsUnsub){ try{commentsUnsub();}catch(_){ } commentsUnsub=null; }
      var qRef=query(collection(db,'challenges',chId,'comments'), orderBy('createdAt','asc'), limit(200));
      commentsUnsub=onSnapshot(qRef,function(snap){
        if(!commentsModalBody) return;
        commentsModalBody.innerHTML='';
        snap.forEach(function(d){
          var c=d.data();
          var el=document.importNode(commentItemTemplate.content,true);
          el.querySelector('.cmt-img').src=c.authorImg||'';
          el.querySelector('.cmt-name').textContent=c.authorName||'Usuario';
          el.querySelector('.cmt-text').textContent=c.text||'';
          var dt=c.createdAt && typeof c.createdAt.toDate==='function' ? c.createdAt.toDate() : new Date();
          el.querySelector('.cmt-time').textContent=new Date(dt).toLocaleString('es-AR',{timeStyle:'short'});
          commentsModalBody.appendChild(el);
        });
      });
    }
    function closeComments(){
      if(commentsModal) commentsModal.classList.add('hidden');
      if(commentsUnsub){ try{commentsUnsub();}catch(_){ } commentsUnsub=null; }
    }
    var closeCBtn = $("close-comments-modal");
    if(closeCBtn) closeCBtn.addEventListener('click', closeComments);
    if(commentForm) commentForm.addEventListener('submit', async function(e){
      e.preventDefault();
      var chId=commentForm.dataset.challengeId; 
      var text=(commentInput && commentInput.value ? commentInput.value : '').trim(); 
      if(!text) return;
      try{
        var batch=writeBatch(db);
        var cRef=doc(collection(db,'challenges',chId,'comments'));
        batch.set(cRef,{authorId:currentUser.uid,authorName:currentUser.displayName,authorImg:currentUser.photoURL,text,createdAt:serverTimestamp()});
        batch.update(doc(db,'challenges',chId),{commentsCount:increment(1)});
        await batch.commit();
        if(commentInput) commentInput.value='';
      }catch(e){ console.error(e); toastMsg('No se pudo comentar','error'); }
    });

    // --- Crear reto: compresi√≥n + subida a Storage (data_url) ---
    function calcExpiresAt(){
      var sel = $("challenge-expiry");
      if(!sel) return null;
      var v = sel.value;
      if(v==='24') return new Date(Date.now()+24*3600*1000);
      if(v==='48') return new Date(Date.now()+48*3600*1000);
      return null;
    }
    var fileUpload = $("file-upload");
    if(fileUpload) fileUpload.addEventListener('change', async function(e){
      var f = fileUpload.files && fileUpload.files[0];
      if(!f){
        var fn=$("file-name"); if(fn) fn.textContent='';
        var gs=$("goto-step-2"); if(gs){ gs.disabled=true; }
        var ipc=$("image-preview-container"); if(ipc) ipc.classList.add('hidden');
        return;
      }
      var fn2=$("file-name"); if(fn2) fn2.textContent=f.name;
      var dataUrl=await fileToCompressedDataURL(f);
      var gs2=$("goto-step-2");
      if(gs2) gs2.dataset.fileUrl=dataUrl;
      var ip=$("image-preview"); if(ip) ip.src=dataUrl;
      var ipc2=$("image-preview-container"); if(ipc2) ipc2.classList.remove('hidden');
      if(gs2) gs2.disabled=false;
    });
    var camBtn = $("open-camera-btn");
    if(camBtn) camBtn.addEventListener('click', async function(){
      var dataUrl=await captureWithModal(); if(!dataUrl) return;
      var ip=$("image-preview"); if(ip) ip.src=dataUrl;
      var ipc=$("image-preview-container"); if(ipc) ipc.classList.remove('hidden');
      var btn=$("goto-step-2"); if(btn){ btn.dataset.fileUrl=dataUrl; btn.disabled=false; }
      var fn=$("file-name"); if(fn) fn.textContent='Foto capturada - '+new Date().toLocaleTimeString()+'.jpg';
    });
    function showCreateStep(step){
      var ids=["create-step-1","create-step-2","create-step-3-trivia","create-step-3-photo"];
      for(var i=0;i<ids.length;i++){ var el=$(ids[i]); if(el) el.classList.add("hidden"); }
      var tgt=$(step); if(tgt) tgt.classList.remove("hidden");
    }
    var nextBtn=$("goto-step-2"); if(nextBtn) nextBtn.addEventListener('click', function(){ showCreateStep('create-step-2'); });
    var stBtn=$("select-trivia-btn"); if(stBtn) stBtn.addEventListener('click', function(){ showCreateStep('create-step-3-trivia'); });
    var spBtn=$("select-photo-challenge-btn"); if(spBtn) spBtn.addEventListener('click', function(){ showCreateStep('create-step-3-photo'); });

    async function publishChallenge(payload){
      if(!currentUser) return;
      var gs=$("goto-step-2");
      var dataUrl = (gs && gs.dataset.fileUrl) ? gs.dataset.fileUrl : '';
      if(!dataUrl){ toastMsg('Falta la imagen','error'); return; }

      var tsName = Date.now();
      var path = "challenges/"+currentUser.uid+"/"+tsName+".jpg";
      var sRef = ref(storage, path);
      await uploadString(sRef, dataUrl, 'data_url');
      var contentUrl = await getDownloadURL(sRef);

      try{
        await addDoc(collection(db,'challenges'),{
          authorId:currentUser.uid, authorName:currentUser.displayName, authorImg:currentUser.photoURL,
          createdAt:serverTimestamp(), expiresAt:calcExpiresAt(),
          contentUrl, caption:(($("challenge-caption") && $("challenge-caption").value) || '').trim() || null,
          likesCount:0, commentsCount:0, vis:'public', ...payload
        });
        toastMsg('¬°Reto publicado!','success');
        switchView('feed-view');
      }catch(e){
        console.error(e);
        var msg=(e && (e.code||e.message)) ? String(e.code||e.message) : '';
        if(msg.indexOf('permission-denied')>=0) toastMsg('Permisos denegados','error');
        else toastMsg('No se pudo publicar','error');
      }
    }
    var trivForm = $("trivia-form");
    if(trivForm) trivForm.addEventListener('submit', function(e){
      e.preventDefault();
      publishChallenge({
        type:'trivia',
        question: ($("trivia-question") && $("trivia-question").value) || '',
        correctAnswer: ($("correct-answer") && $("correct-answer").value) || '',
        wrongAnswers: [ ($("wrong-answer-1") && $("wrong-answer-1").value)||'',
                        ($("wrong-answer-2") && $("wrong-answer-2").value)||'',
                        ($("wrong-answer-3") && $("wrong-answer-3").value)||'' ]
      });
    });
    var phForm = $("photo-challenge-form");
    if(phForm) phForm.addEventListener('submit', function(e){
      e.preventDefault();
      publishChallenge({ type:'photo', question: ($("photo-challenge-task") && $("photo-challenge-task").value) || '' });
    });

    async function fileToCompressedDataURL(file,maxW,quality){
      maxW = maxW || 960; quality = quality || 0.75;
      if(!file || !(file.type && file.type.indexOf('image/')===0)) return 'https://placehold.co/800x600/333/FFF?text=TeReto';
      var bmp = await createImageBitmap(file);
      var r = bmp.width / bmp.height;
      var w = Math.min(bmp.width, maxW);
      var h = Math.round(w / r);
      var cvs=document.createElement('canvas'); cvs.width=w; cvs.height=h;
      var ctx=cvs.getContext('2d'); ctx.drawImage(bmp,0,0,w,h);
      var data=cvs.toDataURL('image/jpeg',quality);
      var kb=Math.round((data.length*3)/4/1024);
      if(kb>400) data=cvs.toDataURL('image/jpeg',0.65);
      return data;
    }

    // Trivia
    var triviaModal=$("trivia-modal"), triviaQ=$("trivia-q"), triviaOpts=$("trivia-opts"), triviaFeedback=$("trivia-feedback");
    function openTrivia(ch, card){
      if(!triviaQ||!triviaOpts||!triviaModal) return;
      triviaQ.textContent=ch.question||'';
      triviaOpts.innerHTML='';
      var arr=(ch.wrongAnswers||[]).concat([ch.correctAnswer]).map(function(x){return String(x);});
      arr.sort(function(){ return Math.random()-0.5; });
      for(var i=0;i<arr.length;i++){
        (function(opt){
          var btn=document.createElement('button'); btn.className='w-full text-left p-3 border rounded-lg hover:bg-slate-50'; btn.textContent=opt;
          btn.onclick=function(){
            var ok = (String(opt)===String(ch.correctAnswer));
            if(triviaFeedback){
              if(ok){ triviaFeedback.className='h-6 mt-2 text-center text-sm text-green-600'; triviaFeedback.textContent='¬°Correcto!'; }
              else { triviaFeedback.className='h-6 mt-2 text-center text-sm text-red-600'; triviaFeedback.textContent='Respuesta incorrecta'; }
            }
            if(ok){
              solvedSet.add(card.dataset.challengeId); saveSolved(currentUser.uid, solvedSet);
              paintLockState(card, true);
              setTimeout(function(){ if(triviaModal) triviaModal.classList.add('hidden'); if(triviaFeedback) triviaFeedback.textContent=''; }, 600);
            } else {
              setTimeout(function(){ if(triviaFeedback) triviaFeedback.textContent=''; }, 1200);
            }
          };
          triviaOpts.appendChild(btn);
        })(arr[i]);
      }
      triviaModal.classList.remove('hidden');
    }
    var triviaClose=$("trivia-close"); if(triviaClose) triviaClose.addEventListener('click', function(){ if(triviaModal) triviaModal.classList.add('hidden'); if(triviaOpts) triviaOpts.innerHTML=''; if(triviaFeedback) triviaFeedback.textContent=''; });

    // Social: follow/amigos
    async function followUser(uid, uData){
      if(uid===currentUser.uid) return;
      try{
        await setDoc(doc(db,'users',currentUser.uid,'following',uid),{createdAt:serverTimestamp(), displayName:uData && uData.displayName || null, photoURL:uData && uData.photoURL || null});
        await setDoc(doc(db,'users',uid,'followers',currentUser.uid),{createdAt:serverTimestamp(), displayName:currentUser.displayName||null, photoURL:currentUser.photoURL||null});
        toastMsg('Siguiendo ‚úî');
      }catch(e){ console.error(e); toastMsg('No se pudo seguir','error'); }
    }
    async function unfollowUser(uid){
      try{
        await deleteDoc(doc(db,'users',currentUser.uid,'following',uid));
        await deleteDoc(doc(db,'users',uid,'followers',currentUser.uid));
        toastMsg('Dejaste de seguir');
      }catch(e){ console.error(e); toastMsg('No se pudo dejar de seguir','error'); }
    }
    async function removeFollower(uid){
      try{
        await deleteDoc(doc(db,'users',currentUser.uid,'followers',uid));
        await deleteDoc(doc(db,'users',uid,'following',currentUser.uid));
        toastMsg('Seguidor eliminado');
      }catch(e){ console.error(e); toastMsg('No se pudo eliminar seguidor','error'); }
    }
    async function sendFriendRequest(target){
      if(target===currentUser.uid) return;
      try{
        await setDoc(doc(db,'users',target,'friendRequests',currentUser.uid),{fromUid:currentUser.uid, displayName:currentUser.displayName||null, photoURL:currentUser.photoURL||null, createdAt:serverTimestamp()});
        await setDoc(doc(db,'users',currentUser.uid,'sentRequests',target),{toUid:target, createdAt:serverTimestamp()});
        toastMsg('Solicitud enviada');
      }catch(e){ console.error(e); toastMsg('No se pudo enviar solicitud','error'); }
    }
    async function cancelFriendRequest(target){
      try{
        await deleteDoc(doc(db,'users',target,'friendRequests',currentUser.uid));
        await deleteDoc(doc(db,'users',currentUser.uid,'sentRequests',target));
        toastMsg('Solicitud cancelada');
      }catch(e){ console.error(e); toastMsg('No se pudo cancelar','error'); }
    }
    async function acceptFriendRequest(fromUid){
      try{
        var batch=writeBatch(db);
        batch.delete(doc(db,'users',currentUser.uid,'friendRequests',fromUid));
        batch.set(doc(db,'users',currentUser.uid,'friends',fromUid), {since:serverTimestamp()});
        batch.set(doc(db,'users',fromUid,'friends',currentUser.uid), {since:serverTimestamp()});
        batch.delete(doc(db,'users',fromUid,'sentRequests',currentUser.uid));
        await batch.commit();
        toastMsg('Ahora son amigos ‚úî');
      }catch(e){ console.error(e); toastMsg('No se pudo aceptar','error'); }
    }
    async function declineFriendRequest(fromUid){
      try{
        await deleteDoc(doc(db,'users',currentUser.uid,'friendRequests',fromUid));
        try{ await deleteDoc(doc(db,'users',fromUid,'sentRequests',currentUser.uid)); }catch(_){}
        toastMsg('Solicitud rechazada');
      }catch(e){ console.error(e); toastMsg('No se pudo rechazar','error'); }
    }
    async function removeFriend(uid){
      try{
        var batch=writeBatch(db);
        batch.delete(doc(db,'users',currentUser.uid,'friends',uid));
        batch.delete(doc(db,'users',uid,'friends',currentUser.uid));
        await batch.commit();
        toastMsg('Amigo eliminado');
      }catch(e){ console.error(e); toastMsg('No se pudo eliminar amigo','error'); }
    }

    var friendsResults=$("friends-results"), friendsList=$("friends-list"), requestsList=$("requests-list"), followersList=$("followers-list");
    function setActiveTab(tab){
      var btns=document.querySelectorAll('.tab-btn');
      for(var i=0;i<btns.length;i++){
        var b=btns[i];
        var match=b.getAttribute('data-tab')===tab;
        b.classList.toggle('active', match);
        b.classList.toggle('text-slate-500', !match);
      }
      var tabs=['buscar','mis-amigos','solicitudes','seguidores'];
      for(var j=0;j<tabs.length;j++){
        var tId="tab-"+tabs[j];
        var el=$(tId);
        if(el) el.classList.toggle('hidden', tabs[j]!==tab);
      }
      if(tab==='buscar') renderFriendsSearch();
      if(tab==='mis-amigos') renderMyFriends();
      if(tab==='solicitudes') renderFriendRequests();
      if(tab==='seguidores') renderFollowers();
    }
    var tbBtns=document.querySelectorAll('.tab-btn');
    for(var iB=0;iB<tbBtns.length;iB++){
      tbBtns[iB].addEventListener('click', function(){ setActiveTab(this.getAttribute('data-tab')); });
    }

    async function fetchUsersFor(ids){
      var out=[];
      for(var i=0;i<ids.length;i++){
        var uid=ids[i];
        try{
          var d=await getDoc(doc(db,'users',uid));
          if(d && d.exists()) out.push({uid:uid, ...d.data()});
          else out.push({uid:uid, displayName:'(Usuario)', photoURL:''});
        }catch(_){
          out.push({uid:uid, displayName:'(Usuario)', photoURL:''});
        }
      }
      return out;
    }

    async function renderFriendsSearch(){
      if(!friendsResults) return;
      var input=$("user-search-input");
      var term = input && input.value ? input.value.toLowerCase().trim() : '';
      friendsResults.innerHTML='';
      var results=new Map();
      try{
        if(term && term.indexOf('@')>=0){
          var qEmail=query(collection(db,'users'), where('emailLower','==',term), limit(25));
          var s1=await getDocs(qEmail); s1.forEach(function(d){ results.set(d.id,{uid:d.id,...d.data()}); });
        } else if(term){
          var qName=query(collection(db,'users'), orderBy('displayNameLower'), startAt(term), endAt(term+'\uf8ff'), limit(50));
          var s2=await getDocs(qName); s2.forEach(function(d){ results.set(d.id,{uid:d.id,...d.data()}); });
        } else {
          var qUsers=query(collection(db,'users'), orderBy('displayNameLower'), limit(40));
          var s3=await getDocs(qUsers); s3.forEach(function(d){ results.set(d.id,{uid:d.id,...d.data()}); });
        }
      }catch(e){ console.error('search users',e); }

      if(results.size===0){
        friendsResults.innerHTML='<p class="text-slate-500 text-center mt-4">No se encontraron usuarios.</p>';
        return;
      }

      var arr=Array.from(results.values());
      for(var i=0;i<arr.length;i++){
        var u=arr[i];
        var row=document.createElement('div'); row.className='flex items-center justify-between p-2 rounded-lg hover:bg-slate-100';
        row.innerHTML='<div class="flex items-center space-x-3">'+
          '<img class="w-10 h-10 rounded-full" src="'+(u.photoURL||'')+'">'+
          '<div class="flex flex-col"><p class="font-semibold text-slate-700">'+(u.displayName||'(Sin nombre)')+'</p><p class="text-xs text-slate-500">'+(u.email||'')+'</p></div>'+
        '</div>';
        var actions=document.createElement('div'); actions.className='flex items-center gap-2';

        var isSelf = u.uid===currentUser.uid;
        var isFriend = friendsSet.has(u.uid);
        var sent = sentReqSet.has(u.uid);
        var incoming = incomingReqSet.has(u.uid);
        var isFollowing = followingSet.has(u.uid);

        if(isSelf){
          var tag=document.createElement('span'); tag.className='text-xs text-slate-500'; tag.textContent='Vos';
          actions.appendChild(tag);
        } else if(isFriend){
          (function(uCopy){
            var btnFollow=document.createElement('button');
            btnFollow.className='px-3 py-1 rounded-full text-sm '+(isFollowing?'bg-green-600 text-white':'bg-slate-200 text-slate-800');
            btnFollow.textContent=isFollowing?'Siguiendo':'Seguir';
            btnFollow.onclick=function(){ isFollowing ? unfollowUser(uCopy.uid) : followUser(uCopy.uid, uCopy); };
            actions.appendChild(btnFollow);
          })(u);

          (function(uCopy){
            var btnUnfriend=document.createElement('button');
            btnUnfriend.className='px-3 py-1 rounded-full text-sm bg-red-100 text-red-700';
            btnUnfriend.textContent='Eliminar amigo';
            btnUnfriend.onclick=function(){ removeFriend(uCopy.uid); };
            actions.appendChild(btnUnfriend);
          })(u);

        } else if(incoming){
          (function(uCopy){
            var btnAcc=document.createElement('button'); btnAcc.className='px-3 py-1 rounded-full text-sm bg-green-600 text-white'; btnAcc.textContent='Aceptar'; btnAcc.onclick=function(){ acceptFriendRequest(uCopy.uid); };
            var btnRej=document.createElement('button'); btnRej.className='px-3 py-1 rounded-full text-sm bg-slate-200 text-slate-800'; btnRej.textContent='Rechazar'; btnRej.onclick=function(){ declineFriendRequest(uCopy.uid); };
            actions.appendChild(btnAcc); actions.appendChild(btnRej);
          })(u);

        } else if(sent){
          (function(uCopy){
            var btnCancel=document.createElement('button'); btnCancel.className='px-3 py-1 rounded-full text-sm bg-slate-200 text-slate-800'; btnCancel.textContent='Cancelar solicitud'; btnCancel.onclick=function(){ cancelFriendRequest(uCopy.uid); };
            actions.appendChild(btnCancel);
          })(u);

        } else {
          (function(uCopy){
            var btnReq=document.createElement('button'); btnReq.className='px-3 py-1 rounded-full text-sm bg-indigo-600 text-white'; btnReq.textContent='Enviar solicitud'; btnReq.onclick=function(){ sendFriendRequest(uCopy.uid); };
            actions.appendChild(btnReq);
          })(u);
        }

        row.appendChild(actions);
        friendsResults.appendChild(row);
      }
    }
    var userSearchInput = $("user-search-input");
    if(userSearchInput) userSearchInput.addEventListener('input', function(){ renderFriendsSearch(); });

    async function renderMyFriends(){
      var el=$("friends-list"); if(!el){ return; }
      el.innerHTML='';
      if(friendsSet.size===0){ el.innerHTML='<p class="text-slate-500 text-center mt-4">A√∫n no ten√©s amigos.</p>'; return; }
      var users = await fetchUsersFor(Array.from(friendsSet));
      for(var i=0;i<users.length;i++){
        (function(u){
          var row=document.createElement('div'); row.className='flex items-center justify-between p-2 rounded-lg hover:bg-slate-100';
          row.innerHTML='<div class="flex items-center space-x-3"><img class="w-10 h-10 rounded-full" src="'+(u.photoURL||'')+'"><p class="font-semibold text-slate-700">'+(u.displayName||'(Sin nombre)')+'</p></div>';
          var actions=document.createElement('div'); actions.className='flex items-center gap-2';
          var isFollowing = followingSet.has(u.uid);

          var btnFollow=document.createElement('button');
          btnFollow.className='px-3 py-1 rounded-full text-sm '+(isFollowing?'bg-green-600 text-white':'bg-slate-200 text-slate-800');
          btnFollow.textContent=isFollowing?'Siguiendo':'Seguir';
          btnFollow.onclick=function(){ isFollowing ? unfollowUser(u.uid) : followUser(u.uid, u); };
          actions.appendChild(btnFollow);

          var btnUnfriend=document.createElement('button');
          btnUnfriend.className='px-3 py-1 rounded-full text-sm bg-red-100 text-red-700';
          btnUnfriend.textContent='Eliminar amigo';
          btnUnfriend.onclick=function(){ removeFriend(u.uid); };
          actions.appendChild(btnUnfriend);

          row.appendChild(actions);
          el.appendChild(row);
        })(users[i]);
      }
    }

    async function renderFriendRequests(){
      var el=$("requests-list"); if(!el) return;
      el.innerHTML='';
      if(incomingReqSet.size===0){ el.innerHTML='<p class="text-slate-500 text-center mt-4">No ten√©s solicitudes pendientes.</p>'; return; }
      var users = await fetchUsersFor(Array.from(incomingReqSet));
      for(var i=0;i<users.length;i++){
        (function(u){
          var row=document.createElement('div'); row.className='flex items-center justify-between p-2 rounded-lg hover:bg-slate-100';
          row.innerHTML='<div class="flex items-center space-x-3"><img class="w-10 h-10 rounded-full" src="'+(u.photoURL||'')+'"><p class="font-semibold text-slate-700">'+(u.displayName||'(Usuario)')+'</p></div>';
          var actions=document.createElement('div'); actions.className='flex items-center gap-2';
          var btnAcc=document.createElement('button'); btnAcc.className='px-3 py-1 rounded-full text-sm bg-green-600 text-white'; btnAcc.textContent='Aceptar'; btnAcc.onclick=function(){ acceptFriendRequest(u.uid); };
          var btnRej=document.createElement('button'); btnRej.className='px-3 py-1 rounded-full text-sm bg-slate-200 text-slate-800'; btnRej.textContent='Rechazar'; btnRej.onclick=function(){ declineFriendRequest(u.uid); };
          actions.appendChild(btnAcc); actions.appendChild(btnRej);
          row.appendChild(actions); el.appendChild(row);
        })(users[i]);
      }
    }

    async function renderFollowers(){
      var el=$("followers-list"); if(!el) return;
      el.innerHTML='';
      if(followersSet.size===0){ el.innerHTML='<p class="text-slate-500 text-center mt-4">A√∫n no ten√©s seguidores.</p>'; return; }
      var users = await fetchUsersFor(Array.from(followersSet));
      for(var i=0;i<users.length;i++){
        (function(u){
          var row=document.createElement('div'); row.className='flex items-center justify-between p-2 rounded-lg hover:bg-slate-100';
          row.innerHTML='<div class="flex items-center space-x-3"><img class="w-10 h-10 rounded-full" src="'+(u.photoURL||'')+'"><p class="font-semibold text-slate-700">'+(u.displayName||'(Usuario)')+'</p></div>';
          var actions=document.createElement('div'); actions.className='flex items-center gap-2';
          var btnRemove=document.createElement('button'); btnRemove.className='px-3 py-1 rounded-full text-sm bg-red-100 text-red-700'; btnRemove.textContent='Eliminar seguidor'; btnRemove.onclick=function(){ removeFollower(u.uid); };
          actions.appendChild(btnRemove);
          row.appendChild(actions); el.appendChild(row);
        })(users[i]);
      }
    }

    // ---- Navegaci√≥n principal + acciones en feed ----
    var views={'feed-view':$("feed-view"),'friends-view':$("friends-view"),'create-view':$("create-view"),'profile-view':$("profile-view")};
    function switchView(v){
      var keys=Object.keys(views);
      for(var i=0;i<keys.length;i++){ var el=views[keys[i]]; if(el) el.classList.add('hidden'); }
      if(views[v]) views[v].classList.remove('hidden');

      var navBtns=document.querySelectorAll('.nav-button');
      for(var j=0;j<navBtns.length;j++){
        var nb=navBtns[j];
        var isActive = nb.getAttribute('data-view')===v;
        nb.classList.toggle('text-indigo-500', isActive);
        nb.classList.toggle('text-slate-500', !isActive);
      }
      if(v==='profile-view') refreshProfile();
      if(v==='friends-view') setActiveTab('buscar');
    }

    document.addEventListener('click', function(e){
      var navBtn = e.target.closest ? e.target.closest('.nav-button') : null;
      if(navBtn && navBtn.dataset && navBtn.dataset.view){
        e.preventDefault(); switchView(navBtn.dataset.view); return;
      }

      var card = e.target.closest ? e.target.closest('.post-card') : null;
      if(!card) return;
      var chId = card.dataset.challengeId;

      if(e.target.closest && e.target.closest('.comment-button')){ openComments(chId); return; }
      if(e.target.closest && e.target.closest('.like-button')){
        (async function(){
          try{
            await updateDoc(doc(db,'challenges',chId),{likesCount:increment(1)});
            var span=card.querySelector('.likes-count');
            if(span) span.textContent=String((parseInt(span.textContent||'0',10))+1);
          }catch(err){ console.error(err); toastMsg('No se pudo like','error'); }
        })();
        return;
      }

      var img=card.querySelector('.content-img'); 
      var locked = img && img.classList.contains('locked');
      if(!locked) return;

      (async function(){
        var d = await getDoc(doc(db,'challenges',chId));
        if(!(d && d.exists())) { toastMsg('El reto ya no existe','error'); return; }
        var data=d.data();
        if(data.type==='trivia'){ openTrivia(data, card); }
        else if(data.type==='photo'){
          var dataUrl = await captureWithModal();
          if(!dataUrl){ toastMsg('No se envi√≥ la foto','error'); return; }
          solvedSet.add(chId); saveSolved(currentUser.uid,solvedSet); paintLockState(card,true); toastMsg('Enviado. Desbloqueado üëå','success');
        } else { solvedSet.add(chId); saveSolved(currentUser.uid,solvedSet); paintLockState(card,true); }
      })();
    });

    document.addEventListener('click', function(e){
      var pc = e.target.closest ? e.target.closest('.post-card') : null;
      if(pc){ localStorage.setItem('tereto_tip_seen','1'); var ft=$("feed-tip"); if(ft) ft.classList.add('hidden'); }
    });

    // ---- Auth state ----
    onAuthStateChanged(auth, async function(user){
      clearSubs();
      if(!user){
        currentUser=null;
        var as=$("app-screen"), ls=$("login-screen");
        if(as) as.classList.add("hidden");
        if(ls) ls.classList.remove("hidden");
        return;
      }
      currentUser=user;
      var ls2=$("login-screen"), as2=$("app-screen");
      if(ls2) ls2.classList.add("hidden");
      if(as2) as2.classList.remove("hidden");

      await upsertUserWithTerms(user);

      solvedSet=loadSolved(user.uid);
      subFriends(); subFollowing(); subFollowers(); subIncomingRequests(); subSentRequests();
      restartFeed(); startMyChallenges(); refreshProfile();
      switchView('feed-view');
    });

    // ---- C√°mara ----
    var camStream=null, camResolve=null;
    var camModal=$("camera-modal"), camVideo=$("cam-video"), camCanvas=$("cam-canvas");
    async function openCamera(){
      try{
        if(!(navigator.mediaDevices && navigator.mediaDevices.getUserMedia)) throw new Error('no camera');
        if(camStream){ camStream.getTracks().forEach(function(t){ t.stop(); }); camStream=null; }
        camStream=await navigator.mediaDevices.getUserMedia({video:{facingMode:'user'},audio:false});
        if(camVideo) camVideo.srcObject=camStream;
        if(camModal) camModal.classList.remove('hidden');
      }catch(e){ console.error(e); toastMsg('No se pudo acceder a la c√°mara','error'); }
    }
    function closeCamera(){
      if(camStream){ camStream.getTracks().forEach(function(t){ t.stop(); }); camStream=null; }
      if(camModal) camModal.classList.add('hidden');
    }
    function capturePhoto(){
      if(!(camVideo && camVideo.videoWidth)) return null;
      var w=camVideo.videoWidth,h=camVideo.videoHeight;
      if(camCanvas){ camCanvas.width=w; camCanvas.height=h; var ctx=camCanvas.getContext('2d'); ctx.drawImage(camVideo,0,0,w,h); return camCanvas.toDataURL('image/jpeg',0.8); }
      return null;
    }
    var camClose=$("cam-close"); if(camClose) camClose.addEventListener('click', function(){ closeCamera(); if(camResolve) camResolve(null); camResolve=null; });
    var camCap=$("cam-capture"); if(camCap) camCap.addEventListener('click', function(){ var dataUrl=capturePhoto(); closeCamera(); if(camResolve) camResolve(dataUrl); camResolve=null; });
    function captureWithModal(){ return new Promise(async function(res){ camResolve=res; await openCamera(); }); }
  </script>
</body>
</html>
