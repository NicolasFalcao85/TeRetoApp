<script type="module">
  import { initializeApp } from "https://www.gstatic.com/firebasejs/11.0.1/firebase-app.js";
  import { getAuth, GoogleAuthProvider, signInWithPopup, signOut, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.0.1/firebase-auth.js";
  import {
    getFirestore, doc, setDoc, addDoc, updateDoc, getDoc,
    collection, collectionGroup, query, where, orderBy, onSnapshot, serverTimestamp, deleteDoc
  } from "https://www.gstatic.com/firebasejs/11.0.1/firebase-firestore.js";
  import {
    getStorage, ref as storageRef, uploadString, getDownloadURL
  } from "https://www.gstatic.com/firebasejs/11.0.1/firebase-storage.js";

  // === CONFIG FIREBASE (PROD) ===
  const firebaseConfig = {
    apiKey: "AIzaSyCSdjAdY7ymmOwIN7zApP-XpXxTar_0pHk",
    authDomain: "tereto-prod.firebaseapp.com",
    projectId: "tereto-prod",
    storageBucket: "tereto-prod.firebasestorage.app",
    messagingSenderId: "914605096619",
    appId: "1:914605096619:web:88a9b78eac50c35cb181ee"
  };

  // Init
  const app = initializeApp(firebaseConfig);
  const auth = getAuth(app);
  const provider = new GoogleAuthProvider();
  provider.setCustomParameters({ prompt: "select_account" });

  const db = getFirestore(app);
  const storage = getStorage(app);

  // Helpers UI
  const $ = id => document.getElementById(id);
  function showToast(msg, type='success'){
    const toastEl = $("toast"), toastMessage = $("toast-message"), toastIcon = $("toast-icon");
    toastMessage.textContent=msg;
    toastIcon.innerHTML = type==='success'
      ? `<svg class="w-5 h-5" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M16.707 5.293a1 1 0 010 1.414l-8 8a1 1 0 01-1.414 0l-4-4a1 1 0 011.414-1.414L8 12.586l7.293-7.293a1 1 0 011.414 0z" clip-rule="evenodd"/></svg>`
      : `<svg class="w-5 h-5" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zM8.707 7.293a1 1 0 10-1.414 1.414L8.586 10l-1.293 1.293a1 1 0 101.414 1.414L10 11.414l1.293 1.293a1 1 0 001.414-1.414L11.414 10l1.293-1.293a1 1 0 00-1.414-1.414L10 8.586 8.707 7.293z" clip-rule="evenodd"/></svg>`;
    toastIcon.className = `inline-flex items-center justify-center flex-shrink-0 w-8 h-8 rounded-lg ${type==='success'?'text-green-500 bg-green-100':'text-red-500 bg-red-100'}`;
    toastEl.classList.add('show'); setTimeout(()=>toastEl.classList.remove('show'),2600);
  }

  // Estado
  let currentUser = null;
  let solvedSet = new Set();
  let challengeCache = new Map();

  // Vistas/Nav
  const views = {
    'feed-view': $("feed-view"),
    'create-view': $("create-view"),
    'profile-view': $("profile-view"),
    'friends-view': $("friends-view")
  };
  function switchView(viewName){
    Object.values(views).forEach(v=>v.classList.add('hidden'));
    if (views[viewName]) views[viewName].classList.remove('hidden');
    document.querySelectorAll('.nav-button').forEach(btn=>{
      btn.classList.toggle('text-indigo-500', btn.dataset.view === viewName);
      btn.classList.toggle('text-slate-500', btn.dataset.view !== viewName);
    });
    if(viewName==='profile-view'){ updateProfileUI(); }
  }
  document.querySelectorAll('.nav-button').forEach(btn=>btn.addEventListener('click',()=>switchView(btn.dataset.view)));

  // Auth
  $("google-btn")?.addEventListener("click", async ()=>{
    try{ $("loading-spinner").classList.remove("hidden"); await signInWithPopup(auth, provider); }
    catch(err){ console.error(err); showToast(err.code?.replace("auth/","") || "Error al iniciar sesión","error"); }
    finally{ $("loading-spinner").classList.add("hidden"); }
  });
  $("signout-btn")?.addEventListener("click", async ()=>{
    try{ await signOut(auth); showToast("Sesión cerrada."); }
    catch(err){ console.error(err); showToast("No se pudo cerrar sesión","error"); }
  });

  // Upsert user
  async function upsertUser(user){
    await setDoc(doc(db,"users",user.uid),{
      uid:user.uid, displayName:user.displayName||"Usuario", email:user.email||"",
      photoURL:user.photoURL||"", lastSeen:serverTimestamp(), createdAt:serverTimestamp()
    },{merge:true});
  }

  // --- AMIGOS (idéntico a la versión anterior) ---
  let friendMap = new Map(), usersCache=[], unsubUsers=null;
  function pairId(a,b){ return [a,b].sort().join('_'); }
  function startFriendshipsListener(){
    if(!currentUser) return;
    const qF = query(collection(db,'friendships'), where('users','array-contains', currentUser.uid));
    return onSnapshot(qF, (snap)=>{
      friendMap.clear();
      snap.forEach(d=>{
        const fr = d.data(); const other = fr.users.find(u=>u!==currentUser.uid);
        friendMap.set(other, { status: fr.status, requestedBy: fr.requestedBy, requestedTo: fr.requestedTo });
      });
      renderUsersListCached();
    });
  }
  async function sendFriendRequest(otherUid){
    const id = pairId(currentUser.uid, otherUid);
    await setDoc(doc(db,'friendships', id), {
      users: [currentUser.uid, otherUid], status: 'pending',
      requestedBy: currentUser.uid, requestedTo: otherUid,
      createdAt: serverTimestamp(), updatedAt: serverTimestamp()
    }, { merge: true });
    showToast("Solicitud enviada ✅");
  }
  async function acceptFriendRequest(otherUid){
    const id = pairId(currentUser.uid, otherUid);
    await updateDoc(doc(db,'friendships', id), { status:'accepted', updatedAt: serverTimestamp() });
    showToast("Ahora son amigos 🤝");
  }
  async function rejectFriendRequest(otherUid){
    const id = pairId(currentUser.uid, otherUid);
    await deleteDoc(doc(db,'friendships', id));
    showToast("Solicitud rechazada");
  }
  const usersListEl = $("friends-tab-content");
  const usersSearchEl = $("user-search-input");
  function startUsersSubscription(){
    if(unsubUsers) unsubUsers();
    const qUsers = query(collection(db,'users'));
    unsubUsers = onSnapshot(qUsers,(snap)=>{
      usersCache = [];
      snap.forEach(d=>{ const u=d.data(); if(!currentUser || u.uid !== currentUser.uid) usersCache.push(u); });
      renderUsersListCached();
    });
    usersSearchEl?.addEventListener('input', renderUsersListCached);
  }
  function renderUsersListCached(){
    const term = (usersSearchEl?.value||'').toLowerCase();
    usersListEl.innerHTML = '';
    const filtered = usersCache.filter(u=>{
      const s=(u.displayName||u.email||'').toLowerCase();
      return !term || s.includes(term);
    });
    if(filtered.length===0){ usersListEl.innerHTML = `<p class="text-slate-500 text-center mt-4">No hay usuarios.</p>`; return; }
    filtered.forEach(u=>{
      const state = friendMap.get(u.uid);
      const row = document.createElement('div');
      row.className = "flex items-center justify-between p-2 rounded-lg hover:bg-slate-100";
      row.innerHTML = `
        <div class="flex items-center space-x-3">
          <img class="w-10 h-10 rounded-full" src="${u.photoURL || 'https://placehold.co/40x40?text=U'}">
          <div>
            <p class="font-semibold text-slate-700">${u.displayName || 'Usuario'}</p>
            <p class="text-xs text-slate-400">${u.email || ''}</p>
          </div>
        </div>
        <div class="flex items-center gap-2">
          ${!state
            ? `<button data-action="add" data-uid="${u.uid}" class="btn-xs bg-indigo-600 text-white">Agregar</button>`
            : state.status==='accepted'
              ? `<span class="pill bg-green-100 text-green-700">Amigos ✓</span>`
              : state.requestedBy===currentUser.uid
                ? `<span class="pill bg-slate-200 text-slate-600">Pendiente…</span>`
                : `
                  <button data-action="accept" data-uid="${u.uid}" class="btn-xs bg-green-600 text-white">Aceptar</button>
                  <button data-action="reject" data-uid="${u.uid}" class="btn-xs bg-slate-200 text-slate-700">Rechazar</button>`
          }
        </div>`;
      usersListEl.appendChild(row);
    });
  }
  usersListEl?.addEventListener('click', async (e)=>{
    const btn = e.target.closest('button'); if(!btn) return;
    const uid = btn.dataset.uid, action = btn.dataset.action;
    try{
      if(action==='add') await sendFriendRequest(uid);
      if(action==='accept') await acceptFriendRequest(uid);
      if(action==='reject') await rejectFriendRequest(uid);
    }catch(err){ console.error(err); showToast("No se pudo actualizar la solicitud","error"); }
  });

  // SOLVED
  let unsubSolved=null;
  function startSolvedListener(){
    if(unsubSolved) unsubSolved();
    unsubSolved = onSnapshot(collection(db,'users', currentUser.uid, 'solved'), (snap)=>{
      const s = new Set(); snap.forEach(d=>s.add(d.id));
      solvedSet = s; updateSolvedCount(); refreshUnlockStates();
    });
  }
  function updateSolvedCount(){ $("solved-count").textContent = solvedSet.size; }
  async function markSolvedRemote(challengeId){
    await setDoc(doc(db,'users', currentUser.uid, 'solved', challengeId), { challengeId, solvedAt: serverTimestamp() }, { merge: true });
  }
  function refreshUnlockStates(){
    document.querySelectorAll('.post-card').forEach(card=>{
      const id = card.dataset.challengeId;
      const author = card.dataset.authorUid;
      const unlock = (currentUser && id && (author===currentUser.uid || solvedSet.has(id)));
      const img = card.querySelector('.content-img');
      const lock = card.querySelector('.lock-overlay');
      if(unlock){ img?.classList.remove('blur-locked'); lock?.classList.add('hidden'); }
      else { img?.classList.add('blur-locked'); lock?.classList.remove('hidden'); }
    });
  }

  // FEED
  let unsubChallenges=null, unsubValidations=null, unsubCommentsModal=null, perChallengeUnsubs={};
  function clearPerChallengeUnsubs(){
    Object.values(perChallengeUnsubs).forEach(arr=>arr.forEach(fn=>fn && fn()));
    perChallengeUnsubs = {};
  }
  function renderChallengeCard(id, ch){
    const tpl = $("post-template").content.cloneNode(true);
    const card = tpl.querySelector('.post-card');
    card.dataset.challengeId = id;
    card.dataset.authorUid = ch.authorUid;
    tpl.querySelector('.author-img').src = ch.authorPhoto || 'https://placehold.co/40x40?text=U';
    tpl.querySelector('.author-name').textContent = ch.authorName || 'Usuario';
    const ts = ch.createdAt?.toDate ? ch.createdAt.toDate() : new Date();
    tpl.querySelector('.post-time').textContent = ts.toLocaleString('es-AR',{dateStyle:'short', timeStyle:'short'});
    const src = ch.contentUrl || ch.contentDataUrl || 'https://placehold.co/600x400/cccccc/000?text=TeReto';
    tpl.querySelector('.content-img').src = src;
    if (ch.type === 'photo') tpl.querySelector('.lock-icon').textContent = '📸';
    $("feed-container").appendChild(tpl);

    // live likes/comments
    const likesEl = document.querySelector(`.post-card[data-challenge-id="${id}"] .likes-count`);
    const likeIcon = document.querySelector(`.post-card[data-challenge-id="${id}"] .like-icon`);
    const commentsCountEl = document.querySelector(`.post-card[data-challenge-id="${id}"] .comments-count`);

    const unlikes = onSnapshot(collection(db,'challenges',id,'likes'), (snap)=>{
      likesEl.textContent = snap.size;
      const liked = currentUser ? snap.docs.some(d=>d.id===currentUser.uid) : false;
      likeIcon.classList.toggle('liked', liked);
    });
    const uncomments = onSnapshot(collection(db,'challenges',id,'comments'), (snap)=>{
      commentsCountEl.textContent = snap.size;
    });
    (perChallengeUnsubs[id] ||= []).push(unlikes, uncomments);
  }
  function startChallengesListener(){
    if(unsubChallenges) unsubChallenges();
    clearPerChallengeUnsubs();
    const q = query(collection(db,'challenges'), orderBy('createdAt','desc'));
    unsubChallenges = onSnapshot(q, (snap)=>{
      const feed = $("feed-container");
      const empty = $("feed-empty");
      feed.innerHTML = ""; challengeCache.clear();
      if(snap.empty){ empty.classList.remove('hidden'); }
      else{
        empty.classList.add('hidden');
        snap.forEach(docSnap=>{
          const ch = { id: docSnap.id, ...docSnap.data() };
          challengeCache.set(docSnap.id, ch);
          renderChallengeCard(docSnap.id, ch);
        });
      }
      refreshUnlockStates();
    }, (err)=>{
      console.error(err);
      $("feed-container").innerHTML = "";
      $("feed-empty").classList.remove('hidden');
      showToast("No se pudo cargar el feed (revisa reglas).","error");
    });
  }
  async function toggleLike(challengeId){
    const likeRef = doc(db,'challenges', challengeId, 'likes', currentUser.uid);
    const snap = await getDoc(likeRef);
    if(snap.exists()) await deleteDoc(likeRef);
    else await setDoc(likeRef, { uid: currentUser.uid, likedAt: serverTimestamp() });
  }

  // Comentarios
  function openCommentsModal(challengeId){
    if(unsubCommentsModal){ unsubCommentsModal(); unsubCommentsModal=null; }
    const body = $("comments-modal-body");
    body.innerHTML = "";
    $("comment-user-img").src = currentUser?.photoURL || 'https://placehold.co/40x40?text=U';
    $("comment-form").dataset.challengeId = challengeId;
    const q = query(collection(db,'challenges',challengeId,'comments'), orderBy('createdAt','asc'));
    unsubCommentsModal = onSnapshot(q,(snap)=>{
      body.innerHTML = "";
      snap.forEach(d=>{
        const c = d.data();
        const row = document.createElement('div');
        row.className = "flex items-start space-x-3";
        row.innerHTML = `
          <img class="w-8 h-8 rounded-full" src="${c.userPhoto || 'https://placehold.co/40x40?text=U'}">
          <div class="flex-1 bg-slate-100 rounded-xl p-3">
            <p class="text-sm"><strong class="text-slate-800">${c.userName || 'Usuario'}</strong> <span class="text-slate-600">${c.text || ''}</span></p>
            <p class="text-xs text-slate-400 mt-1">${c.createdAt?.toDate? c.createdAt.toDate().toLocaleTimeString('es-AR'):''}</p>
          </div>`;
        body.appendChild(row);
      });
    });
    $("comments-modal").classList.remove('hidden');
  }
  $("comment-form")?.addEventListener('submit', async (e)=>{
    e.preventDefault();
    const challengeId = e.target.dataset.challengeId;
    const text = $("comment-input").value.trim();
    if(!text) return;
    try{
      await addDoc(collection(db,'challenges',challengeId,'comments'),{
        userUid: currentUser.uid,
        userName: currentUser.displayName || 'Usuario',
        userPhoto: currentUser.photoURL || '',
        text, createdAt: serverTimestamp()
      });
      $("comment-input").value = '';
    }catch(err){ console.error(err); showToast("No se pudo comentar","error"); }
  });
  $("close-comments-modal")?.addEventListener('click', ()=>{ $("comments-modal").classList.add('hidden'); if(unsubCommentsModal){ unsubCommentsModal(); unsubCommentsModal=null; } });

  // Trivia
  function openTriviaModal(ch){
    $("trivia-modal-question").textContent = ch.question;
    const answersEl = $("trivia-modal-answers");
    answersEl.innerHTML = '';
    const answers = [...(ch.wrongAnswers||[]), ch.correctAnswer].filter(Boolean).sort(()=>Math.random()-0.5);
    answers.forEach(ans=>{
      const b = document.createElement('button');
      b.className = 'bg-slate-100 hover:bg-indigo-100 text-slate-800 font-semibold py-3 px-4 border border-slate-300 rounded-lg shadow-sm';
      b.textContent = ans;
      b.onclick = async ()=>{
        if(ans === ch.correctAnswer){
          $("trivia-modal").classList.add('hidden');
          try{ await markSolvedRemote(ch.id); showToast("¡Correcto! Reto desbloqueado 🎉"); }
          catch(err){ console.error(err); showToast("No se pudo marcar como resuelto","error"); }
        }else{
          $("trivia-feedback").textContent = 'Respuesta incorrecta. ¡Intentalo de nuevo!';
          setTimeout(()=>{$("trivia-feedback").textContent='';},1500);
        }
      };
      answersEl.appendChild(b);
    });
    $("trivia-modal").classList.remove('hidden');
  }
  $("close-trivia-modal")?.addEventListener('click',()=>$("trivia-modal").classList.add('hidden'));

  // Foto challenge (cámara)
  let cameraStream = null, currentPhotoChallengeId = null;
  async function openCamera(challengeId=null){
    currentPhotoChallengeId = challengeId;
    try{
      if(cameraStream) cameraStream.getTracks().forEach(t=>t.stop());
      cameraStream = await navigator.mediaDevices.getUserMedia({ video:{ facingMode:'user' }, audio:false });
      $("camera-stream").srcObject = cameraStream;
      $("camera-modal").classList.remove('hidden');
    }catch(err){ console.error(err); showToast("No se pudo acceder a la cámara","error"); }
  }
  function closeCamera(){ if(cameraStream) cameraStream.getTracks().forEach(t=>t.stop()); cameraStream=null; $("camera-modal").classList.add('hidden'); }
  $("cancel-camera-btn")?.addEventListener('click', closeCamera);
  $("capture-btn")?.addEventListener('click', async ()=>{
    const video = $("camera-stream"), canvas = $("camera-canvas");
    canvas.width = video.videoWidth; canvas.height = video.videoHeight;
    canvas.getContext('2d').drawImage(video,0,0,canvas.width,canvas.height);
    const dataUrl = canvas.toDataURL('image/png');
    closeCamera();
    if(!currentUser || !currentPhotoChallengeId) return;
    const ch = challengeCache.get(currentPhotoChallengeId);
    const submitterUid = currentUser.uid;
    let submissionUrl = null, submissionDataUrl = null;
    try{
      const path = `submissions/${currentPhotoChallengeId}/${submitterUid}/${Date.now()}.png`;
      const ref = storageRef(storage, path);
      await uploadString(ref, dataUrl, 'data_url');
      submissionUrl = await getDownloadURL(ref);
    }catch(e){ submissionDataUrl = dataUrl; }
    try{
      await setDoc(doc(db,'challenges', currentPhotoChallengeId, 'submissions', submitterUid), {
        challengeId: currentPhotoChallengeId, challengeAuthorUid: ch.authorUid,
        challengeQuestion: ch.question || '', submitterUid,
        submitterName: currentUser.displayName || 'Usuario', submitterPhoto: currentUser.photoURL || '',
        submissionUrl, submissionDataUrl, status: 'pending', createdAt: serverTimestamp()
      });
      showToast("Prueba enviada para validación.");
    }catch(err){ console.error(err); showToast("No se pudo enviar la prueba","error"); }
  });
  $("submit-photo-challenge-btn")?.addEventListener('click', ()=>{ const id = $("submit-photo-challenge-btn").dataset.challengeId; $("photo-challenge-modal").classList.add('hidden'); openCamera(id); });
  $("close-photo-challenge-modal")?.addEventListener('click', ()=>$("photo-challenge-modal").classList.add('hidden'));
  function openPhotoChallengeModal(ch){ $("photo-challenge-description").textContent = ch.question || ''; $("submit-photo-challenge-btn").dataset.challengeId = ch.id; $("photo-challenge-modal").classList.remove('hidden'); }

  // --- CREAR RETOS (Arreglo clave: delegación de submit + feedback y bloqueo) ---
  let pendingFileDataUrl = null;
  const fileUpload = $("file-upload"), fileNameDisplay=$("file-name"),
        imagePreviewContainer=$("image-preview-container"), imagePreview=$("image-preview");

  fileUpload?.addEventListener('change', (e)=>{
    if(e.target.files?.length){
      const f = e.target.files[0];
      const rd = new FileReader();
      rd.onload = ev=>{
        pendingFileDataUrl = ev.target.result;
        imagePreview.src = pendingFileDataUrl;
        imagePreviewContainer.classList.remove('hidden');
        fileNameDisplay.textContent = f.name;
      };
      rd.readAsDataURL(f);
    }else{
      pendingFileDataUrl = null;
      imagePreviewContainer.classList.add('hidden');
      fileNameDisplay.textContent = '';
    }
  });

  $("goto-step-2")?.addEventListener('click', ()=>{
    $("create-step-1").classList.add('hidden');
    $("create-step-2").classList.remove('hidden');
  });
  $("select-trivia-btn")?.addEventListener('click', ()=>{
    $("create-step-2").classList.add('hidden');
    $("create-step-3-trivia").classList.remove('hidden');
  });
  $("select-photo-challenge-btn")?.addEventListener('click', ()=>{
    $("create-step-2").classList.add('hidden');
    $("create-step-3-photo").classList.remove('hidden');
  });

  async function uploadChallengeMediaIfAny(){
    if(!pendingFileDataUrl) return { contentUrl:null, contentDataUrl:null };
    try{
      const path = `challenges/${currentUser.uid}/${Date.now()}.png`;
      const ref = storageRef(storage, path);
      await uploadString(ref, pendingFileDataUrl, 'data_url');
      const url = await getDownloadURL(ref);
      return { contentUrl:url, contentDataUrl:null };
    }catch(e){
      return { contentUrl:null, contentDataUrl:pendingFileDataUrl };
    }
  }

  // 🔧 Delegación de submit para que SIEMPRE dispare
  document.addEventListener('submit', async (e)=>{
    const form = e.target;
    // Trivia
    if(form.id === 'trivia-form'){
      e.preventDefault(); e.stopPropagation();
      if(!currentUser) return showToast("Iniciá sesión","error");
      const btn = form.querySelector('button[type="submit"]'); btn.disabled = true; btn.textContent = 'Publicando...';
      try{
        const { contentUrl, contentDataUrl } = await uploadChallengeMediaIfAny();
        const question = $("trivia-question").value.trim();
        const correctAnswer = $("correct-answer").value.trim();
        const wrongAnswers = [ $("wrong-answer-1").value, $("wrong-answer-2").value, $("wrong-answer-3").value ]
          .map(v=>v.trim()).filter(Boolean);
        await addDoc(collection(db,'challenges'),{
          authorUid: currentUser.uid, authorName: currentUser.displayName || 'Usuario',
          authorPhoto: currentUser.photoURL || '', type: 'trivia',
          question, correctAnswer, wrongAnswers, contentUrl, contentDataUrl,
          createdAt: serverTimestamp()
        });
        pendingFileDataUrl = null; imagePreviewContainer.classList.add('hidden'); form.reset();
        showToast("¡Reto creado!");
        switchView('feed-view');
      }catch(err){ console.error(err); showToast("No se pudo crear el reto (revisa reglas).","error"); }
      finally{ btn.disabled = false; btn.textContent = 'Publicar Reto'; }
    }

    // Foto
    if(form.id === 'photo-challenge-form'){
      e.preventDefault(); e.stopPropagation();
      if(!currentUser) return showToast("Iniciá sesión","error");
      const btn = form.querySelector('button[type="submit"]'); btn.disabled = true; btn.textContent = 'Publicando...';
      try{
        const { contentUrl, contentDataUrl } = await uploadChallengeMediaIfAny();
        const question = $("photo-challenge-task").value.trim();
        await addDoc(collection(db,'challenges'),{
          authorUid: currentUser.uid, authorName: currentUser.displayName || 'Usuario',
          authorPhoto: currentUser.photoURL || '', type: 'photo',
          question, contentUrl, contentDataUrl, createdAt: serverTimestamp()
        });
        pendingFileDataUrl = null; imagePreviewContainer.classList.add('hidden'); form.reset();
        showToast("¡Reto creado!");
        switchView('feed-view');
      }catch(err){ console.error(err); showToast("No se pudo crear el reto (revisa reglas).","error"); }
      finally{ btn.disabled = false; btn.textContent = 'Publicar Reto'; }
    }
  });

  // Validaciones (igual que antes)
  function startValidationsListener(){
    if(unsubValidations) unsubValidations();
    if(!currentUser){ $("validations-container").innerHTML=''; return; }
    const q = query(collectionGroup(db,'submissions'), where('challengeAuthorUid','==', currentUser.uid), where('status','==','pending'));
    const box = $("validations-container");
    unsubValidations = onSnapshot(q,(snap)=>{
      box.innerHTML = '';
      const arr = [];
      snap.forEach(d=>{ const s=d.data(); arr.push({refPath:d.ref.path, ...s}); });
      arr.sort((a,b)=>{
        const ta = a.createdAt?.toMillis ? a.createdAt.toMillis() : 0;
        const tb = b.createdAt?.toMillis ? b.createdAt.toMillis() : 0;
        return tb - ta;
      });
      if(arr.length===0) return;
      const header = document.createElement('h3');
      header.className = 'text-xl font-bold text-slate-800 mb-4';
      header.textContent = 'Validaciones Pendientes';
      box.appendChild(header);
      arr.forEach(s=>{
        const el = $("validation-template").content.cloneNode(true);
        el.querySelector('.validation-card').dataset.refPath = s.refPath;
        el.querySelector('.original-challenge-question').textContent = s.challengeQuestion || '';
        el.querySelector('.submitter-name').textContent = s.submitterName || 'Usuario';
        el.querySelector('.submission-img').src = s.submissionUrl || s.submissionDataUrl || 'https://placehold.co/600x400?text=EVIDENCIA';
        box.appendChild(el);
      });
    });
  }
  async function setSubmissionStatus(refPath, status){
    const ref = doc(db, refPath);
    const snap = await getDoc(ref); if(!snap.exists()) return;
    const data = snap.data();
    await updateDoc(ref, { status });
    if(status==='approved' && data.submitterUid && data.challengeId){
      await setDoc(doc(db,'users', data.submitterUid, 'solved', data.challengeId),{
        challengeId: data.challengeId, solvedAt: serverTimestamp(), byApproval:true
      },{merge:true});
    }
  }

  // Delegación clicks global (likes / comments / abrir modales)
  document.addEventListener('click', async (e)=>{
    const card = e.target.closest('.validation-card');
    if(card && (e.target.closest('.approve-btn') || e.target.closest('.reject-btn'))){
      const ok = e.target.closest('.approve-btn') ? 'approved' : 'rejected';
      try{ await setSubmissionStatus(card.dataset.refPath, ok); showToast(ok==='approved'?'Reto aprobado':'Rechazado'); }
      catch(err){ console.error(err); showToast("No se pudo actualizar el envío","error"); }
      return;
    }

    const postCard = e.target.closest('.post-card');
    if(postCard){
      const id = postCard.dataset.challengeId;
      if(e.target.closest('.like-button')){ if(!currentUser) return showToast("Iniciá sesión","error"); await toggleLike(id); return; }
      if(e.target.closest('.comment-button')){ openCommentsModal(id); return; }
      if(e.target.closest('.challenge-container')){
        const ch = challengeCache.get(id);
        if(!ch) return;
        if(ch.type==='trivia') openTriviaModal({ ...ch, id });
        else if(ch.type==='photo') openPhotoChallengeModal({ ...ch, id });
      }
    }
  });

  // Perfil
  function updateProfileUI(){
    $("profile-pic").src = currentUser?.photoURL || 'https://placehold.co/96x96?text=U';
    $("profile-name").textContent = currentUser?.displayName || 'Usuario';
    $("profile-email").textContent = currentUser?.email || '';
    if(currentUser){
      const q = query(collection(db,'challenges'), where('authorUid','==', currentUser.uid));
      onSnapshot(q,(snap)=>{ $("created-count").textContent = snap.size; });
    }
    updateSolvedCount();
  }

  // Auth state
  let unsubFriendships=null;
  onAuthStateChanged(auth, async (user)=>{
    currentUser = user || null;
    if(currentUser){
      $("login-screen").classList.add('hidden');
      $("app-screen").classList.remove('hidden');
      try{ await upsertUser(currentUser); }catch(e){ console.warn('No se pudo upsert user', e); }
      startUsersSubscription();
      if(unsubFriendships) unsubFriendships();
      unsubFriendships = startFriendshipsListener();
      startSolvedListener();
      startValidationsListener();
      startChallengesListener();
      switchView('feed-view');
    }else{
      $("app-screen").classList.add('hidden');
      $("login-screen").classList.remove('hidden');
      if(unsubUsers) unsubUsers();
      if(unsubSolved) unsubSolved();
      if(unsubValidations) unsubValidations();
      if(unsubChallenges) unsubChallenges();
      if(unsubFriendships) unsubFriendships();
      clearPerChallengeUnsubs();
    }
  });
</script>
