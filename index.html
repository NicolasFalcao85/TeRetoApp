<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1.0"/>
  <title>TeReto</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;500;600;700&display=swap" rel="stylesheet">
  <style>
    body { font-family: 'Poppins', sans-serif; }
    .blur-locked { filter: blur(20px); transition: filter .3s ease-in-out; }
    .unlocked { filter: blur(0px); }
    .answer-btn:hover { transform: translateY(-2px); box-shadow: 0 4px 12px rgba(0,0,0,.1); }
    .like-icon.liked { fill:#ec4899; color:#ec4899; }
    .like-button:active { transform: scale(.9); }
    .image-preview { max-height:200px; object-fit:cover; }
    .comments-modal-body { height: calc(100vh - 12rem); }
    .toast { visibility:hidden; opacity:0; transform:translateY(100%); transition:all .5s cubic-bezier(.68,-.55,.27,1.55);}
    .toast.show { visibility:visible; opacity:1; transform:translateY(0); }
    .spinner { border:4px solid rgba(0,0,0,.1); width:36px; height:36px; border-radius:50%; border-left-color:#6366f1; animation:spin 1s ease infinite; }
    @keyframes spin { 0% {transform:rotate(0)} 100% {transform:rotate(360deg)} }
    .friends-tab.active { border-bottom-color:#6366f1; color:#6366f1; font-weight:600; }
    .btn-primary { background-image:linear-gradient(to right,#6366f1,#8b5cf6); transition:all .3s ease; }
    .btn-primary:hover { box-shadow:0 4px 15px 0 rgba(99,102,241,.75); }
    .tip-badge { font-size:10px; letter-spacing:.04em; }
  </style>
</head>
<body class="bg-slate-100 h-screen">

  <!-- SPINNER -->
  <div id="loading-spinner" class="hidden fixed inset-0 bg-slate-100/80 flex items-center justify-center z-[100]">
    <div class="spinner"></div>
  </div>

  <!-- TOAST -->
  <div id="toast" class="toast fixed bottom-24 left-1/2 -translate-x-1/2 flex items-center w-full max-w-xs p-4 text-slate-600 bg-white rounded-xl shadow-2xl z-[90]" role="alert">
    <div id="toast-icon" class="inline-flex items-center justify-center flex-shrink-0 w-8 h-8 rounded-lg"></div>
    <div id="toast-message" class="ml-3 text-sm font-normal"></div>
  </div>

  <!-- LOGIN -->
  <div id="login-screen" class="min-h-screen flex items-center justify-center p-4">
    <div class="w-full max-w-sm bg-white rounded-2xl shadow-2xl p-6">
      <div class="flex items-center justify-center mb-4">
        <svg class="w-10 h-10" viewBox="0 0 32 32" fill="none"><defs><linearGradient id="g1" x1="0" y1="0" x2="32" y2="32"><stop stop-color="#818CF8"/><stop offset="1" stop-color="#C084FC"/></linearGradient></defs><circle cx="16" cy="16" r="12" stroke="url(#g1)" stroke-width="3"/></svg>
        <span class="ml-2 text-2xl font-extrabold bg-gradient-to-r from-indigo-500 to-purple-500 bg-clip-text text-transparent">TeReto</span>
      </div>
      <p class="text-center text-slate-600 mb-6">Ingres√° para continuar</p>
      <button id="google-btn" class="w-full flex items-center justify-center gap-3 border rounded-xl py-3 hover:bg-slate-50">
        <img alt="Google" src="https://www.gstatic.com/firebasejs/ui/2.0.0/images/auth/google.svg" class="w-5 h-5">
        <span class="font-semibold text-slate-700">Continuar con Google</span>
      </button>
      <p class="text-[11px] text-center text-slate-400 mt-4">Al continuar acept√°s los T√©rminos y la Pol√≠tica de Privacidad.</p>
    </div>
  </div>

  <!-- MODALES -->
  <div id="trivia-modal" class="hidden fixed inset-0 bg-black/70 flex items-center justify-center z-50 p-4">
    <div class="bg-white rounded-2xl shadow-2xl p-6 md:p-8 max-w-lg w-full text-center relative">
      <button id="close-trivia-modal" class="absolute top-4 right-4 text-slate-400 hover:text-slate-600">
        <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"/></svg>
      </button>
      <h2 id="trivia-modal-question" class="text-2xl font-bold text-slate-800 mb-6"></h2>
      <div id="trivia-modal-answers" class="grid grid-cols-1 md:grid-cols-2 gap-4"></div>
      <p id="trivia-feedback" class="mt-4 text-red-500 font-semibold h-6"></p>
    </div>
  </div>

  <div id="photo-challenge-modal" class="hidden fixed inset-0 bg-black/70 flex items-center justify-center z-50 p-4">
    <div class="bg-white rounded-2xl shadow-2xl p-6 md:p-8 max-w-lg w-full text-center relative">
      <button id="close-photo-challenge-modal" class="absolute top-4 right-4 text-slate-400 hover:text-slate-600">
        <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"/></svg>
      </button>
      <div class="flex items-center justify-center gap-2 mb-2">
        <span class="uppercase tip-badge px-2 py-1 rounded-full bg-indigo-100 text-indigo-600 font-bold">truco</span>
        <span class="text-xs text-slate-500">si la c√°mara no abre, revis√° permisos del navegador</span>
      </div>
      <div class="text-5xl mb-4">üì∏</div>
      <h2 class="text-2xl font-bold text-slate-800 mb-2">¬°Acepta el Desaf√≠o!</h2>
      <p id="photo-challenge-description" class="text-slate-600 mb-6"></p>
      <button id="submit-photo-challenge-btn" class="w-full text-white font-bold py-3 px-4 rounded-lg btn-primary">Cumplir Reto</button>
    </div>
  </div>

  <div id="comments-modal" class="hidden fixed inset-0 bg-white z-50 flex flex-col">
    <header class="flex items-center justify-between p-4 border-b">
      <h2 class="text-xl font-bold text-slate-800">Comentarios</h2>
      <button id="close-comments-modal" class="text-slate-500 hover:text-slate-800">
        <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"/></svg>
      </button>
    </header>
    <div id="comments-modal-body" class="flex-grow overflow-y-auto p-4 space-y-4 bg-slate-50"></div>
    <footer class="p-4 border-t bg-white">
      <form id="comment-form" class="flex items-center space-x-2">
        <img id="comment-user-img" src="" class="w-8 h-8 rounded-full">
        <input id="comment-input" type="text" placeholder="A√±ade un comentario..." class="flex-grow bg-slate-100 border-slate-200 rounded-full py-2 px-4 focus:outline-none focus:ring-2 focus:ring-indigo-500">
        <button type="submit" class="btn-primary text-white rounded-full p-2">
          <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 19l9 2-9-18-9 18 9-2zm0 0v-8"/></svg>
        </button>
      </form>
    </footer>
  </div>

  <div id="camera-modal" class="hidden fixed inset-0 bg-black z-50 flex flex-col items-center justify-center">
    <video id="camera-stream" class="w-full h-full object-cover" autoplay playsinline></video>
    <canvas id="camera-canvas" class="hidden"></canvas>
    <button id="cancel-camera-btn" class="absolute top-4 left-4 text-white bg-black/50 rounded-full p-2">
      <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"/></svg>
    </button>
    <div class="absolute bottom-10 flex flex-col items-center">
      <button id="capture-btn" class="w-20 h-20 rounded-full bg-white border-4 border-slate-400 hover:border-white focus:outline-none"></button>
    </div>
  </div>

  <!-- APP -->
  <div id="app-screen" class="h-full flex flex-col hidden">
    <main class="flex-grow overflow-y-auto pb-20 bg-slate-100">
      <div id="feed-view">
        <header class="sticky top-0 bg-white/80 backdrop-blur-sm p-4 border-b flex justify-between items-center z-40">
          <div class="flex items-center space-x-2">
            <svg class="w-8 h-8" viewBox="0 0 32 32" fill="none"><defs><linearGradient id="g2" x1="0" y1="0" x2="32" y2="32"><stop stop-color="#818CF8"/><stop offset="1" stop-color="#C084FC"/></linearGradient></defs><circle cx="16" cy="16" r="12" stroke="url(#g2)" stroke-width="3"/></svg>
            <span class="text-xl font-extrabold bg-gradient-to-r from-indigo-500 to-purple-500 bg-clip-text text-transparent">TeReto</span>
          </div>
          <button id="signout-btn" class="text-slate-500 hover:text-indigo-500 text-sm font-semibold">Cerrar sesi√≥n</button>
        </header>
        <div id="feed-container" class="p-2 space-y-4"></div>
      </div>

      <!-- (secciones Create / Friends / Profile igual que antes, omitidas por brevedad) -->
    </main>

    <nav class="fixed bottom-0 left-0 right-0 bg-white/95 backdrop-blur-sm border-t border-slate-200 flex justify-around p-1 z-40">
      <button data-view="feed-view" class="nav-button flex-1 p-2 rounded-lg text-indigo-500 flex flex-col items-center space-y-1">
        <svg class="w-7 h-7" fill="currentColor" viewBox="0 0 20 20"><path d="M10.707 2.293a1 1 0 00-1.414 0l-7 7a1 1 0 001.414 1.414L4 10.414V17a1 1 0 001 1h2a1 1 0 001-1v-2a1 1 0 011-1h2a1 1 0 011 1v2a1 1 0 001 1h2a1 1 0 001-1v-6.586l.293.293a1 1 0 001.414-1.414l-7-7z"/></svg>
        <span class="text-xs font-semibold">Inicio</span>
      </button>
    </nav>
  </div>

  <!-- Templates -->
  <template id="post-template">
    <div class="bg-white rounded-xl shadow-lg overflow-hidden post-card">
      <div class="p-4 flex items-center space-x-3">
        <img class="w-10 h-10 rounded-full author-img" src="" alt="Author">
        <div><p class="font-semibold text-slate-800 author-name"></p><p class="text-xs text-slate-500 post-time"></p></div>
      </div>
      <div class="relative cursor-pointer group challenge-container">
        <img class="w-full h-96 object-cover blur-locked content-img" src="" alt="Contenido del reto">
        <div class="absolute inset-0 bg-black/30 flex flex-col items-center justify-center text-white text-center p-4 lock-overlay">
          <div class="text-5xl mb-2 lock-icon">üîí</div>
          <h3 class="font-bold text-lg">Reto Bloqueado</h3>
          <p class="text-sm mt-1 group-hover:underline">Toca para aceptar el desaf√≠o</p>
        </div>
      </div>
      <div class="p-4">
        <div class="flex items-center justify-between mt-1 text-slate-500">
          <div class="flex space-x-4">
            <button class="like-button flex items-center space-x-1 cursor-pointer">
              <svg class="w-6 h-6 like-icon" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4.318 6.318a4.5 4.5 0 000 6.364L12 20.364l7.682-7.682a4.5 4.5 0 00-6.364-6.364L12 7.636l-1.318-1.318a4.5 4.5 0 00-6.364 0z"/></svg>
              <span class="likes-count">0</span>
            </button>
            <button class="comment-button flex items-center space-x-1 cursor-pointer">
              <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 12h.01M12 12h.01M16 12h.01M21 12c0 4.418-4.03 8-9 8a9.863 9.863 0 01-4.255-.949L3 20l1.395-3.72C3.512 15.042 3 13.574 3 12c0-4.418 4.03-8 9-8s9 3.582 9 8z"/></svg>
              <span class="comments-count">0</span>
            </button>
          </div>
          <span class="text-xs post-time-secondary"></span>
        </div>
      </div>
    </div>
  </template>

  <template id="comment-template">
    <div class="flex items-start space-x-3">
      <img class="w-8 h-8 rounded-full comment-author-img" src="">
      <div class="flex-1 bg-slate-100 rounded-xl p-3">
        <p class="text-sm"><strong class="comment-author-name text-slate-800"></strong> <span class="text-slate-600 comment-text"></span></p>
        <p class="text-xs text-slate-400 mt-1 comment-time"></p>
      </div>
    </div>
  </template>

  <!-- Firebase (App/Auth/Firestore) -->
  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/11.0.1/firebase-app.js";
    import { getAuth, GoogleAuthProvider, signInWithPopup, signOut, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.0.1/firebase-auth.js";
    import { getFirestore, doc, getDoc, setDoc, updateDoc, collection, addDoc, getDocs, query, where, orderBy, serverTimestamp } from "https://www.gstatic.com/firebasejs/11.0.1/firebase-firestore.js";

    // === Config Firebase (tu PROD)
    const firebaseConfig = {
      apiKey: "AIzaSyCSdjAdY7ymmOwIN7zApP-XpXxTar_0pHk",
      authDomain: "tereto-prod.firebaseapp.com",
      projectId: "tereto-prod",
      storageBucket: "tereto-prod.firebasestorage.app", // no se usa, pero no molesta
      messagingSenderId: "914605096619",
      appId: "1:914605096619:web:88a9b78eac50c35cb181ee"
    };

    const app = initializeApp(firebaseConfig);
    const auth = getAuth(app);
    const db = getFirestore(app);
    const provider = new GoogleAuthProvider();
    provider.setCustomParameters({ prompt: "select_account" });

    // ==== UI helpers ====
    const $ = id => document.getElementById(id);
    const loginScreen = $("login-screen");
    const appScreen = $("app-screen");
    const toastEl = $("toast"), toastMessage = $("toast-message"), toastIcon = $("toast-icon");
    const loadingSpinner = $("loading-spinner");

    function showToast(message, type='success') {
      toastMessage.textContent = message;
      toastIcon.innerHTML = type==='success'
        ? `<svg class="w-5 h-5" fill="currentColor" viewBox="0 0 20 20"><path fill-rule="evenodd" d="M16.707 5.293a1 1 0 010 1.414l-8 8a1 1 0 01-1.414 0l-4-4a1 1 0 011.414-1.414L8 12.586l7.293-7.293a1 1 0 011.414 0z" clip-rule="evenodd"/></svg>`
        : `<svg class="w-5 h-5" fill="currentColor" viewBox="0 0 20 20"><path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zM8.707 7.293a1 1 0 00-1.414 1.414L8.586 10l-1.293 1.293a1 1 0 101.414 1.414L10 11.414l1.293 1.293a1 1 0 001.414-1.414L11.414 10l1.293-1.293a1 1 0 00-1.414-1.414L10 8.586 8.707 7.293z" clip-rule="evenodd"/></svg>`;
      toastIcon.className = `inline-flex items-center justify-center flex-shrink-0 w-8 h-8 rounded-lg ${type==='success'?'text-green-500 bg-green-100':'text-red-500 bg-red-100'}`;
      toastEl.classList.add('show');
      setTimeout(()=>toastEl.classList.remove('show'), 2800);
    }

    // ==== Estado App (mock feed + firestore estado usuario) ====
    let currentUser = null;
    let mockUser = null;
    let challengesData = []; // mantenemos feed mock como antes

    function seedDataFor(user) {
      mockUser = {
        uid: user.uid,
        displayName: user.displayName || "Usuario",
        email: user.email || "",
        photoURL: user.photoURL || `https://placehold.co/100x100/A0A0FF/FFFFFF?text=${(user.displayName||'U')[0] || 'U'}`
      };
      challengesData = [
        {
          id: 'challenge4',
          authorId: mockUser.uid, authorName: mockUser.displayName, authorImg: mockUser.photoURL,
          type: 'photo', question: 'Haz una pose de superh√©roe.',
          createdAt: new Date(Date.now()-1000*60*20),
          contentUrl: 'https://placehold.co/600x400/0000FF/FFFFFF?text=SUPER',
          likes: 1, likedBy: [], comments: []
        },
        {
          id: 'challenge3',
          authorId: 'user789', authorName: 'Carlos', authorImg: 'https://placehold.co/40x40/A0FFA0/FFFFFF?text=C',
          type: 'photo', question: 'S√°cate una foto con un sombrero gracioso.',
          createdAt: new Date(Date.now()-1000*60*60),
          contentUrl: 'https://placehold.co/600x400/777777/FFFFFF?text=SOMBRERO',
          likes: 5, likedBy: [], comments: []
        },
        {
          id: 'challenge1',
          authorId: 'user456', authorName: 'Ana', authorImg: 'https://placehold.co/40x40/FFA0A0/FFFFFF?text=A',
          type: 'trivia', question: '¬øEn qu√© a√±o lleg√≥ el hombre a la luna?',
          correctAnswer: '1969', wrongAnswers: ['1965','1972','1980'],
          createdAt: new Date(Date.now()-1000*60*90),
          contentUrl: 'https://placehold.co/600x400/333333/FFFFFF?text=LUNA',
          likes: 15, likedBy: ['user789'],
          comments: []
        }
      ];
    }

    // ==== Elementos usados en feed ====
    const feedContainer = $("feed-container");
    const postTemplate = $("post-template");
    const triviaModal = $("trivia-modal");
    const photoChallengeModal = $("photo-challenge-modal");
    const photoChallengeDescription = $("photo-challenge-description");
    const submitPhotoChallengeBtn = $("submit-photo-challenge-btn");

    // C√°mara
    const cameraModal = $("camera-modal"),
          cameraStreamEl = $("camera-stream"),
          cameraCanvas = $("camera-canvas"),
          captureBtn = $("capture-btn"),
          cancelCameraBtn = $("cancel-camera-btn");

    let cameraStream = null, currentPhotoChallengeId = null;

    async function openCamera(challengeId=null) {
      currentPhotoChallengeId = challengeId;
      try {
        if (cameraStream) cameraStream.getTracks().forEach(t=>t.stop());
        cameraStream = await navigator.mediaDevices.getUserMedia({ video:{ facingMode:'user' }, audio:false });
        cameraStreamEl.srcObject = cameraStream;
        cameraModal.classList.remove('hidden');
      } catch(err) {
        console.error(err);
        showToast("No se pudo acceder a la c√°mara. Revisa permisos.", "error");
      }
    }
    function closeCamera() {
      if (cameraStream) cameraStream.getTracks().forEach(t=>t.stop());
      cameraStream = null;
      cameraModal.classList.add('hidden');
    }

    // Comprimir a JPEG y limitar tama√±o
    function compressToDataURL(videoEl, maxDim=900, quality=0.7) {
      const canvas = cameraCanvas;
      const vw = videoEl.videoWidth, vh = videoEl.videoHeight;
      let tw = vw, th = vh;
      if (Math.max(vw, vh) > maxDim) {
        if (vw > vh) { tw = maxDim; th = Math.round(vh * (maxDim / vw)); }
        else { th = maxDim; tw = Math.round(vw * (maxDim / vh)); }
      }
      canvas.width = tw; canvas.height = th;
      const ctx = canvas.getContext('2d');
      ctx.drawImage(videoEl, 0, 0, tw, th);
      return canvas.toDataURL('image/jpeg', quality); // DataURL
    }

    async function saveSubmissionDataURL(challengeId, dataUrl) {
      // Guardamos el env√≠o del usuario en: challenges/{cid}/submissions/{uid}
      const subRef = doc(db, "challenges", challengeId, "submissions", currentUser.uid);
      await setDoc(subRef, {
        uid: currentUser.uid,
        displayName: currentUser.displayName || "",
        proofDataUrl: dataUrl,         // <<--- media inline
        status: "pending",
        createdAt: serverTimestamp()
      }, { merge: true });
    }

    // Render feed
    function loadFeed() {
      feedContainer.innerHTML = "";
      challengesData.sort((a,b)=>b.createdAt - a.createdAt).forEach(renderPost);
    }

    function renderPost(postData) {
      const frag = document.importNode(postTemplate.content, true);
      const postCard = frag.querySelector('.post-card');
      postCard.dataset.challengeId = postData.id;
      frag.querySelector('.author-img').src = postData.authorImg;
      frag.querySelector('.author-name').textContent = postData.authorName;
      frag.querySelector('.post-time').textContent = postData.createdAt.toLocaleString('es-AR',{ dateStyle:'short', timeStyle:'short' });
      frag.querySelector('.content-img').src = postData.contentUrl;

      // Bloqueo visual (se desbloquea si aprobado para este usuario)
      applyLockStateToCard(postCard, postData.id, postData.type);

      feedContainer.appendChild(frag);
    }

    async function applyLockStateToCard(cardEl, challengeId, challengeType) {
      // Condici√≥n de desbloqueo:
      // - si es trivia y ya respondi√≥ bien en esta sesi√≥n (guardamos en approvals/{uid} como 'trivia: true')
      // - si es foto: existe doc approvals/{uid} con approved === true
      const isUnlocked = await isChallengeUnlockedForViewer(challengeId, challengeType);
      if (isUnlocked) {
        cardEl.querySelector('.content-img')?.classList.remove('blur-locked');
        cardEl.querySelector('.lock-overlay')?.classList.add('hidden');
      } else {
        cardEl.querySelector('.content-img')?.classList.add('blur-locked');
        cardEl.querySelector('.lock-overlay')?.classList.remove('hidden');
        if (challengeType === 'photo') cardEl.querySelector('.lock-icon').textContent = 'üì∏';
      }
    }

    async function isChallengeUnlockedForViewer(challengeId, challengeType) {
      if (!currentUser) return false;
      // approvals/{uid}: {approved: true} (para foto) o {trivia:true}
      const apprRef = doc(db, "challenges", challengeId, "approvals", currentUser.uid);
      const apprSnap = await getDoc(apprRef);
      if (!apprSnap.exists()) return false;
      const data = apprSnap.data();
      if (challengeType === 'trivia') return !!data.trivia;
      if (challengeType === 'photo') return !!data.approved;
      return false;
    }

    // Interacciones de tarjeta
    feedContainer.addEventListener('click', async (e) => {
      const card = e.target.closest('.post-card');
      if (!card) return;
      const challengeId = card.dataset.challengeId;
      const post = challengesData.find(c=>c.id === challengeId);

      if (e.target.closest('.challenge-container')) {
        if (post.type === 'trivia') {
          openTriviaModal(post, card);
        } else if (post.type === 'photo') {
          openPhotoChallengeModal(post);
        }
      }
    });

    // Trivia
    function openTriviaModal(challenge, cardEl) {
      $("trivia-modal-question").textContent = challenge.question;
      const box = $("trivia-modal-answers");
      box.innerHTML = "";
      [...challenge.wrongAnswers, challenge.correctAnswer]
        .sort(()=>Math.random()-0.5)
        .forEach(ans => {
          const btn = document.createElement('button');
          btn.className = 'answer-btn bg-slate-100 hover:bg-indigo-100 text-slate-800 font-semibold py-3 px-4 border border-slate-300 rounded-lg shadow-sm';
          btn.textContent = ans;
          btn.onclick = () => checkTriviaAnswer(challenge, cardEl, ans === challenge.correctAnswer);
          box.appendChild(btn);
        });
      $("trivia-modal").classList.remove("hidden");
    }

    async function checkTriviaAnswer(challenge, cardEl, ok) {
      if (!ok) {
        $("trivia-feedback").textContent = 'Respuesta incorrecta. ¬°Int√©ntalo de nuevo!';
        setTimeout(()=>{$("trivia-feedback").textContent = '';}, 1800);
        return;
      }
      // Marcamos trivia desbloqueada para este usuario
      await setDoc(doc(db,"challenges",challenge.id,"approvals", currentUser.uid), {
        trivia: true,
        updatedAt: serverTimestamp()
      }, { merge: true });

      $("trivia-modal").classList.add("hidden");
      await applyLockStateToCard(cardEl, challenge.id, "trivia");
      showToast("¬°Correcto! Desbloqueado para vos.");
    }

    // Foto
    function openPhotoChallengeModal(challenge) {
      photoChallengeDescription.textContent = challenge.question;
      submitPhotoChallengeBtn.dataset.challengeId = challenge.id;
      photoChallengeModal.classList.remove('hidden');
    }

    $("submit-photo-challenge-btn").addEventListener("click", () => {
      const cid = submitPhotoChallengeBtn.dataset.challengeId;
      photoChallengeModal.classList.add('hidden');
      openCamera(cid);
    });

    captureBtn.addEventListener("click", async () => {
      try {
        const dataUrl = compressToDataURL(cameraStreamEl, 900, 0.7);
        // Seguridad: tama√±o aproximado del DataURL
        const approxBytes = Math.ceil((dataUrl.length - 'data:image/jpeg;base64,'.length) * 3/4);
        if (approxBytes > 950 * 1024) {
          showToast("La imagen qued√≥ muy grande (>950KB). Alejate un poco o baja calidad.", "error");
          return;
        }
        const cid = currentPhotoChallengeId;
        await saveSubmissionDataURL(cid, dataUrl);
        showToast("Prueba enviada. Espera aprobaci√≥n del autor üôå");
      } catch(err) {
        console.error(err);
        showToast("No se pudo enviar la prueba", "error");
      } finally {
        closeCamera();
      }
    });

    cancelCameraBtn.addEventListener("click", closeCamera);
    $("close-trivia-modal").addEventListener("click", ()=> $("trivia-modal").classList.add("hidden"));
    $("close-photo-challenge-modal").addEventListener("click", ()=> $("photo-challenge-modal").classList.add("hidden"));

    // ==== Aprobaci√≥n del autor (demo)
    // Si quer√©s simular aprobaci√≥n: abr√≠ la consola y ejecut√°:
    // approveSubmission('<challengeId>','<viewerUid>')
    async function approveSubmission(challengeId, viewerUid) {
      // solo deber√≠a ejecutarlo el autor: ac√° no validamos, es demo/manual
      await setDoc(doc(db,"challenges",challengeId,"approvals", viewerUid), {
        approved: true,
        updatedAt: serverTimestamp()
      }, { merge:true });
      showToast("Env√≠o aprobado (demo).");
    }
    window.approveSubmission = approveSubmission;

    // ==== Auth ====
    $("google-btn").addEventListener("click", async () => {
      try {
        loadingSpinner.classList.remove("hidden");
        await signInWithPopup(auth, provider);
      } catch(err) {
        console.error(err);
        showToast(err.code?.replace("auth/","") || "Error al iniciar sesi√≥n", "error");
      } finally {
        loadingSpinner.classList.add("hidden");
      }
    });

    $("signout-btn")?.addEventListener("click", async () => {
      try {
        await signOut(auth);
        showToast("Sesi√≥n cerrada.");
      } catch(err) {
        console.error(err);
        showToast("No se pudo cerrar sesi√≥n", "error");
      }
    });

    // ==== Estado de auth ====
    onAuthStateChanged(auth, async (user) => {
      currentUser = user || null;
      if (currentUser) {
        seedDataFor(currentUser);
        loginScreen.classList.add("hidden");
        appScreen.classList.remove("hidden");
        loadFeed();
      } else {
        appScreen.classList.add("hidden");
        loginScreen.classList.remove("hidden");
      }
    });
  </script>
</body>
</html>
