<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>TeReto</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;500;600;700&display=swap" rel="stylesheet">
  <!-- Para usar @apply con CDN -->
  <style type="text/tailwindcss">
    :root { --brand:#4f46e5; }
    body { font-family: 'Poppins', sans-serif; }
    .btn { @apply px-4 py-2 rounded-lg font-semibold transition; }
    .btn-primary { @apply bg-indigo-600 text-white hover:bg-indigo-700; }
    .btn-ghost { @apply bg-gray-100 hover:bg-gray-200; }
    .card { @apply bg-white rounded-2xl shadow-md; }
    .tab { @apply px-4 py-2 rounded-xl cursor-pointer; }
    .tab-active { @apply bg-indigo-50 text-indigo-700 font-semibold; }
    .input { @apply w-full border rounded-lg px-3 py-2 focus:outline-none focus:ring-2 focus:ring-indigo-300; }
    .badge { @apply inline-flex items-center px-2 py-1 text-xs rounded-full bg-gray-100; }
    .hidden { display: none; }
  </style>
</head>
<body class="bg-gray-100 min-h-screen">
  <div id="app" class="max-w-5xl mx-auto p-4 md:p-8"></div>

  <script type="module">
    /***********************
     * Firebase SDK (v11)
     ***********************/
    import { initializeApp } from "https://www.gstatic.com/firebasejs/11.0.1/firebase-app.js";
    import { 
      getAuth, GoogleAuthProvider, signInWithPopup, onAuthStateChanged, signOut 
    } from "https://www.gstatic.com/firebasejs/11.0.1/firebase-auth.js";
    import { 
      getFirestore, collection, query, where, orderBy, limit, getDocs, doc, setDoc, addDoc, serverTimestamp 
    } from "https://www.gstatic.com/firebasejs/11.0.1/firebase-firestore.js";
    import {
      getStorage, ref, uploadBytes, getDownloadURL
    } from "https://www.gstatic.com/firebasejs/11.0.1/firebase-storage.js";

    // --- CONFIG DE FIREBASE (de Nico) ---
    const firebaseConfig = {
      apiKey: "AIzaSyCSdjAdY7ymmOwIN7zApP-XpXxTar_0pHk",
      authDomain: "tereto-prod.firebaseapp.com",
      projectId: "tereto-prod",
      storageBucket: "tereto-prod.appspot.com",
      messagingSenderId: "914605096619",
      appId: "1:914605096619:web:88a9b78eac50c35cb181ee"
    };

    const app = initializeApp(firebaseConfig);
    const auth = getAuth(app);
    const db = getFirestore(app);
    const storage = getStorage(app);

    // Parámetros legales
    const TERMS_VERSION = "1.0";
    const TERMS_URL = "/legal/terminos-condiciones.html";

    // Helpers
    const $ = (sel, el=document) => el.querySelector(sel);
    const $$ = (sel, el=document) => Array.from(el.querySelectorAll(sel));
    const appRoot = $("#app");

    onAuthStateChanged(auth, async (user) => {
      if (user) {
        renderShell(user);
        await renderFeed(user);
      } else {
        renderLogin();
      }
    });

    /********* LOGIN *********/
    function renderLogin() {
      appRoot.innerHTML = `
        <div class="max-w-md mx-auto card p-8 text-center">
          <h1 class="text-3xl font-bold mb-2">TeReto</h1>
          <p class="text-gray-600 mb-6">Iniciá sesión para continuar</p>

          <div class="mt-2 space-y-3 text-sm text-left" id="legal-checks">
            <label class="flex items-start gap-2">
              <input id="chk-adult" type="checkbox" class="mt-1 shrink-0">
              <span>Soy <strong>mayor de 18 años</strong>.</span>
            </label>
            <label class="flex items-start gap-2">
              <input id="chk-terms" type="checkbox" class="mt-1 shrink-0">
              <span>He leído y acepto los
                <a href="${TERMS_URL}" target="_blank" class="underline text-indigo-600">Términos y Condiciones</a>.
              </span>
            </label>
          </div>

          <button data-google-signin id="btn-google" class="mt-6 btn btn-primary disabled:opacity-50 disabled:cursor-not-allowed">
            Continuar con Google
          </button>

          <p class="text-xs text-gray-400 mt-6">© ${new Date().getFullYear()} TeReto</p>
        </div>
      `;

      const btnGoogle = $('[data-google-signin]');
      const chkAdult  = $('#chk-adult');
      const chkTerms  = $('#chk-terms');

      const updateBtn = () => {
        const enabled = chkAdult?.checked && chkTerms?.checked;
        btnGoogle.disabled = !enabled;
        btnGoogle.classList.toggle('opacity-50', !enabled);
        btnGoogle.classList.toggle('cursor-not-allowed', !enabled);
      };
      chkAdult.addEventListener('change', updateBtn);
      chkTerms.addEventListener('change', updateBtn);
      updateBtn();

      btnGoogle.addEventListener('click', async (e) => {
        if (!chkAdult.checked || !chkTerms.checked) {
          e.preventDefault();
          return;
        }
        try {
          const provider = new GoogleAuthProvider();
          const result = await signInWithPopup(auth, provider);
          const user = result.user;

          await setDoc(doc(db, 'users', user.uid), {
            displayName: user.displayName || "",
            photoURL: user.photoURL || "",
            email: user.email || "",
            emailLower: (user.email || "").toLowerCase(),
            isAdult: true,
            acceptedTermsAt: serverTimestamp(),
            acceptedTermsVersion: TERMS_VERSION,
            acceptedTermsUrl: TERMS_URL
          }, { merge: true });
        } catch (err) {
          console.error(err);
          alert("Error al iniciar sesión: " + (err?.message || err));
        }
      });
    }

    /********* APP SHELL *********/
    function renderShell(user) {
      appRoot.innerHTML = `
        <header class="flex items-center justify-between mb-6">
          <div class="flex items-center gap-3">
            <div class="w-10 h-10 rounded-xl bg-indigo-600 text-white flex items-center justify-center font-bold">TR</div>
            <div>
              <div class="font-semibold">TeReto</div>
              <div class="text-xs text-gray-500">Hola, ${user.displayName || user.email}</div>
            </div>
          </div>
          <div class="flex items-center gap-3">
            <img src="${user.photoURL || 'https://ui-avatars.com/api/?name=' + encodeURIComponent(user.displayName || user.email)}" class="w-9 h-9 rounded-full border" alt="avatar" />
            <button id="btn-new" class="btn btn-primary">Nuevo reto</button>
            <button id="btn-logout" class="btn btn-ghost">Salir</button>
          </div>
        </header>

        <nav class="flex gap-2 mb-6">
          <button data-tab="feed"   class="tab tab-active">Feed</button>
          <button data-tab="amigos" class="tab">Amigos</button>
          <button data-tab="perfil" class="tab">Perfil</button>
        </nav>

        <section id="view" class="space-y-4"></section>

        <!-- Modal Nuevo Reto -->
        <div id="modal" class="fixed inset-0 bg-black/40 items-center justify-center p-4 hidden">
          <div class="card w-full max-w-lg p-6 relative">
            <button id="m-close" class="absolute right-3 top-3 text-gray-400 hover:text-gray-600">✕</button>
            <h3 class="text-lg font-semibold mb-4">Crear reto</h3>
            <div class="space-y-3">
              <input id="m-caption" class="input" placeholder="Título / descripción">
              <select id="m-vis" class="input">
                <option value="public">Público</option>
                <option value="friends">Amigos</option>
              </select>
              <input id="m-file" type="file" accept="image/*" class="input">
              <div class="text-xs text-gray-500">Se comprime antes de subir (máx aprox 1280px, JPEG 80%).</div>
              <div id="m-status" class="text-sm"></div>
              <div class="flex gap-2 justify-end pt-2">
                <button id="m-cancel" class="btn btn-ghost">Cancelar</button>
                <button id="m-save" class="btn btn-primary">Subir</button>
              </div>
            </div>
          </div>
        </div>
      `;

      $("#btn-logout").addEventListener("click", async () => { await signOut(auth); });
      $("[data-tab='feed']").addEventListener("click", async (e) => { setActiveTab(e.target); await renderFeed(auth.currentUser); });
      $("[data-tab='amigos']").addEventListener("click", async (e) => { setActiveTab(e.target); renderAmigos(); });
      $("[data-tab='perfil']").addEventListener("click", async (e) => { setActiveTab(e.target); renderPerfil(auth.currentUser); });

      // Nuevo reto
      $("#btn-new").addEventListener("click", () => toggleModal(true));
      $("#m-close").addEventListener("click", () => toggleModal(false));
      $("#m-cancel").addEventListener("click", () => toggleModal(false));
      $("#m-save").addEventListener("click", async () => { await createChallenge(user); });
    }

    function toggleModal(show) {
      $("#modal").classList.toggle("hidden", !show);
      if (show) { $("#m-status").textContent = ""; $("#m-file").value = ""; }
    }

    function setActiveTab(btn) {
      $$(".tab").forEach(b => b.classList.remove("tab-active"));
      btn.classList.add("tab-active");
    }

    /********* FEED *********/
    async function renderFeed(user) {
      const view = $("#view");
      view.innerHTML = skeletonCards(3);

      try {
        const q = query(
          collection(db, "challenges"),
          where("vis", "==", "public"),
          orderBy("createdAt", "desc"),
          limit(20)
        );
        const snap = await getDocs(q);

        if (snap.empty) {
          view.innerHTML = emptyState("No hay retos públicos aún.");
          return;
        }

        view.innerHTML = "";
        snap.forEach(docSnap => {
          const c = docSnap.data();
          const ts = c.createdAt?.toMillis ? c.createdAt.toMillis() : (typeof c.createdAt === "number" ? c.createdAt : Date.now());
          const card = document.createElement("article");
          card.className = "card overflow-hidden";
          card.innerHTML = `
            <div class="p-4 flex items-center gap-3">
              <img src="${c.authorImg || 'https://ui-avatars.com/api/?name=' + encodeURIComponent(c.authorName || '')}" class="w-9 h-9 rounded-full border" />
              <div>
                <div class="font-medium">${c.authorName || 'Anónimo'}</div>
                <div class="text-xs text-gray-500">${new Date(ts).toLocaleString()}</div>
              </div>
            </div>
            ${c.contentUrl ? `<img src="${c.contentUrl}" class="w-full max-h-[480px] object-cover">` : ``}
            ${c.caption ? `<div class="p-4 text-sm">${escapeHtml(c.caption)}</div>` : ``}
            <div class="px-4 pb-4 text-sm text-gray-600 flex items-center gap-4">
              <span>👍 ${c.likesCount ?? 0}</span>
              <span>💬 ${c.commentsCount ?? 0}</span>
              <span class="ml-auto badge">${c.vis}</span>
            </div>
          `;
          view.appendChild(card);
        });
      } catch (err) {
        console.error(err);
        view.innerHTML = errorState("No pudimos cargar el feed.");
      }
    }

    /********* NUEVO RETO: compresión + subida *********/
    async function createChallenge(user) {
      const caption = $("#m-caption").value.trim();
      const vis = $("#m-vis").value || "public";
      const file = $("#m-file").files[0];
      const status = $("#m-status");

      if (!file) { status.textContent = "Elegí una imagen."; return; }

      try {
        status.textContent = "Comprimiendo imagen...";
        const blob = await compressImage(file, 1280, 1280, 0.8); // max 1280px, 80%

        status.textContent = "Subiendo a Storage...";
        const ts = Date.now();
        const path = `challenges/${user.uid}/${ts}.jpg`;
        const storageRef = ref(storage, path);
        await uploadBytes(storageRef, blob, { contentType: "image/jpeg" });
        const url = await getDownloadURL(storageRef);

        status.textContent = "Creando documento...";
        await addDoc(collection(db, "challenges"), {
          authorId: user.uid,
          authorName: user.displayName || "",
          authorImg: user.photoURL || "",
          caption: caption,
          contentUrl: url,
          createdAt: serverTimestamp(),
          likesCount: 0,
          commentsCount: 0,
          vis: vis
        });

        status.textContent = "Listo ✅";
        toggleModal(false);
        await renderFeed(user);
      } catch (err) {
        console.error(err);
        status.textContent = "Error: " + (err?.message || err);
      }
    }

    function compressImage(file, maxW=1280, maxH=1280, quality=0.8) {
      return new Promise((resolve, reject) => {
        const reader = new FileReader();
        reader.onload = () => {
          const img = new Image();
          img.onload = () => {
            let { width, height } = img;
            const ratio = Math.min(maxW / width, maxH / height, 1);
            const canvas = document.createElement("canvas");
            canvas.width = Math.round(width * ratio);
            canvas.height = Math.round(height * ratio);
            const ctx = canvas.getContext("2d");
            ctx.drawImage(img, 0, 0, canvas.width, canvas.height);
            canvas.toBlob((blob) => {
              if (blob) resolve(blob);
              else reject(new Error("No se pudo comprimir."));
            }, "image/jpeg", quality);
          };
          img.onerror = () => reject(new Error("Imagen inválida."));
          img.src = reader.result;
        };
        reader.onerror = () => reject(new Error("No se pudo leer el archivo."));
        reader.readAsDataURL(file);
      });
    }

    /********* AMIGOS / PERFIL (placeholders) *********/
    function renderAmigos() {
      $("#view").innerHTML = `
        <div class="card p-6">
          <h2 class="text-lg font-semibold mb-2">Amigos</h2>
          <p class="text-sm text-gray-600">Acá irán tus amigos, solicitudes y búsqueda. (UI placeholder)</p>
        </div>
      `;
    }

    function renderPerfil(user) {
      $("#view").innerHTML = `
        <div class="card p-6">
          <h2 class="text-lg font-semibold mb-2">Perfil</h2>
          <div class="flex items-center gap-4 mb-4">
            <img src="${user.photoURL || 'https://ui-avatars.com/api/?name=' + encodeURIComponent(user.displayName || user.email)}" class="w-14 h-14 rounded-full border" />
            <div>
              <div class="font-medium">${user.displayName || 'Usuario'}</div>
              <div class="text-sm text-gray-500">${user.email}</div>
            </div>
          </div>
          <p class="text-sm text-gray-600">Acá irán tus retos propios y acciones de perfil. (UI placeholder)</p>
        </div>
      `;
    }

    /********* UI Utils *********/
    function skeletonCards(n=3) {
      return Array.from({length:n}).map(() => `
        <div class="card p-4 animate-pulse">
          <div class="h-4 bg-gray-200 rounded w-1/2 mb-3"></div>
          <div class="h-64 bg-gray-200 rounded mb-3"></div>
          <div class="h-4 bg-gray-200 rounded w-1/3"></div>
        </div>
      `).join("");
    }
    function emptyState(msg) {
      return `<div class="card p-10 text-center text-gray-600">${msg}</div>`;
    }
    function errorState(msg) {
      return `<div class="card p-10 text-center text-red-600">${msg}</div>`;
    }
    function escapeHtml(str="") {
      return str.replace(/[&<>"']/g, (m) => ({
        '&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'
      })[m]);
    }
  </script>
</body>
</html>
