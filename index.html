<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <title>TeReto</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <style>
    :root { --bg: #0b0b0c; --card:#131316; --muted:#a1a1aa; }
    body { background: var(--bg); color: #fff; font-family: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto; }
    .card { background: var(--card); border: 1px solid #1f1f22; }
  </style>
</head>
<body class="min-h-screen">
  <!-- Topbar -->
  <header class="px-4 py-3 border-b border-neutral-800 flex items-center justify-between">
    <div class="text-lg font-semibold">TeReto</div>
    <div id="userArea" class="text-sm text-neutral-300"></div>
  </header>

  <!-- Main -->
  <main class="max-w-xl mx-auto px-4 py-10 space-y-6">
    <!-- Avisos -->
    <div id="notice" class="hidden card rounded-2xl p-4 text-sm"></div>

    <!-- Login Card -->
    <section id="loginCard" class="card rounded-2xl p-6 space-y-4">
      <h2 class="text-xl font-semibold">Ingresá</h2>
      <p class="text-neutral-300">Usá tu cuenta de Google para continuar.</p>
      <button id="btnGoogle" type="button"
        class="w-full rounded-xl px-4 py-3 font-medium border border-neutral-700 hover:border-neutral-500 transition">
        Continuar con Google
      </button>
      <p class="text-neutral-400 text-xs leading-5">
        Si no se abre el popup: probá ventana privada, desactivá extensiones bloqueadoras y verificá que estés en
        <span class="font-mono">http://localhost</span> o un dominio autorizado.
      </p>
    </section>

    <!-- App Card (post-login) -->
    <section id="appCard" class="hidden card rounded-2xl p-6 space-y-4">
      <h2 class="text-xl font-semibold">¡Bienvenido/a!</h2>
      <div id="profile" class="text-neutral-300 text-sm"></div>
      <div class="flex gap-3">
        <button id="btnSignOut" type="button"
          class="rounded-lg px-3 py-2 border border-neutral-700 hover:border-neutral-500">Salir</button>
        <!-- Placeholders para cuando migremos el feed a Firestore -->
        <button id="btnMockChallenge" type="button"
          class="rounded-lg px-3 py-2 border border-neutral-700 hover:border-neutral-500">Crear reto (mock)</button>
      </div>
      <div id="feed" class="grid grid-cols-1 gap-3 pt-2"></div>
    </section>
  </main>

  <script type="module">
    // =========================
    // Firebase v11.0.1 (ESM)
    // =========================
    import { initializeApp } from "https://www.gstatic.com/firebasejs/11.0.1/firebase-app.js";
    import {
      getAuth, GoogleAuthProvider, signInWithPopup, signInWithRedirect,
      onAuthStateChanged, signOut
    } from "https://www.gstatic.com/firebasejs/11.0.1/firebase-auth.js";
    import {
      getFirestore
      // (cuando migremos) collection, addDoc, getDocs, onSnapshot, query, where, orderBy
    } from "https://www.gstatic.com/firebasejs/11.0.1/firebase-firestore.js";

    // ---- UI handles ----
    const $ = (id) => document.getElementById(id);
    const loginCard = $("loginCard");
    const appCard = $("appCard");
    const userArea = $("userArea");
    const notice = $("notice");
    const btnGoogle = $("btnGoogle");
    const btnSignOut = $("btnSignOut");
    const profile = $("profile");
    const feed = $("feed");
    const btnMockChallenge = $("btnMockChallenge");

    // ---- Seguridad de origen ----
    const originIsFile = location.protocol === "file:";
    const originIsLocalhost = /^https?:\/\/(localhost|127\.0\.0\.1)(:\d+)?$/.test(location.origin);

    function showNotice(msg, tone = "info") {
      notice.classList.remove("hidden");
      notice.classList.toggle("border-red-600", tone === "error");
      notice.classList.toggle("border-neutral-700", tone !== "error");
      notice.innerText = msg;
    }

    if (originIsFile) {
      showNotice("No uses file://. Serví el proyecto con un servidor local (ej: http://localhost:5173).", "error");
    } else if (!originIsLocalhost) {
      showNotice("Asegurate de tener este dominio en Authentication → Authorized domains en Firebase Console.");
    }

    // ---- Firebase Config ----
    const firebaseConfig = {
      // TODO: pega aquí tu config real de Firebase (apiKey, authDomain, projectId, appId, etc.)
      // Ejemplo:
      // apiKey: "AAAA...BBBB",
      // authDomain: "tereto-prod.firebaseapp.com",
      // projectId: "tereto-prod",
      // appId: "1:1234567890:web:abcdef",
    };

    // Guardrail: valida config mínima
    function assertConfig(cfg) {
      const required = ["apiKey", "authDomain", "projectId", "appId"];
      const missing = required.filter(k => !cfg?.[k]);
      if (missing.length) {
        throw new Error("Firebase config incompleta. Falta: " + missing.join(", "));
      }
    }

    // ---- Init ordenado ----
    let app, auth, db, provider;
    try {
      assertConfig(firebaseConfig);
      app = initializeApp(firebaseConfig);
      auth = getAuth(app);
      db = getFirestore(app);
      provider = new GoogleAuthProvider();
      // Opcional: forzar prompt de cuenta
      provider.setCustomParameters({ prompt: "select_account" });
      console.info("[TeReto] Firebase inicializado OK.");
    } catch (e) {
      console.error("[TeReto] Error init Firebase:", e);
      showNotice("Error inicializando Firebase: " + e.message, "error");
    }

    // ---- Estado de sesión ----
    onAuthStateChanged(auth, (user) => {
      if (user) {
        userArea.textContent = user.displayName ? `Hola, ${user.displayName}` : user.email;
        profile.innerHTML = `
          <div><span class="text-neutral-400">UID:</span> ${user.uid}</div>
          <div><span class="text-neutral-400">Email:</span> ${user.email ?? "-"}</div>
        `;
        loginCard.classList.add("hidden");
        appCard.classList.remove("hidden");
        // (luego) cargar feed desde Firestore
      } else {
        userArea.textContent = "";
        appCard.classList.add("hidden");
        loginCard.classList.remove("hidden");
      }
    });

    // ---- Login con popup + fallback redirect ----
    async function startGoogleLogin() {
      try {
        // Tip: algunos navegadores requieren que la llamada ocurra
        // estrictamente dentro del handler del click sin awaits previos.
        await signInWithPopup(auth, provider);
      } catch (err) {
        console.warn("[TeReto] signInWithPopup falló:", err?.code, err?.message);
        // Bloqueo de popup → redirigir
        if (err?.code === "auth/popup-blocked" || err?.code === "auth/popup-closed-by-user") {
          showNotice("Popup bloqueado. Vamos por redirección...", "info");
          await signInWithRedirect(auth, provider);
          return;
        }
        // Origen no autorizado / dominios
        if (err?.message?.includes("domain") || err?.message?.includes("origin")) {
          showNotice("Dominio/origen no autorizado en Firebase Authentication → Authorized domains.", "error");
          return;
        }
        showNotice("No se pudo iniciar sesión: " + (err?.message ?? "Error desconocido"), "error");
      }
    }

    // ---- Handlers UI (bind después de cargar el DOM) ----
    btnGoogle.addEventListener("click", (ev) => {
      ev.preventDefault();         // evita submits inesperados
      ev.stopPropagation();        // evita interferencias de listeners padres
      // IMPORTANTE: no pongas awaits antes del signInWithPopup
      startGoogleLogin();
    });

    btnSignOut.addEventListener("click", async () => {
      await signOut(auth);
    });

    // ---- Mock mínimo (deja hooks para migrar a Firestore) ----
    const mockFeed = [];
    function renderFeed() {
      feed.innerHTML = mockFeed.length
        ? mockFeed.map(x => `
            <div class="rounded-xl border border-neutral-800 p-3">
              <div class="text-sm text-neutral-400">${x.type.toUpperCase()}</div>
              <div class="font-medium">${x.title}</div>
              <div class="text-sm text-neutral-400">${new Date(x.ts).toLocaleString()}</div>
            </div>`).join("")
        : `<div class="text-neutral-400 text-sm">Aún no hay retos. Probá crear uno.</div>`;
    }
    btnMockChallenge.addEventListener("click", () => {
      mockFeed.unshift({ id: crypto.randomUUID(), title: "Reto de prueba", type: "trivia", ts: Date.now() });
      renderFeed();
    });
    renderFeed();

    // ---- Diagnóstico rápido en consola ----
    console.table({
      origin: location.origin,
      isFileProtocol: originIsFile,
      isLocalhost: originIsLocalhost,
      firebaseAuthDomain: firebaseConfig.authDomain || "(sin setear)"
    });
  </script>
</body>
</html>
