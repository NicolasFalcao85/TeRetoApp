<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>TeReto</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;500;600;700&display=swap" rel="stylesheet">
  <style>
    body { font-family: 'Poppins', sans-serif; }
    .blur-locked { filter: blur(20px); transition: filter .25s ease-in-out; }
    .animate-fade-in-up { animation: fadeInUp .5s ease-out forwards; }
    @keyframes fadeInUp { from {opacity:0; transform:translateY(20px);} to {opacity:1; transform:translateY(0);} }
    .answer-btn:hover { transform: translateY(-2px); box-shadow:0 4px 12px rgba(0,0,0,.1); }
    .like-icon.liked { fill:#ec4899; color:#ec4899; }
    .like-button:active { transform: scale(.9); }
    .image-preview { max-height: 200px; object-fit: cover; }
    .comments-modal-body { height: calc(100vh - 12rem); }
    .toast { visibility:hidden; opacity:0; transform:translateY(100%); transition:all .5s cubic-bezier(.68,-.55,.27,1.55);}
    .toast.show { visibility:visible; opacity:1; transform:translateY(0); }
    .spinner { border:4px solid rgba(0,0,0,.1); width:36px; height:36px; border-radius:50%; border-left-color:#6366f1; animation:spin 1s ease infinite; }
    @keyframes spin { 0%{transform:rotate(0);} 100%{transform:rotate(360deg);} }
    .friends-tab.active { border-bottom-color:#6366f1; color:#6366f1; font-weight:600; }
    .btn-primary { background-image:linear-gradient(to right,#6366f1,#8b5cf6); transition:all .3s ease; }
    .btn-primary:hover { box-shadow:0 4px 15px rgba(99,102,241,.75); }
    .tip-chip { font-size:10px; padding:2px 8px; border-radius:9999px; background:rgba(255,255,255,.25); border:1px solid rgba(255,255,255,.5); }
    .grid-mosaic { display:grid; grid-template-columns:repeat(3,1fr); gap:.5rem; }
    .mosaic-item { position:relative; aspect-ratio:1/1; }
    .mosaic-img { width:100%; height:100%; object-fit:cover; border-radius:.5rem; }
    .mosaic-del { position:absolute; top:.25rem; right:.25rem; background:rgba(0,0,0,.6); color:#fff; border-radius:.5rem; padding:.15rem .4rem; font-size:.8rem; }
    .badge { font-size:.7rem; padding:.1rem .35rem; border-radius:.35rem; }
  </style>
</head>
<body class="bg-slate-100 h-screen">

  <!-- SPINNER -->
  <div id="loading-spinner" class="hidden fixed inset-0 bg-slate-100/80 flex items-center justify-center z-[100]">
    <div class="spinner"></div>
  </div>

  <!-- TOAST -->
  <div id="toast" class="toast fixed bottom-24 left-1/2 -translate-x-1/2 flex items-center w-full max-w-xs p-4 text-slate-600 bg-white rounded-xl shadow-2xl z-[90]" role="alert">
    <div id="toast-icon" class="inline-flex items-center justify-center flex-shrink-0 w-8 h-8 rounded-lg"></div>
    <div id="toast-message" class="ml-3 text-sm font-normal"></div>
  </div>

  <!-- LOGIN -->
  <div id="login-screen" class="min-h-screen flex items-center justify-center p-4">
    <div class="w-full max-w-sm bg-white rounded-2xl shadow-2xl p-6">
      <div class="flex items-center justify-center mb-4">
        <svg class="w-10 h-10" viewBox="0 0 32 32" fill="none" xmlns="http://www.w3.org/2000/svg">
          <defs><linearGradient id="logoGradientHeader" x1="0" y1="0" x2="32" y2="32"><stop stop-color="#818CF8"/><stop offset="1" stop-color="#C084FC"/></linearGradient></defs>
          <path d="M16 28c6.627 0 12-5.373 12-12S22.627 4 16 4 4 9.373 4 16s5.373 12 12 12Z" stroke="url(#logoGradientHeader)" stroke-width="3"/>
          <path d="M16 20a4 4 0 1 0 0-8 4 4 0 0 0 0 8Z" stroke="url(#logoGradientHeader)" stroke-width="3"/>
        </svg>
        <svg class="h-8 ml-2" viewBox="0 0 90 25" fill="none" xmlns="http://www.w3.org/2000/svg">
          <defs><linearGradient id="logoTextGradient" x1="0%" y1="0%" x2="100%" y2="0%"><stop offset="0%" stop-color="#6366f1"/><stop offset="100%" stop-color="#8b5cf6"/></linearGradient></defs>
          <text x="0" y="20" font-family="Poppins, sans-serif" font-size="24" font-weight="700" fill="url(#logoTextGradient)">TeReto</text>
        </svg>
      </div>
      <p class="text-center text-slate-600 mb-6">Ingres√° para continuar</p>
      <button id="google-btn" class="w-full flex items-center justify-center gap-3 border rounded-xl py-3 hover:bg-slate-50">
        <img alt="Google" src="https://www.gstatic.com/firebasejs/ui/2.0.0/images/auth/google.svg" class="w-5 h-5">
        <span class="font-semibold text-slate-700">Continuar con Google</span>
      </button>
      <p class="text-[11px] text-center text-slate-400 mt-4">Al continuar acept√°s los T√©rminos y la Pol√≠tica de Privacidad.</p>
    </div>
  </div>

  <!-- APP -->
  <div id="app-screen" class="h-full flex flex-col hidden">
    <main class="flex-grow overflow-y-auto pb-20 bg-slate-100">
      <!-- FEED -->
      <div id="feed-view">
        <header class="sticky top-0 bg-white/80 backdrop-blur-sm p-4 border-b flex justify-between items-center z-40">
          <div class="flex items-center space-x-2">
            <svg class="w-8 h-8" viewBox="0 0 32 32" fill="none" xmlns="http://www.w3.org/2000/svg">
              <defs><linearGradient id="logoGradientHeader2" x1="0" y1="0" x2="32" y2="32"><stop stop-color="#818CF8"/><stop offset="1" stop-color="#C084FC"/></linearGradient></defs>
              <path d="M16 28c6.627 0 12-5.373 12-12S22.627 4 16 4 4 9.373 4 16s5.373 12 12 12Z" stroke="url(#logoGradientHeader2)" stroke-width="3"/>
              <path d="M16 20a4 4 0 1 0 0-8 4 4 0 0 0 0 8Z" stroke="url(#logoGradientHeader2)" stroke-width="3"/>
            </svg>
            <svg class="h-7" viewBox="0 0 90 25" fill="none" xmlns="http://www.w3.org/2000/svg">
              <defs><linearGradient id="logoTextGradient2" x1="0%" y1="0%" x2="100%" y2="0%"><stop offset="0%" stop-color="#6366f1"/><stop offset="100%" stop-color="#8b5cf6"/></linearGradient></defs>
              <text x="0" y="20" font-family="Poppins, sans-serif" font-size="24" font-weight="700" fill="url(#logoTextGradient2)">TeReto</text>
            </svg>
          </div>
          <button id="signout-btn" class="text-slate-500 hover:text-indigo-500 text-sm font-semibold">Cerrar sesi√≥n</button>
        </header>
        <div class="px-3 pt-3 pb-1">
          <div id="feed-tip" class="hidden text-[12px] text-slate-600">
            <span class="tip-chip">Consejo</span> Toc√° la imagen ‚Äúbloqueada‚Äù para aceptar el desaf√≠o. Si acert√°s, se desbloquea para vos. üòâ
          </div>
        </div>
        <div id="feed-container" class="p-2 space-y-4"></div>
      </div>

      <!-- CREATE -->
      <div id="create-view" class="hidden p-4">
        <div class="max-w-md mx-auto bg-white rounded-xl shadow-lg p-6">
          <h2 class="text-2xl font-bold mb-6 text-center text-slate-800">Crea un Nuevo Reto</h2>
          <div id="create-step-1" class="text-center">
            <h3 class="font-semibold text-lg mb-2 text-slate-700">Paso 1: Agrega el contenido a bloquear</h3>
            <div id="image-preview-container" class="hidden my-4">
              <img id="image-preview" src="#" alt="Previsualizaci√≥n" class="rounded-lg image-preview mx-auto"/>
            </div>
            <div class="grid grid-cols-2 gap-4 my-4">
              <label for="file-upload" class="flex flex-col items-center justify-center p-4 border-2 border-dashed rounded-lg cursor-pointer hover:bg-slate-50 text-slate-500 hover:text-indigo-500">
                <svg class="w-10 h-10 mb-2" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path .../></svg>
                <span class="text-sm font-semibold">Subir Archivo</span>
                <input id="file-upload" type="file" class="sr-only" accept="image/*,video/*">
              </label>
              <button id="open-camera-btn" type="button" class="flex flex-col items-center justify-center p-4 border-2 border-dashed rounded-lg hover:bg-slate-50 text-slate-500 hover:text-indigo-500">
                <svg class="w-10 h-10 mb-2" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path .../></svg>
                <span class="text-sm font-semibold">Usar C√°mara</span>
              </button>
            </div>
            <p id="file-name" class="mt-2 text-sm text-slate-500"></p>
            <button id="goto-step-2" class="mt-4 w-full text-white font-bold py-2 px-4 rounded-md btn-primary disabled:opacity-50 disabled:cursor-not-allowed" disabled>Siguiente</button>
          </div>
          <div id="create-step-2" class="hidden">
            <h3 class="font-semibold text-lg mb-2 text-slate-700">Paso 2: Eleg√≠ el tipo de reto</h3>
            <div class="flex justify-center space-x-4 mb-4">
              <button id="select-trivia-btn" class="btn-primary text-white px-4 py-2 rounded-lg">Trivia</button>
              <button id="select-photo-challenge-btn" class="btn-primary text-white px-4 py-2 rounded-lg">Foto</button>
            </div>
            <textarea id="challenge-caption" class="w-full border rounded-lg p-2 text-sm" placeholder="Agreg√° una descripci√≥n o pie de foto..."></textarea>
            <form id="trivia-form" class="hidden space-y-3 mt-4">
              <input id="trivia-question" type="text" class="w-full border rounded-lg p-2 text-sm" placeholder="Pregunta">
              <input id="trivia-answer" type="text" class="w-full border rounded-lg p-2 text-sm" placeholder="Respuesta correcta">
              <button id="publish-trivia-btn" type="button" class="w-full btn-primary text-white py-2 rounded-lg">Publicar Reto</button>
            </form>
            <form id="photo-challenge-form" class="hidden mt-4">
              <p class="text-sm text-slate-600 mb-2">Los usuarios deber√°n subir una foto para desbloquearlo.</p>
              <button id="publish-photo-btn" type="button" class="w-full btn-primary text-white py-2 rounded-lg">Publicar Reto</button>
            </form>
          </div>
        </div>
      </div>

      <!-- PERFIL -->
      <div id="profile-view" class="hidden p-4">
        <div class="max-w-md mx-auto bg-white rounded-xl shadow-lg p-4">
          <div class="flex items-center space-x-3 mb-4">
            <img id="profile-pic" class="w-14 h-14 rounded-full border">
            <div>
              <h2 id="profile-name" class="text-lg font-bold text-slate-800"></h2>
              <p id="profile-email" class="text-sm text-slate-500"></p>
            </div>
          </div>
          <p id="my-retos-count" class="text-sm text-slate-500 mb-2"></p>
          <div id="my-mosaic" class="grid-mosaic"></div>
        </div>
      </div>
    </main>

    <!-- NAV -->
    <nav class="fixed bottom-0 left-0 w-full bg-white border-t shadow-md z-40">
      <div class="flex justify-around">
        <button class="nav-button flex flex-col items-center p-2 text-slate-500 hover:text-indigo-500" data-view="feed-view">üè†<span class="text-[11px]">Inicio</span></button>
        <button class="nav-button flex flex-col items-center p-2 text-slate-500 hover:text-indigo-500" data-view="create-view">‚ûï<span class="text-[11px]">Crear</span></button>
        <button class="nav-button flex flex-col items-center p-2 text-slate-500 hover:text-indigo-500" data-view="profile-view">üë§<span class="text-[11px]">Perfil</span></button>
      </div>
    </nav>
  </div>

  <!-- FIREBASE -->
  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/11.0.1/firebase-app.js";
    import {
      getAuth, GoogleAuthProvider, signInWithPopup,
      onAuthStateChanged, signOut
    } from "https://www.gstatic.com/firebasejs/11.0.1/firebase-auth.js";
    import {
      getFirestore, collection, addDoc, onSnapshot,
      query, orderBy, where, limit, serverTimestamp,
      doc, deleteDoc, increment, updateDoc
    } from "https://www.gstatic.com/firebasejs/11.0.1/firebase-firestore.js";

    // === CONFIG FIREBASE ===
    const firebaseConfig = {
      apiKey: "TU_API_KEY",
      authDomain: "tereto-prod.firebaseapp.com",
      projectId: "tereto-prod",
    };
    const app = initializeApp(firebaseConfig);
    const auth = getAuth(app);
    const provider = new GoogleAuthProvider();
    const db = getFirestore(app);

    // === UTILS ===
    const $ = id => document.getElementById(id);
    const showToast = (msg, type="info")=>{
      const toast = $("toast");
      $("toast-message").textContent = msg;
      $("toast-icon").innerHTML = type==="error"?"‚ùå":"‚úÖ";
      toast.classList.add("show");
      setTimeout(()=> toast.classList.remove("show"),2500);
    };

    function calcExpiresAt(){
      const now = new Date();
      now.setHours(now.getHours()+24);
      return now;
    }

    async function fileToCompressedDataURL(file, maxW=960, quality=0.7){
      const bitmap = await createImageBitmap(file);
      const ratio = bitmap.width / bitmap.height;
      const targetW = Math.min(bitmap.width, maxW);
      const targetH = Math.round(targetW / ratio);
      const canvas = document.createElement("canvas");
      canvas.width = targetW; canvas.height = targetH;
      const ctx = canvas.getContext("2d");
      ctx.drawImage(bitmap,0,0,targetW,targetH);
      let dataUrl = canvas.toDataURL("image/jpeg", quality);
      const kb = Math.round((dataUrl.length * 3) / 4 / 1024);
      if(kb>300) dataUrl = canvas.toDataURL("image/jpeg",0.6);
      return dataUrl;
    }

    // === ESTADO ===
    let currentUser=null, feedUnsub=null, myChallengesUnsub=null, myChallenges=[];

    function switchView(id){
      document.querySelectorAll("main > div").forEach(v=>v.classList.add("hidden"));
      $(id).classList.remove("hidden");
    }

    // === LOGIN ===
    $("google-btn").onclick=async()=>{
      try{
        await signInWithPopup(auth,provider);
      }catch(e){showToast("Error al loguearse","error"); console.error(e);}
    };
    $("signout-btn").onclick=()=>signOut(auth);

    onAuthStateChanged(auth,(user)=>{
      if(user){
        currentUser=user;
        $("login-screen").classList.add("hidden");
        $("app-screen").classList.remove("hidden");
        startFeedSub();
        startMyChallengesSub();
        refreshProfile();
      }else{
        $("login-screen").classList.remove("hidden");
        $("app-screen").classList.add("hidden");
        clearSubs();
      }
    });

    // === SUBS ===
    function clearSubs(){ if(feedUnsub){feedUnsub();feedUnsub=null;} if(myChallengesUnsub){myChallengesUnsub();myChallengesUnsub=null;} }

    function startFeedSub(){
      const qRef=query(collection(db,"challenges"),orderBy("createdAt","desc"),limit(100));
      feedUnsub=onSnapshot(qRef,(snap)=>{
        const feed=snap.docs.map(d=>({id:d.id,...d.data()}));
        renderFeed(feed);
      });
    }

    function startMyChallengesSub(){
      if(!currentUser)return;
      const qRef=query(collection(db,"challenges"),where("authorId","==",currentUser.uid),orderBy("createdAt","desc"));
      myChallengesUnsub=onSnapshot(qRef,(snap)=>{
        myChallenges=snap.docs.map(d=>({id:d.id,...d.data()}));
        refreshProfile();
      });
    }

    // === FEED ===
    function renderFeed(feed){
      const cont=$("feed-container"); cont.innerHTML="";
      feed.forEach(ch=>{
        const card=document.createElement("div");
        card.className="bg-white rounded-xl shadow-md overflow-hidden";
        const img=document.createElement("img");
        img.src=ch.contentUrl||"https://placehold.co/600x400/333/FFF?text=Reto";
        img.className="w-full h-56 object-cover";
        card.appendChild(img);
        const body=document.createElement("div");
        body.className="p-3";
        body.innerHTML=`<p class="font-semibold">${ch.authorName}</p>
          <p class="text-sm text-slate-600">${ch.caption||""}</p>
          <div class="flex justify-between mt-2">
            <button class="like-button text-slate-500">‚ù§ ${ch.likesCount||0}</button>
            <button class="comment-button text-slate-500">üí¨ ${ch.commentsCount||0}</button>
          </div>`;
        card.appendChild(body);
        cont.appendChild(card);
      });
    }

    // === PERFIL ===
    function refreshProfile(){
      if(!currentUser)return;
      $("profile-pic").src=currentUser.photoURL;
      $("profile-name").textContent=currentUser.displayName;
      $("profile-email").textContent=currentUser.email;
      const grid=$("my-mosaic");
      grid.innerHTML="";
      myChallenges.forEach(ch=>{
        const wrap=document.createElement("div");
        wrap.className="mosaic-item";
        const img=document.createElement("img");
        img.src=ch.contentUrl||"https://placehold.co/600x600/333/FFF?text=Reto";
        img.className="mosaic-img";
        wrap.appendChild(img);
        const del=document.createElement("button");
        del.className="mosaic-del"; del.textContent="üóëÔ∏è";
        del.onclick=async()=>{
          if(confirm("¬øEliminar este reto?")){
            try{ await deleteDoc(doc(db,"challenges",ch.id)); showToast("Reto eliminado"); }
            catch(err){ showToast("No se pudo eliminar","error"); console.error(err); }
          }
        };
        wrap.appendChild(del);
        const bar=document.createElement("div");
        bar.style.position="absolute"; bar.style.bottom=".25rem"; bar.style.left=".25rem";
        bar.innerHTML=`<span class="badge" style="background:rgba(0,0,0,.6);color:#fff;">‚ù§ ${ch.likesCount||0}</span>
                       <span class="badge" style="background:rgba(0,0,0,.6);color:#fff;">üí¨ ${ch.commentsCount||0}</span>`;
        wrap.appendChild(bar);
        grid.appendChild(wrap);
      });
      $("my-retos-count").textContent=`${myChallenges.length} retos`;
    }

    // === CREAR RETO ===
    $("file-upload").addEventListener("change",async(e)=>{
      const file=e.target.files?.[0];
      if(!file)return;
      $("file-name").textContent=file.name;
      const dataUrl=await fileToCompressedDataURL(file);
      $("goto-step-2").dataset.fileUrl=dataUrl;
      $("image-preview").src=dataUrl;
      $("image-preview-container").classList.remove("hidden");
      $("goto-step-2").disabled=false;
    });

    $("goto-step-2").onclick=()=>{ $("create-step-1").classList.add("hidden"); $("create-step-2").classList.remove("hidden"); };
    $("select-trivia-btn").onclick=()=>{ $("trivia-form").classList.remove("hidden"); $("photo-challenge-form").classList.add("hidden"); };
    $("select-photo-challenge-btn").onclick=()=>{ $("photo-challenge-form").classList.remove("hidden"); $("trivia-form").classList.add("hidden"); };

    async function publishChallenge(details){
      if(!currentUser)return;
      let contentUrl=$("goto-step-2").dataset.fileUrl||"";
      if(contentUrl.length>900000)contentUrl="https://placehold.co/600x400/333/FFF?text=TeReto";
      try{
        await addDoc(collection(db,"challenges"),{
          authorId:currentUser.uid,
          authorName:currentUser.displayName,
          authorImg:currentUser.photoURL,
          createdAt:serverTimestamp(),
          expiresAt:calcExpiresAt(),
          contentUrl,
          caption:$("challenge-caption").value.trim(),
          likesCount:0,
          commentsCount:0,
          ...details
        });
        showToast("¬°Reto publicado!");
        switchView("feed-view");
      }catch(e){ console.error(e); showToast("No se pudo publicar reto","error"); }
    }

    $("publish-trivia-btn").onclick=()=>publishChallenge({type:"trivia",question:$("trivia-question").value,answer:$("trivia-answer").value});
    $("publish-photo-btn").onclick=()=>publishChallenge({type:"photo"});

    // === NAV ===
    document.addEventListener("click",(e)=>{
      const navBtn=e.target.closest(".nav-button");
      if(navBtn&&navBtn.dataset.view){
        e.preventDefault();
        switchView(navBtn.dataset.view);
      }
    });
  </script>
</body>
</html>
