<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>TeReto</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;500;600;700&display=swap" rel="stylesheet">
  <style>
    body { font-family: 'Poppins', sans-serif; }
    .toast { visibility:hidden; opacity:0; transform:translateY(100%); transition:all .5s cubic-bezier(.68,-.55,.27,1.55); pointer-events:none;}
    .toast.show { visibility:visible; opacity:1; transform:translateY(0); }
    .spinner { border:4px solid rgba(0,0,0,.1); width:36px; height:36px; border-radius:50%; border-left-color:#6366f1; animation:spin 1s ease infinite;}
    @keyframes spin { 0%{transform:rotate(0);} 100%{transform:rotate(360deg);} }
    .btn-primary { background-image:linear-gradient(to right,#6366f1,#8b5cf6); color:#fff; border-radius:.625rem; padding:.5rem .875rem; font-weight:700; }
    .btn-primary:hover { box-shadow:0 4px 15px rgba(99,102,241,.6); }
    .grid-mosaic { display:grid; grid-template-columns:repeat(3,1fr); gap:.5rem; }
    .mosaic-item { position:relative; aspect-ratio:1/1; }
    .mosaic-img { width:100%; height:100%; object-fit:cover; border-radius:.5rem; }
    .mosaic-del { position:absolute; top:.25rem; right:.25rem; background:rgba(0,0,0,.6); color:#fff; border-radius:.5rem; padding:.15rem .4rem; font-size:.8rem; }
    .badge { font-size:.7rem; padding:.1rem .35rem; border-radius:.35rem; }
    .locked { filter: blur(22px); }
    .tab-btn.active { border-bottom:2px solid #6366f1; color:#6366f1; font-weight:600; }
    #login-screen { position:relative; z-index:10; }
    #loading-spinner.hidden { display:none !important; }
  </style>
</head>
<body class="bg-slate-100 h-screen">

  <!-- SPINNER -->
  <div id="loading-spinner" class="hidden fixed inset-0 bg-slate-100/80 flex items-center justify-center z-[100]">
    <div class="spinner"></div>
  </div>

  <!-- TOAST -->
  <div id="toast" class="toast fixed bottom-24 left-1/2 -translate-x-1/2 flex items-center w-full max-w-xs p-4 text-slate-600 bg-white rounded-xl shadow-2xl z-[90]">
    <div id="toast-icon" class="inline-flex items-center justify-center flex-shrink-0 w-8 h-8 rounded-lg"></div>
    <div id="toast-message" class="ml-3 text-sm font-normal"></div>
  </div>

  <!-- LOGIN -->
  <div id="login-screen" class="min-h-screen flex items-center justify-center p-4">
    <div class="w-full max-w-sm bg-white rounded-2xl shadow-2xl p-6">
      <div class="flex items-center justify-center mb-4">
        <svg class="w-10 h-10" viewBox="0 0 32 32" fill="none"><defs><linearGradient id="lg1" x1="0" y1="0" x2="32" y2="32"><stop stop-color="#818CF8"/><stop offset="1" stop-color="#C084FC"/></linearGradient></defs><circle cx="16" cy="16" r="12" stroke="url(#lg1)" stroke-width="3"/><circle cx="16" cy="16" r="4" stroke="url(#lg1)" stroke-width="3"/></svg>
        <svg class="h-8 ml-2" viewBox="0 0 90 25" fill="none"><defs><linearGradient id="lg2" x1="0%" y1="0%" x2="100%" y2="0%"><stop offset="0%" stop-color="#6366f1"/><stop offset="100%" stop-color="#8b5cf6"/></linearGradient></defs><text x="0" y="20" font-size="24" font-weight="700" fill="url(#lg2)">TeReto</text></svg>
      </div>
      <p class="text-center text-slate-600 mb-6">Ingres√° para continuar</p>

      <!-- Inline onclick para garantizar gesto del usuario -->
      <button id="google-btn" type="button" onclick="_startGoogle()" class="relative z-10 pointer-events-auto w-full flex items-center justify-center gap-3 border rounded-xl py-3 hover:bg-slate-50 select-none">
        <img alt="Google" src="https://www.gstatic.com/firebasejs/ui/2.0.0/images/auth/google.svg" class="w-5 h-5" draggable="false">
        <span class="font-semibold text-slate-700">Continuar con Google</span>
      </button>

      <p class="text-[11px] text-center text-slate-400 mt-4">
        Serv√≠ esto en <code>http://localhost</code> o un dominio autorizado (Firebase ‚Ä∫ Authentication ‚Ä∫ Authorized domains).
      </p>
    </div>
  </div>

  <!-- APP -->
  <div id="app-screen" class="h-full flex flex-col hidden">
    <main class="flex-grow overflow-y-auto pb-20 bg-slate-100">

      <!-- FEED -->
      <div id="feed-view">
        <header class="sticky top-0 bg-white/80 backdrop-blur-sm p-4 border-b flex justify-between items-center z-40">
          <div class="flex items-center space-x-2">
            <svg class="w-8 h-8" viewBox="0 0 32 32" fill="none"><defs><linearGradient id="lg3" x1="0" y1="0" x2="32" y2="32"><stop stop-color="#818CF8"/><stop offset="1" stop-color="#C084FC"/></linearGradient></defs><circle cx="16" cy="16" r="12" stroke="url(#lg3)" stroke-width="3"/><circle cx="16" cy="16" r="4" stroke="url(#lg3)" stroke-width="3"/></svg>
            <svg class="h-7" viewBox="0 0 90 25" fill="none"><defs><linearGradient id="lg4" x1="0%" y1="0%" x2="100%" y2="0%"><stop offset="0%" stop-color="#6366f1"/><stop offset="100%" stop-color="#8b5cf6"/></linearGradient></defs><text x="0" y="20" font-size="24" font-weight="700" fill="url(#lg4)">TeReto</text></svg>
          </div>
          <button id="signout-btn" class="text-slate-500 hover:text-indigo-500 text-sm font-semibold">Cerrar sesi√≥n</button>
        </header>

        <div class="px-3 pt-3 pb-1">
          <div id="feed-tip" class="hidden text-[12px] text-slate-600">
            <span class="px-2 py-[2px] rounded-full border text-[10px]">Consejo</span> Toc√° la imagen bloqueada para aceptar el desaf√≠o. üòâ
          </div>
        </div>
        <div id="feed-container" class="p-2 space-y-4"></div>
      </div>

      <!-- CREATE -->
      <div id="create-view" class="hidden p-4">
        <div class="max-w-md mx-auto bg-white rounded-xl shadow-lg p-6">
          <h2 class="text-2xl font-bold mb-6 text-center text-slate-800">Crea un Nuevo Reto</h2>

          <div id="create-step-1" class="text-center">
            <h3 class="font-semibold text-lg mb-2 text-slate-700">Paso 1: Agreg√° el contenido</h3>
            <div id="image-preview-container" class="hidden my-4">
              <img id="image-preview" src="#" alt="Previsualizaci√≥n" class="rounded-lg max-h-60 object-cover mx-auto"/>
            </div>
            <div class="grid grid-cols-2 gap-4 my-4">
              <label for="file-upload" class="flex flex-col items-center justify-center p-4 border-2 border-dashed rounded-lg cursor-pointer hover:bg-slate-50 text-slate-500 hover:text-indigo-500">
                <svg class="w-10 h-10 mb-2" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 16v1a3 3 0 003 3h10a3 3 0 003-3v-1m-4-8l-4-4m0 0L8 8m4-4v12"></path></svg>
                <span class="text-sm font-semibold">Subir archivo</span>
                <input id="file-upload" type="file" class="sr-only" accept="image/*">
              </label>
              <button id="open-camera-btn" type="button" class="flex flex-col items-center justify-center p-4 border-2 border-dashed rounded-lg hover:bg-slate-50 text-slate-500 hover:text-indigo-500">
                <svg class="w-10 h-10 mb-2" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 9a2 2 0 012-2h.93a2 2 0 001.664-.89l.812-1.22A2 2 0 0110.07 4h3.86a2 2 0 011.664.89l.812 1.22A2 2 0 0018.07 7H19a2 2 0 012 2v9a2 2 0 01-2 2H5a2 2 0 01-2-2V9z"></path><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 13a3 3 0 11-6 0 3 3 0 016 0z"></path></svg>
                <span class="text-sm font-semibold">Usar c√°mara</span>
              </button>
            </div>
            <p id="file-name" class="mt-2 text-sm text-slate-500"></p>
            <button id="goto-step-2" class="mt-4 w-full btn-primary disabled:opacity-50 disabled:cursor-not-allowed" disabled>Siguiente</button>
          </div>

          <div id="create-step-2" class="hidden">
            <h3 class="font-semibold text-lg mb-3 text-slate-700">Paso 2: Configur√° el reto</h3>
            <div class="space-y-3">
              <label class="block text-sm font-medium text-slate-700">Descripci√≥n (opcional)</label>
              <textarea id="challenge-caption" rows="3" class="w-full px-3 py-2 border border-slate-300 rounded-md shadow-sm" placeholder="Escrib√≠ un pie de foto..."></textarea>

              <label class="block text-sm font-medium text-slate-700 mt-2">Vigencia</label>
              <select id="challenge-expiry" class="w-full border rounded-md px-3 py-2">
                <option value="none">Sin vencimiento</option>
                <option value="24">24 horas</option>
                <option value="48">48 horas</option>
              </select>
              <p class="text-xs text-slate-500">El feed oculta retos vencidos autom√°ticamente.</p>
            </div>

            <h3 class="font-semibold text-lg mt-5 mb-3 text-slate-700">Eleg√≠ el tipo</h3>
            <div class="space-y-4">
              <button id="select-trivia-btn" class="w-full text-left p-4 border rounded-lg hover:bg-slate-50 flex items-center">
                <span class="text-3xl mr-4">üß†</span>
                <div><p class="font-bold text-slate-800">Trivia</p><p class="text-sm text-slate-500">Pregunta de opci√≥n m√∫ltiple.</p></div>
              </button>
              <button id="select-photo-challenge-btn" class="w-full text-left p-4 border rounded-lg hover:bg-slate-50 flex items-center">
                <span class="text-3xl mr-4">üì∏</span>
                <div><p class="font-bold text-slate-800">Foto / Video</p><p class="text-sm text-slate-500">Ped√≠ que cumplan una consigna.</p></div>
              </button>
            </div>
          </div>

          <div id="create-step-3-trivia" class="hidden">
            <h3 class="font-semibold text-lg mb-4 text-slate-700">Paso 3: Configur√° la Trivia</h3>
            <form id="trivia-form" class="space-y-4">
              <div><label class="block text-sm font-medium text-slate-700">Pregunta</label><input id="trivia-question" class="mt-1 block w-full border rounded-md px-3 py-2" required></div>
              <div><label class="block text-sm font-medium text-green-700">Respuesta Correcta</label><input id="correct-answer" class="mt-1 block w-full border rounded-md px-3 py-2 border-green-400" required></div>
              <div>
                <label class="block text-sm font-medium text-red-700">Respuestas Incorrectas</label>
                <input id="wrong-answer-1" class="mt-1 block w-full border rounded-md px-3 py-2" required placeholder="Opci√≥n 1">
                <input id="wrong-answer-2" class="mt-2 block w-full border rounded-md px-3 py-2" required placeholder="Opci√≥n 2">
                <input id="wrong-answer-3" class="mt-2 block w-full border rounded-md px-3 py-2" required placeholder="Opci√≥n 3">
              </div>
              <button type="submit" class="w-full btn-primary">Publicar Reto</button>
            </form>
          </div>

          <div id="create-step-3-photo" class="hidden">
            <h3 class="font-semibold text-lg mb-4 text-slate-700">Paso 3: Describe el Desaf√≠o</h3>
            <form id="photo-challenge-form" class="space-y-4">
              <div>
                <label class="block text-sm font-medium text-slate-700">Consigna</label>
                <textarea id="photo-challenge-task" rows="4" class="mt-1 block w-full px-3 py-2 border border-slate-300 rounded-md shadow-sm" required></textarea>
              </div>
              <button type="submit" class="w-full btn-primary">Publicar Reto</button>
            </form>
          </div>
        </div>
      </div>

      <!-- FRIENDS -->
      <div id="friends-view" class="hidden">
        <header class="sticky top-0 bg-white/80 backdrop-blur-sm p-4 border-b z-40">
          <h1 class="text-3xl font-bold text-slate-800">Amigos</h1>
        </header>

        <div class="p-4">
          <div class="flex gap-4 border-b">
            <button class="tab-btn active py-2" data-tab="buscar">Buscar</button>
            <button class="tab-btn py-2 text-slate-500" data-tab="mis-amigos">Mis Amigos</button>
            <button class="tab-btn py-2 text-slate-500" data-tab="solicitudes">Solicitudes</button>
            <button class="tab-btn py-2 text-slate-500" data-tab="seguidores">Seguidores</button>
          </div>

          <div id="tab-buscar" class="mt-4">
            <div class="relative mb-4">
              <input type="search" id="user-search-input" placeholder="Buscar por nombre o email..." class="w-full pl-10 pr-4 py-2 border rounded-full focus:outline-none focus:ring-2 focus:ring-indigo-500">
              <div class="absolute top-0 left-0 inline-flex items-center p-2 h-full">
                <svg class="text-slate-400 w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z"/></svg>
              </div>
            </div>
            <div id="friends-results" class="space-y-2"></div>
          </div>

          <div id="tab-mis-amigos" class="hidden mt-4"><div id="friends-list" class="space-y-2"></div></div>
          <div id="tab-solicitudes" class="hidden mt-4"><div id="requests-list" class="space-y-2"></div></div>
          <div id="tab-seguidores" class="hidden mt-4"><div id="followers-list" class="space-y-2"></div></div>
        </div>
      </div>

      <!-- PROFILE -->
      <div id="profile-view" class="hidden">
        <div class="p-4 bg-white shadow-lg">
          <div class="flex flex-col items-center">
            <img id="profile-pic" class="w-24 h-24 rounded-full border-4 border-white -mt-16 shadow-lg">
            <h2 id="profile-name" class="text-2xl font-bold mt-4 text-slate-800"></h2>
            <p id="profile-email" class="text-slate-500"></p>
            <div class="w-full mt-6">
              <div class="flex items-center justify-between mb-2">
                <h3 class="text-lg font-semibold text-slate-700">Mis retos</h3>
                <span id="my-retos-count" class="text-xs text-slate-500"></span>
              </div>
              <div id="my-mosaic" class="grid-mosaic"></div>
            </div>
          </div>
        </div>
      </div>

    </main>

    <!-- NAV -->
    <nav class="fixed bottom-0 left-0 right-0 bg-white/95 backdrop-blur-sm border-t border-slate-200 flex justify-around p-1 z-40">
      <button data-view="feed-view" class="nav-button flex-1 p-2 rounded-lg text-indigo-500 flex flex-col items-center space-y-1">üè†<span class="text-xs font-semibold">Inicio</span></button>
      <button data-view="friends-view" class="nav-button flex-1 p-2 rounded-lg text-slate-500 flex flex-col items-center space-y-1">üë•<span class="text-xs font-semibold">Amigos</span></button>
      <button data-view="create-view" class="nav-button flex-1 p-2 rounded-lg text-slate-500 flex flex-col items-center space-y-1">‚ûï<span class="text-xs font-semibold">Crear</span></button>
      <button data-view="profile-view" class="nav-button flex-1 p-2 rounded-lg text-slate-500 flex flex-col items-center space-y-1">üë§<span class="text-xs font-semibold">Perfil</span></button>
    </nav>
  </div>

  <!-- COMMENTS MODAL -->
  <div id="comments-modal" class="hidden fixed inset-0 bg-black/50 z-50 flex items-center justify-center p-4">
    <div class="bg-white rounded-2xl shadow-2xl w-full max-w-lg flex flex-col max-h-[85vh]">
      <header class="flex items-center justify-between p-4 border-b">
        <h2 class="text-xl font-bold text-slate-800">Comentarios</h2>
        <button id="close-comments-modal" class="text-slate-500 hover:text-slate-800" aria-label="Cerrar comentarios">‚úñ</button>
      </header>
      <div id="comments-modal-body" class="flex-grow overflow-y-auto p-4 space-y-4 bg-slate-50"></div>
      <footer class="p-4 border-t bg-white">
        <form id="comment-form" class="flex items-center space-x-2">
          <img id="comment-user-img" class="w-8 h-8 rounded-full" alt="">
          <input id="comment-input" type="text" placeholder="A√±ade un comentario..." class="flex-grow bg-slate-100 border-slate-200 rounded-full py-2 px-4 focus:outline-none focus:ring-2 focus:ring-indigo-500">
          <button type="submit" class="btn-primary px-3 py-2" aria-label="Enviar comentario">‚û§</button>
        </form>
      </footer>
    </div>
  </div>

  <!-- TRIVIA MODAL -->
  <div id="trivia-modal" class="hidden fixed inset-0 bg-black/70 z-[100] p-4 flex items-center justify-center">
    <div class="bg-white rounded-2xl shadow-2xl max-w-lg w-full p-6">
      <div class="flex justify-between items-center mb-3">
        <h3 class="text-xl font-bold text-slate-800">Trivia</h3>
        <button id="trivia-close" class="text-slate-500 hover:text-slate-800">‚úñ</button>
      </div>
      <p id="trivia-q" class="font-semibold text-slate-800 mb-4"></p>
      <div id="trivia-opts" class="grid grid-cols-1 sm:grid-cols-2 gap-3"></div>
      <p id="trivia-feedback" class="h-6 mt-2 text-center text-sm"></p>
    </div>
  </div>

  <!-- CAMERA MODAL -->
  <div id="camera-modal" class="hidden fixed inset-0 bg-black/80 z-[100]">
    <video id="cam-video" class="w-full h-full object-contain" autoplay playsinline muted></video>
    <canvas id="cam-canvas" class="hidden"></canvas>
    <div class="absolute top-3 left-3">
      <button id="cam-close" class="bg-white/20 text-white px-3 py-1 rounded-lg">Cerrar</button>
    </div>
    <div class="absolute bottom-6 left-0 right-0 flex items-center justify-center">
      <button id="cam-capture" class="w-20 h-20 rounded-full bg-white border-4 border-slate-400 hover:border-white focus:outline-none"></button>
    </div>
  </div>

  <!-- TEMPLATE POST -->
  <template id="post-template">
    <div class="bg-white rounded-xl shadow-lg overflow-hidden post-card">
      <div class="p-4 flex items-center space-x-3">
        <img class="w-10 h-10 rounded-full author-img" src="">
        <div>
          <p class="font-semibold text-slate-800 author-name"></p>
          <p class="text-[11px] text-slate-500 post-time"></p>
        </div>
      </div>
      <div class="relative">
        <img class="w-full h-80 object-cover content-img" src="">
        <div class="lock-overlay absolute inset-0 hidden bg-black/40 text-white flex flex-col items-center justify-center">
          <div class="text-5xl mb-2">üîí</div>
          <p class="text-sm">Toc√° para aceptar el desaf√≠o</p>
        </div>
      </div>
      <div class="p-4">
        <p class="text-sm text-slate-700 caption mt-1"></p>
        <div class="flex items-center justify-between mt-2 text-slate-500">
          <div class="flex space-x-4">
            <button class="like-button flex items-center space-x-1 cursor-pointer"><span>‚ù§</span><span class="likes-count">0</span></button>
            <button class="comment-button flex items-center space-x-1 cursor-pointer"><span>üí¨</span><span class="comments-count">0</span></button>
          </div>
          <span class="text-[11px] post-time-secondary"></span>
        </div>
      </div>
    </div>
  </template>

  <!-- TEMPLATE COMMENT -->
  <template id="comment-item-template">
    <div class="flex items-start space-x-3">
      <img class="w-8 h-8 rounded-full cmt-img">
      <div class="flex-1 bg-slate-100 rounded-xl p-3">
        <p class="text-sm"><strong class="cmt-name text-slate-800"></strong> <span class="cmt-text text-slate-600"></span></p>
        <p class="text-xs text-slate-400 mt-1 cmt-time"></p>
      </div>
    </div>
  </template>

  <!-- APP SCRIPT -->
  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/11.0.1/firebase-app.js";
    import {
      getAuth, GoogleAuthProvider, signInWithPopup, signInWithRedirect, getRedirectResult,
      onAuthStateChanged, signOut
    } from "https://www.gstatic.com/firebasejs/11.0.1/firebase-auth.js";
    import {
      getFirestore, collection, addDoc, setDoc, doc, updateDoc,
      serverTimestamp, query, orderBy, onSnapshot, getDocs, limit, where,
      startAt, endAt, deleteDoc, writeBatch, increment, getDoc
    } from "https://www.gstatic.com/firebasejs/11.0.1/firebase-firestore.js";

    // --- Firebase ---
    const firebaseConfig = {
      apiKey: "AIzaSyCSdjAdY7ymmOwIN7zApP-XpXxTar_0pHk",
      authDomain: "tereto-prod.firebaseapp.com",
      projectId: "tereto-prod",
      storageBucket: "tereto-prod.firebasestorage.app",
      messagingSenderId: "914605096619",
      appId: "1:914605096619:web:88a9b78eac50c35cb181ee"
    };
    const app = initializeApp(firebaseConfig);
    const auth = getAuth(app);
    const db   = getFirestore(app);

    // Proveedor Google
    const provider = new GoogleAuthProvider();
    provider.setCustomParameters({ prompt: "select_account" });

    // --- Login: popup directo + fallback redirect ---
    window._startGoogle = function () {
      signInWithPopup(auth, provider).catch((e) => {
        if (e?.code === "auth/popup-blocked" || e?.code === "auth/cancelled-popup-request") {
          signInWithRedirect(auth, provider);
          return;
        }
        console.error("[auth]", e);
        (window.toast || console.log)((e?.code || "auth_error").toString().replace("auth/",""), "error");
      });
    };

    // Resolver sesi√≥n si venimos de redirect (no bloquea UI)
    getRedirectResult(auth).catch((e) => {
      console.warn("[redirect]", e?.code || e?.message);
    });

    // --- Utils ---
    const $ = (id)=>document.getElementById(id);
    const toast = (msg,type='success')=>{
      $("toast-message").textContent=msg;
      $("toast-icon").innerHTML= type==='success'?'‚úÖ':'‚ùå';
      const t=$("toast"); t.classList.add('show'); setTimeout(()=>t.classList.remove('show'),2600);
    };
    window.toast = toast; // Exponer para usar desde Auth

    const isExpired = (ch)=>{ if(!ch.expiresAt) return false; const d=ch.expiresAt?.toDate?.()||new Date(ch.expiresAt); return d && d<new Date(); };
    const solvedKey = (uid)=>`tereto_solved_${uid}`;
    const loadSolved = (uid)=>{ try{ return new Set(JSON.parse(localStorage.getItem(solvedKey(uid))||'[]')); }catch{return new Set();} };
    const saveSolved = (uid,set)=>{ try{ localStorage.setItem(solvedKey(uid), JSON.stringify([...set])); }catch{} };

    let currentUser=null, solvedSet=new Set();
    let friendsSet=new Set(), followingSet=new Set(), followersSet=new Set(), incomingReqSet=new Set(), sentReqSet=new Set();
    let unsubFriends=null, unsubFollowing=null, unsubFollowers=null, unsubIncomingReq=null, unsubSentReq=null;
    let feedUnsub=null, myChallengesUnsub=null, commentsUnsub=null;

    const clearSubs = ()=>{ [unsubFriends,unsubFollowing,unsubFollowers,unsubIncomingReq,unsubSentReq,feedUnsub,myChallengesUnsub,commentsUnsub].forEach(u=>{ if(u){u();} }); unsubFriends=unsubFollowing=unsubFollowers=unsubIncomingReq=unsubSentReq=feedUnsub=myChallengesUnsub=commentsUnsub=null; };

    // C√°mara
    let camStream=null, camResolve=null;
    const camModal=$("camera-modal"), camVideo=$("cam-video"), camCanvas=$("cam-canvas");
    async function openCamera(){ try{ if(camStream) camStream.getTracks().forEach(t=>t.stop()); camStream=await navigator.mediaDevices.getUserMedia({video:{facingMode:'user'},audio:false}); camVideo.srcObject=camStream; camModal.classList.remove('hidden'); }catch(e){ console.error(e); toast('No se pudo acceder a la c√°mara','error'); } }
    function closeCamera(){ if(camStream){ camStream.getTracks().forEach(t=>t.stop()); camStream=null;} camModal.classList.add('hidden'); }
    function capturePhoto(){ if(!camStream||!camVideo.videoWidth) return null; const w=camVideo.videoWidth,h=camVideo.videoHeight; camCanvas.width=w; camCanvas.height=h; camCanvas.getContext('2d').drawImage(camVideo,0,0,w,h); return camCanvas.toDataURL('image/jpeg',0.8); }
    $("cam-close")?.addEventListener('click', ()=>{ closeCamera(); if(camResolve) camResolve(null); camResolve=null; });
    $("cam-capture")?.addEventListener('click', ()=>{ const dataUrl=capturePhoto(); closeCamera(); if(camResolve) camResolve(dataUrl); camResolve=null; });
    const captureWithModal = ()=> new Promise(async (res)=>{ camResolve=res; await openCamera(); });

    async function fileToCompressedDataURL(file,maxW=960,quality=0.7){
      if(!file||!file.type?.startsWith('image/')) return 'https://placehold.co/600x400/333/FFF?text=TeReto';
      const bmp=await createImageBitmap(file); const r=bmp.width/bmp.height; const w=Math.min(bmp.width,maxW); const h=Math.round(w/r);
      const cvs=document.createElement('canvas'); cvs.width=w; cvs.height=h; cvs.getContext('2d').drawImage(bmp,0,0,w,h);
      let data=cvs.toDataURL('image/jpeg',quality); const kb=Math.round((data.length*3)/4/1024); if(kb>300) data=cvs.toDataURL('image/jpeg',0.6); return data;
    }

    // Logout
    $("signout-btn")?.addEventListener("click", ()=>signOut(auth).catch(()=>toast('No se pudo cerrar sesi√≥n','error')));

    async function upsertUser(user){
      const dn=user.displayName||null, em=user.email||null;
      try{
        await setDoc(doc(db,"users",user.uid),{
          displayName:dn, displayNameLower:dn?.toLowerCase()||null,
          email:em, emailLower:em?.toLowerCase()||null,
          photoURL:user.photoURL||null, updatedAt:serverTimestamp()
        },{merge:true});
      }catch(e){ console.error('upsert users',e); }
    }

    function subFriends(){
      if(unsubFriends){unsubFriends();unsubFriends=null;}
      unsubFriends = onSnapshot(collection(db,'users',currentUser.uid,'friends'), (snap)=>{
        friendsSet=new Set(snap.docs.map(d=>d.id));
        restartFeed(); renderFriendsTab();
      });
    }
    function subFollowing(){
      if(unsubFollowing){unsubFollowing();unsubFollowing=null;}
      unsubFollowing = onSnapshot(collection(db,'users',currentUser.uid,'following'), (snap)=>{ followingSet=new Set(snap.docs.map(d=>d.id)); renderFriendsTab(); });
    }
    function subFollowers(){
      if(unsubFollowers){unsubFollowers();unsubFollowers=null;}
      unsubFollowers = onSnapshot(collection(db,'users',currentUser.uid,'followers'), (snap)=>{ followersSet=new Set(snap.docs.map(d=>d.id)); renderFriendsTab(); });
    }
    function subIncomingRequests(){
      if(unsubIncomingReq){unsubIncomingReq();unsubIncomingReq=null;}
      unsubIncomingReq = onSnapshot(collection(db,'users',currentUser.uid,'friendRequests'), (snap)=>{ incomingReqSet=new Set(snap.docs.map(d=>d.id)); renderFriendRequests(); });
    }
    function subSentRequests(){
      if(unsubSentReq){unsubSentReq();unsubSentReq=null;}
      unsubSentReq = onSnapshot(collection(db,'users',currentUser.uid,'sentRequests'), (snap)=>{ sentReqSet=new Set(snap.docs.map(d=>d.id)); renderFriendsSearch(); });
    }

    function restartFeed(){
      if(feedUnsub){ feedUnsub(); feedUnsub=null; }
      if(!currentUser) return;
      const ids=[...friendsSet];
      const feedContainer=$("feed-container");
      if(ids.length===0){
        feedContainer.innerHTML='<div class="mx-3 my-6 p-4 bg-white rounded-xl shadow text-slate-600"><p class="font-semibold text-slate-800 mb-1">Tu feed est√° vac√≠o</p><p class="text-sm">Agreg√° amigos en <span class="font-semibold">Amigos</span>.</p></div>';
        return;
      }
      const qRef = ids.length<=10
        ? query(collection(db,'challenges'), where('authorId','in',ids), orderBy('createdAt','desc'), limit(120))
        : query(collection(db,'challenges'), orderBy('createdAt','desc'), limit(200));
      feedUnsub = onSnapshot(qRef,(snap)=>{
        const setIds=new Set(ids);
        const items=snap.docs.map(d=>({id:d.id,...d.data()}))
          .filter(c=> setIds.has(c.authorId))
          .filter(c=> !isExpired(c))
          .filter(c=> c.authorId!==currentUser.uid);
        renderFeed(items);
     
