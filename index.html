<!DOCTYPE html><html><head><meta charset="utf-8"><title>TeReto</title></head><body>
<div id="create-step-2">
  <label class="block text-sm font-medium text-slate-700 mt-2">Vigencia</label>
  <select id="challenge-expiry"></select>
  <p class="text-xs text-slate-500">El feed oculta retos vencidos automáticamente.</p>
              <label class="block text-sm font-medium text-slate-700 mt-2">Visibilidad</label>
              <select id="challenge-vis" class="w-full border rounded-md px-3 py-2">
                <option value="public">Pública</option>
                <option value="friends">Solo amigos</option>
              </select>
              <p class="text-xs text-slate-500">Si elegís “Solo amigos”, solo tus amigos podrán ver el reto en el feed.</p>

</div>
<script type="module">
  import { initializeApp } from "https://www.gstatic.com/firebasejs/11.0.1/firebase-app.js";
  import { getAuth, GoogleAuthProvider, signInWithPopup, signInWithRedirect, getRedirectResult, onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/11.0.1/firebase-auth.js";
  import { getFirestore, collection, addDoc, setDoc, doc, updateDoc, serverTimestamp, query, orderBy, onSnapshot, getDocs, limit, where, startAt, endAt, deleteDoc, writeBatch, increment, getDoc } from "https://www.gstatic.com/firebasejs/11.0.1/firebase-firestore.js";
  const firebaseConfig = {}; const app = initializeApp(firebaseConfig);
  const auth = getAuth(app); const db = getFirestore(app);
  function isExpired() { return false; }
  function renderFeed(items){}
  function $ (id){ return document.getElementById(id); }
  let friendsSet = new Set(); let currentUser = null;
  let feedUnsub = null;
  async function publishChallenge(payload){
    await addDoc(collection(db,'challenges'),{
      authorId: currentUser?.uid || "x",
      createdAt: serverTimestamp(),
                likesCount: 0, commentsCount: 0,
          vis: ($("challenge-vis")?.value || \'public\'),
      ...payload
    });
  }
  
function restartFeed(){
  if(feedUnsub){ feedUnsub(); feedUnsub=null; }
  if(!currentUser) return;

  const ids=[...friendsSet];
  const feedContainer=$("feed-container");

  if(ids.length===0){
    const qRef = query(
      collection(db,'challenges'),
      where('vis','==','public'),
      orderBy('createdAt','desc'),
      limit(120)
    );
    feedUnsub = onSnapshot(qRef,(snap)=>{
      const items = snap.docs
        .map(d=>({id:d.id,...d.data()}))
        .filter(c=> !isExpired(c))
        .filter(c=> c.authorId!==currentUser.uid);
      renderFeed(items);
    });
    return;
  }

  if (ids.length <= 10) {
    const qRef = query(
      collection(db,'challenges'),
      where('authorId','in', ids),
      orderBy('createdAt','desc'),
      limit(200)
    );
    feedUnsub = onSnapshot(qRef,(snap)=>{
      const items=snap.docs.map(d=>({id:d.id,...d.data()}))
        .filter(c=> !isExpired(c))
        .filter(c=> c.authorId!==currentUser.uid);
      renderFeed(items);
    });
  } else {
    const setIds=new Set(ids);
    const qRef = query(
      collection(db,'challenges'),
      orderBy('createdAt','desc'),
      limit(400)
    );
    feedUnsub = onSnapshot(qRef,(snap)=>{
      const items=snap.docs.map(d=>({id:d.id,...d.data()}))
        .filter(c=> setIds.has(c.authorId))
        .filter(c=> !isExpired(c))
        .filter(c=> c.authorId!==currentUser.uid);
      renderFeed(items);
    });
  }
}

</script>
</body></html>
