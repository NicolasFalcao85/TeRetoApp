<!DOCTYPE html>
<html>
  <head><meta charset="utf-8"/><title>Auth Test</title></head>
  <body>
    <button id="btn">Login con Google</button>
    <pre id="out"></pre>

    <script type="module">
      import { initializeApp } from "https://www.gstatic.com/firebasejs/11.0.1/firebase-app.js";
      import { getAuth, GoogleAuthProvider, signInWithPopup, onAuthStateChanged, setPersistence, browserLocalPersistence } 
        from "https://www.gstatic.com/firebasejs/11.0.1/firebase-auth.js";

      const firebaseConfig = {
        apiKey: "AIzaSyCSdjAdY7ymmOwIN7zApP-XpXxTar_0pHk",
        authDomain: "tereto-prod.firebaseapp.com",
        projectId: "tereto-prod",
        storageBucket: "tereto-prod.firebasestorage.app",
        messagingSenderId: "914605096619",
        appId: "1:914605096619:web:88a9b78eac50c35cb181ee"
      };

      const app = initializeApp(firebaseConfig);
      const auth = getAuth(app);
      await setPersistence(auth, browserLocalPersistence).catch(()=>{});
      const provider = new GoogleAuthProvider();
      provider.setCustomParameters({ prompt: "select_account" });

      const $ = (id)=>document.getElementById(id);
      const log = (m)=>$.out.textContent += m + "\n";

      onAuthStateChanged(auth, (u)=>{
        log(u ? `OK: ${u.email}` : "Sin sesiÃ³n");
      });

      document.getElementById('btn').addEventListener('click', async ()=>{
        try {
          await signInWithPopup(auth, provider);
        } catch(e) {
          // fallback si el popup es bloqueado
          if (e?.code === "auth/popup-blocked" || e?.code === "auth/cancelled-popup-request") {
            location.href = location.href; // asegura mismo origen antes del redirect
            const { signInWithRedirect } = await import("https://www.gstatic.com/firebasejs/11.0.1/firebase-auth.js");
            await signInWithRedirect(auth, provider);
          } else {
            log(`Error: ${e?.code||e?.message}`);
            console.error(e);
          }
        }
      });
    </script>
  </body>
</html>
